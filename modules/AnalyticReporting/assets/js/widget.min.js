/*! AnalyticReporting 26-06-2017 */
function capitalize(a){return a&&a[0].toUpperCase()+a.slice(1)}function unique(a){var b=[];return jQuery.each(a,function(a,c){jQuery.inArray(c,b)==-1&&b.push(c)}),b}function getChartObject(a){var b;switch(a){case"gauge":b=ReportGaugeChart;break;case"funnel":b=ReportFunnelChart;break;case"bar":b=ReportBarChart;break;case"line":b=ReportLineChart;break;case"combined":b=ReportCombinedChart;break;case"pie":default:b=ReportPieChart}return b}function getChartComponent(a,b,c){var d;switch(a){case"gauge":d=GaugeChartComponent;break;case"funnel":d=FunnelChartComponent;break;case"bar":d=b!=c?MultiBarChartComponent:BarChartComponent;break;case"line":d=LineChartComponent;break;case"combined":d=CombinedChartComponent;break;case"pie":default:d=PieChartComponent}return d}function loadChart(a,b,c,d){jQuery.post(ReportData.url+ReportData.id+"&chart=1",b,function(e){if(ReportData.chartSize){if(ReportData.chartHeight||ReportData.chartHeight>0)var f=ReportData.chartHeight+"px";else var f=200+400*ReportData.chartSize/100+"px";var g=ReportData.chartSize+"%";jQuery("#chart1").css({width:g,height:f})}ReportData.chartData=JSON.parse(e),initChartView(a,b,!0,c,d)})}function initChartView(a,b,c,d,e){return e=e||ReportData.fieldGroupingSorting,d=d||ReportData.selectedAggregates,c=c||!1,chartView=new ChartView({el:"#chart1",data:{svg:"#chart1 svg",data:ReportData.chartData,title:ReportData.chartTitle,showPercents:ReportData.chartShowPercents,showLabels:ReportData.chartShowLabels,showZoneLabels:ReportData.chartShowZoneLabels,valueZones:ReportData.chartValueZones,xAxisSegment:ReportData.chartAxisXSegment,legend:ReportData.chartLegend,xAxis:ReportData.chartAxisX,yAxis:ReportData.chartAxisY,yAxis2:ReportData.chartAxisY2,yAxisType:ReportData.chartYAxisType,yAxis2Type:ReportData.chartYAxis2Type,aggregates:d,groups:e,bars1Stacked:ReportData.chartBars1Stacked,bars2Stacked:ReportData.chartBars2Stacked,showLinks:c,isWidget:ReportData.isWidget,cumulated:ReportData.chartCumulated,sortableValues:ReportData.chartSortableValues},components:{chartComponent:getChartComponent(a,ReportData.chartLegend,ReportData.chartAxisX)}}),chartView}var App={Views:{},Models:{},Collections:{},init:function(){},template:function(a){return _.template(this._template(a))},_template:function(a){return jQuery("#"+a).html()}};Ractive.decorators.select2.type.filter={width:"resolve",dropdownAutoWidth:!0};var multiSelectDecorator=function(a,b){var c,d,e=a._ractive.root,f=!1,g={header:!1,selectedList:1,click:function(){window.setTimeout(function(){jQuery(a).multiselect("refresh")},0)}};if(jQuery(a).multiselect(g),e.observe("disableSelectBox",function(b){b?jQuery(a).multiselect("disable"):jQuery(a).multiselect("enable")},{init:!1}),a._ractive.binding){var h=function(){f||(f=!0,window.setTimeout(function(){jQuery(a).change(),jQuery(a).multiselect("refresh"),f=!1},0))};c=e.observe(a._ractive.binding.keypath,h),d=e.observe("optionGroups",h)}return jQuery(a).multiselect(g).on("change",function(){f||(f=!0,e.updateModel(),f=!1)}),{teardown:function(){jQuery(a).multiselect("destroy"),c&&(c.cancel(),d.cancel())}}},selectBoxCache={},selectBox=Ractive.extend({template:function(a){return"undefined"==typeof selectBoxCache[a.valueName+"|"+a.titleName]&&(selectBoxCache[a.valueName+"|"+a.titleName]=Ractive.parse('<select value="{{selected}}">{{#options}}<option value="{{'+a.valueName+'}}">{{'+a.titleName+"}}</option>{{/options}}</select>")),selectBoxCache[a.valueName+"|"+a.titleName]},complete:function(){if(this.data.autoSelectFirst){var a=this,b=function(b){for(var c=!1,d=0;d<b.length;d++)if(b[d][a.data.valueName]==a.data.selected){c=!0;break}!c&&b.length>0&&a.set("selected",a.data.options[0][a.data.valueName])};b(this.data.options),this.observe("options",b,{init:!1})}},data:{selected:null,options:[],titleName:"",valueName:"",autoSelectFirst:!0},modifyArrays:!1}),selectBoxImg=Ractive.extend({template:App._template("selectBoxImgTemplate"),complete:function(){var a=!1;this.data.autoSelect&&""===this.data.selected&&this.set("selected",this.data.options[0][this.data.valueName]);var b=this.find("select"),c=this;jQuery(b).ddslick({width:250,background:"transparent",imagePosition:"left",onSelected:function(b){if(a){for(var d=0,e=ReportData.selectedAggregates.length-1;e>=0;e--)ReportData.selectedAggregates[e].value.sum&&d++,ReportData.selectedAggregates[e].value.count&&d++,ReportData.selectedAggregates[e].value.avg&&d++;"Combined"!=b.selectedData.text||ReportData.fieldGroupingSorting.length>0&&d>1?(c.get("selected")!=b.selectedData.value&&jQuery("#ar-rv-chart-editor-tabs").tabs("option","active",1),c.set("selected",b.selectedData.value)):alert(translated_labels.label_chart_error)}}}),setTimeout(function(){for(var b=0,c=ReportData.selectedAggregates.length-1;c>=0;c--)ReportData.selectedAggregates[c].value.sum&&b++,ReportData.selectedAggregates[c].value.count&&b++,ReportData.selectedAggregates[c].value.avg&&b++;0==ReportData.fieldGroupingSorting.length||b<2?(jQuery(".dd-options").children()[3].style.backgroundColor="lightgrey;",jQuery(".dd-options").children()[3].children[0].backgroundColor="lightgrey;"):(jQuery(".dd-options").children()[3].backgroundColor="white;",jQuery(".dd-options").children()[3].children[0].backgroundColor="white;"),a=!0},3e3)},data:{options:[],selected:"",autoSelect:!0,id:""}}),multiSelectBox=Ractive.extend({template:App._template("multiSelectBoxTemplate"),init:function(){},complete:function(){var a=this,b=function(){var b=a.get("selected"),c=a.getDisabledValues(b),d=a.get("options"),e=a.convertData(d,"key","values","name","title",c,b),f=!1;JSON.stringify(e.options)!==JSON.stringify(a.get("optionGroups"))&&(f=!0),a.set("optionGroups",e.options).then(function(){return JSON.stringify(e.selected)===JSON.stringify(a.get("selected"))||(f=!0,a.set("selected",e.selected))}).then(function(){f&&setTimeout(function(){a.fire("selectChanged")},10)})};this.observe("options",b,{init:!1}),this.observe("selected",function(a){this.data.selected=a,b()},{init:!1}),b()},getDisabledValues:function(a){for(var b=this.get("aggregates"),c=this.get("groups"),d=[],e=!1,f=!1,g=0;g<a.length;g++){if(c.length>0)for(var h=0;h<c.length;h++)if(a[g]==c[h].name){e=!0;break}if(ReportData.options.isCombined&&"date_field"==a[g]){e=!0;break}if(b.length>0)for(var h=0;h<b.length;h++){if(b[h].value.sum&&a[g]==b[h].selectedField+"_sum"){f=!0;break}if(b[h].value.avg&&a[g]==b[h].selectedField+"_avg"){f=!0;break}if(b[h].value.count&&a[g]==b[h].selectedField+"_cnt"){f=!0;break}}}if(e){for(var g=0;g<b.length;g++)b[g].value.sum&&d.push(b[g].selectedField+"_sum"),b[g].value.avg&&d.push(b[g].selectedField+"_avg"),b[g].value.count&&d.push(b[g].selectedField+"_cnt");for(var g=0;g<a.length;g++){for(var h=0;h<c.length;h++)a[g]!=c[h].name&&d.push(c[h].name);ReportData.options.isCombined&&"date_field"!=a[g]&&d.push("date_field")}}if(f){for(var g=0;g<c.length;g++)d.push(c[g].name);ReportData.options.isCombined&&d.push("date_field")}return d},convertData:function(a,b,c,d,e,f,g){for(var h=[],i=[],j=0;j<a.length;j++){for(var k=[],l=0;l<a[j][c].length;l++){var m=!1;jQuery.inArray(a[j][c][l][d],f)!==-1&&(m=!0);var n=!1;m||jQuery.inArray(a[j][c][l][d],g)===-1||(n=!0,i.push(a[j][c][l][d])),k.push({value:a[j][c][l][d],title:a[j][c][l][e],disabled:m})}h.push({title:a[j][b],items:k})}return h={options:h,selected:i}},decorators:{multiSelect:multiSelectDecorator},data:{options:[],selected:"",optionGroups:[],disabledValues:[],disabledSelectBox:!1,groups:[],aggregates:[]}}),reportUtils={appendDateGrouping:function(a,b){return"undefined"==typeof a.cols[b]&&("undefined"!=typeof a.cols[b+"_year"]?b+="_year":"undefined"!=typeof a.cols[b+"_quarter"]?b+="_quarter":"undefined"!=typeof a.cols[b+"_quarterAndYear"]?b+="_quarterAndYear":"undefined"!=typeof a.cols[b+"_month"]?b+="_month":"undefined"!=typeof a.cols[b+"_monthAndYear"]?b+="_monthAndYear":"undefined"!=typeof a.cols[b+"_week"]?b+="_week":"undefined"!=typeof a.cols[b+"_weekAndYear"]?b+="_weekAndYear":"undefined"!=typeof a.cols[b+"_day"]&&(b+="_day")),b},generateFieldsByNameFromBlocks:function(a){for(var b={},c=0;c<a.length;c++)for(var d=0;d<a[c].fields.length;d++)b[a[c].fields[d].name]=a[c].fields[d];return b},isMultiSummaryReport:function(a,b,c,d){d=d||!1;for(var e=[],f=0;f<b.length;f++){var g=b[f],h=g.showAggregates;if("column"!=g.position||!d)for(var i=0;i<a.length;i++){var j=h[a[i].selectedField];if(j){var k=!1;j.sum&&(k=!0),j.count&&(k=!0),j.avg&&(k=!0),k&&e.push(!0)}}}return c||e.pop(),e.length>0},convertToJSONPost:function(a,b){var c={};b=b||[];for(var d=Object.keys(a),e=0;e<d.length;e++)b.indexOf(d[e])==-1?c[d[e]]=JSON.stringify(a[d[e]]):c[d[e]]=a[d[e]];return c}},NumberFormatter=function(a){var b=jQuery.extend({},{format:"",seperator:"'",decimal:".",numdec:significantDigits},a);this.format=b.format,this.decimal=b.decimal,this.seperator=b.seperator,this.numdec=b.numdec,this.countAggregateByLabel=this.getCountAggregateByLabel(),this.integerFields=this.getIntegerFields(),this.integerAggregates=this.getIntegerAggregates()};NumberFormatter.prototype.format="",NumberFormatter.prototype.decimal=".",NumberFormatter.prototype.seperator="'",NumberFormatter.prototype.makeFormatter=function(){var a=this;switch(this.format){case"123,456,789":return function(b,c,d,e,f){if(null==d)return"";if(!a.isNumber(d))return d;if(d.length&&!d[0].match("[0-9]"))return d;d=a.roundByType(d,e,f);var g=d.split("."),h="";return g.length>1&&(h=a.decimal+g[1]),g[0].length>3&&(g[0]=a.by3(g[0])),g[0]+h};case"12,34,56,789":return function(b,c,d,e,f){if(null==d)return"";if(!a.isNumber(d))return d;if(d.length&&!d[0].match("[0-9]"))return d;d=a.roundByType(d,e,f);var g=d.split("."),h="";return g.length>1&&(h=a.decimal+g[1]),g[0].length>3&&(g[0]=a.by3then2(g[0])),g[0]+h};case"123456,789":return function(b,c,d,e,f){if(null==d)return"";if(!a.isNumber(d))return d;if(d.length&&!d[0].match("[0-9]"))return d;d=a.roundByType(d,e,f);var g=d.split("."),h="";return g.length>1&&(h=a.decimal+g[1]),g[0].length>3&&(g[0]=a.first3(g[0])),g[0]+h};case"123456789":default:return function(b,c,d,e,f){if(null==d)return"";if(!a.isNumber(d))return d;if(d.length&&!d[0].match("[0-9]"))return d;d=a.roundByType(d,e,f);var g=d.split("."),h="";return g.length>1&&(h=a.decimal+g[1]),g[0].length>3&&(g[0]=a.noFormat(g[0])),g[0]+h}}},NumberFormatter.prototype.noFormat=function(a){return a},NumberFormatter.prototype.by3=function(a){for(var b=a.split("").reverse(),c=[],d=1;d<b.length;d++)c.push(b[d-1]),d%3==0&&c.push(this.seperator);return c.push(b[b.length-1]),c.reverse().join("")},NumberFormatter.prototype.by3then2=function(a){for(var b=a.split("").reverse(),c=[],d=1;d<b.length&&d<4;d++)c.push(b[d-1]),d%3==0&&c.push(this.seperator);for(var d=4;d<b.length;d++)c.push(b[d-1]),d-4&&(d-1)%2==0&&c.push(this.seperator);return c.push(b[b.length-1]),c.reverse().join("")},NumberFormatter.prototype.first3=function(a){var b=a.split(""),c=b.splice(-3,3);return b.length>0&&(c=b.join("")+this.seperator+c.join("")),c},NumberFormatter.prototype.isNumber=function(a){return!isNaN(parseFloat(a))&&isFinite(a)},NumberFormatter.prototype.isCountAggregate=function(a,b){var c=a.substr(a.lastIndexOf("_")+1),d=["sum","min","max","avg"];if("cnt"==c||"ctn"==b)return!0;if(d.indexOf(c)>-1)return!1;if("undefined"!=typeof b&&ReportData.options.aggregateColumn)return!!b.aggregates&&this.countAggregateByLabel.indexOf(b.aggregates)>-1;for(var e=0;e<ReportData.selectedAggregates.length;e++)if(a.indexOf(ReportData.selectedAggregates[e].selectedField)>-1)return ReportData.selectedAggregates[e].value.count;return!1},NumberFormatter.prototype.getIntegerFields=function(){for(var a=[],b=0;b<ReportData.availableFields.length;b++)for(var c=0;c<ReportData.availableFields[b].fields.length;c++)"integer"==ReportData.availableFields[b].fields[c].type&&a.push(ReportData.availableFields[b].fields[c].name);return a},NumberFormatter.prototype.getIntegerAggregates=function(){for(var a=[],b=0;b<ReportData.selectedAggregates.length;b++){var c=ReportData.selectedAggregates[b];this.integerFields.indexOf(c.selectedField)>-1&&(c.value.sum&&a.push(ReportData.labels[c.selectedField+"_sum"]),c.value.max&&a.push(ReportData.labels[c.selectedField+"_max"]),c.value.min&&a.push(ReportData.labels[c.selectedField+"_min"]))}return a},NumberFormatter.prototype.getCountAggregateByLabel=function(){var a=[];for(var b in ReportData.labels)ReportData.labels.hasOwnProperty(b)&&"_cnt"==b.substr(b.length-4)&&a.push(ReportData.labels[b]);return a},NumberFormatter.prototype.isIntegerType=function(a,b){if("undefined"!=typeof b&&ReportData.options.aggregateColumn)return this.integerAggregates.indexOf(b.aggregates)>-1;for(var c=0;c<this.integerFields.length;c++)if(a.indexOf("_avg")<0&&a.indexOf(this.integerFields[c])>-1)return!0},NumberFormatter.prototype.roundByType=function(a,b,c){return"undefined"!=typeof b&&(this.isCountAggregate(b.field,c)||this.isIntegerType(b.field,c))&&"avg"!=c?(Math.round(100*parseFloat(a))/100).toFixed(0):Number(Math.round(a+"e+"+this.numdec)+"e-"+this.numdec).toFixed(this.numdec)};var validateXAxis=function(a){for(var b=this.get("availableGroups"),c=!1,d=0;d<b.length;d++)if(a==b[d].name){c=!0;break}var e=a;c||b.length>0&&(e=b[0].name,that.set("xAxis",e)),ReportData.chartAxisX=e},ChartView=Ractive.extend({template:'<chartComponent data="{{data}}" title="{{title}}" isWidget="{{isWidget}}" xAxis="{{xAxis}}" yAxis="{{yAxis}}" yAxis2="{{yAxis2}}" yAxisType="{{yAxisType}}" yAxis2Type="{{yAxis2Type}}" legend="{{legend}}" bars1Stacked="{{bars1Stacked}}" bars2Stacked="{{bars2Stacked}}" aggregates="{{aggregates}}" groups="{{groups}}" cumulated="{{cumulated}}" sortableValues="{{sortableValues}}" showPercents="{{showPercents}}" showLabels="{{showLabels}}" showZoneLabels="{{showZoneLabels}}" valueZones="{{valueZones}}" xAxisSegment="{{xAxisSegment}}" svg="{{svg}}" />',data:{title:"",xAxisSegment:!1,valueZones:[],showPercents:!1,showLabels:!0,showZoneLabels:!0,cumulated:!0,sortableValues:[],isWidget:!1,aggregates:[],groups:[],xAxis:[],yAxis:[],yAxis2:[],legend:[],yAxisType:[],yAxis2Type:[],svg:""}}),BaseChartComponent=Ractive.extend({chartHeight:600,chartHeightModifier:1.2,bigValues:!0,parentInit:function(){(ReportData.chartHeight||ReportData.chartHeight>0)&&(this.chartHeight=ReportData.chartHeight);var a=this;this.on("increaseHeight",function(){a.chartIncreaseHeight()}),this.on("decreaseHeight",function(){a.chartDecreaseHeight()}),setTimeout(function(){a.chart.update()},300)},chartUpdate:function(){this.chart.update()},chartIncreaseHeight:function(){this.chartHeight=Math.round(this.chartHeight*this.chartHeightModifier),jQuery("#chart1").css({height:this.chartHeight}),ReportData.chartHeight=this.chartHeight,this.chart.update()},chartDecreaseHeight:function(){this.chartHeight=Math.round(this.chartHeight/this.chartHeightModifier),jQuery("#chart1").css({height:this.chartHeight}),ReportData.chartHeight=this.chartHeight,this.chart.update()}}),BarChartComponent=BaseChartComponent.extend({template:App._template("chartViewTemplate"),init:function(){this.parentInit();var a=this,b=a.get("data"),c=ReportData.chartTitle,d=a.get("svg"),e=a.get("isWidget"),f={top:50,right:50,bottom:120,left:70};ReportData.chartMargin&&(f=ReportData.chartMargin),nv.addGraph(function(){var g=nv.models.discreteBarChart().options({reduceXTicks:!1}).x(function(a){return a.label}).y(function(a){return a.value}).staggerLabels(!1).tooltips(!1).showValues(!0).transitionDuration(350).margin(f).color(d3.scale.category10().range());return g.xAxis.rotateLabels(-30),a.bigValues&&g.yAxis.tickFormat(d3.format(".0f")),g.forceY(0),d3.select(d).datum(a.normalise(b)).call(g),e||d3.select(d).append("text").attr("x",100).attr("y",10).style({"text-anchor":"left","font-weight":"bold"}).text(c),nv.utils.windowResize(g.update),a.chart=g,g})},normalise:function(a){var b=this.get("xAxis"),c=this.get("yAxis");b=reportUtils.appendDateGrouping(a,b);var d=[],e=[];_.each(a.data,function(a){a[c]||(a[c]=0),a[c]>100&&(this.bigValues=!0);var e={label:a[b],value:parseFloat(a[c])};d.push(e)});var e=[{values:d}];return e},data:{data:[],title:"",xAxis:"",yAxis:"",svg:""}});MultiBarChartComponent=BaseChartComponent.extend({template:App._template("chartViewTemplate"),init:function(){this.parentInit();var a=this,b=a.get("data"),c=ReportData.chartTitle,d=a.get("svg"),e=a.get("isWidget"),f={top:50,right:150,bottom:120,left:70};ReportData.chartMargin&&(f=ReportData.chartMargin),nv.addGraph(function(){var g=nv.models.multiBarChart().reduceXTicks(!1).transitionDuration(350).margin(f).stacked(ReportData.chartStacked).color(d3.scale.category10().range()).showControls(!1);g.xAxis.tickFormat(function(b){return"undefined"!=typeof a.axisKeys[b]?a.axisKeys[b]:""}),g.xAxis.rotateLabels(-30),a.bigValues&&g.yAxis.tickFormat(d3.format(".0f")),e||g.legend.margin({top:20,bottom:20});var h=a.normalise(b);return d3.select(d).datum(h).call(g),g.dispatch.on("stateChange",function(a){ReportData.chartStacked=a.stacked}),e||d3.select(d).append("text").attr("x",100).attr("y",10).style({"text-anchor":"left","font-weight":"bold"}).text(c),nv.utils.windowResize(g.update),a.chart=g,g})},normalise:function(a){var b=ReportData.chartLegend,c=this.get("xAxis"),d=this.get("yAxis");c=reportUtils.appendDateGrouping(a,c);for(var e=this.get("aggregates"),f=!1,g=0;g<b.length;g++){var h=ReportBarChart.getAggregate(b[g],e);if(h){f=!0;break}}return f?this.parseAggregates(a,c,d,b):this.parseGroups(a,c,d,b)},parseGroups:function(a,b,c,d){for(var e=[],f=[],g=0;g<a.data.length;g++){for(var h=0;h<d.length;h++)a.data[g][d[h]]||(a.data[g][d[h]]="-"),e.push(a.data[g][d[h]]);a.data[g][b]||(a.data[g][b]="-"),f.push(a.data[g][b])}e=unique(e),f=unique(f),this.axisKeys=f;for(var i=[],g=0;g<e.length;g++){i[g]={key:e[g],values:[]};for(var h=0;h<f.length;h++)i[g].values[h]={x:h,y:0}}for(var g=0;g<a.data.length;g++)for(var j=!1,k=f.indexOf(a.data[g][b]),h=0;h<d.length;h++)j=e.indexOf(a.data[g][d[h]]),a.data[g][c]||(a.data[g][c]=0),i[j].values[k].y=parseFloat(a.data[g][c]);return i},parseAggregates:function(a,b,c,d){for(var e=[],f=[],g=0;g<d.length;g++)e.push(d[g]);for(var h=0;h<a.data.length;h++)a.data[h][b]||(a.data[h][b]="-"),f.push(a.data[h][b]);e=unique(e),f=unique(f),this.axisKeys=f;for(var i=[],h=0;h<e.length;h++){i[h]={key:e[h],values:[]};for(var g=0;g<f.length;g++)i[h].values[g]={x:g,y:0}}for(var h=0;h<a.data.length;h++)for(var j=f.indexOf(a.data[h][b]),g=0;g<d.length;g++)for(var k=0;k<i.length;k++)i[k].key==d[g]&&(a.data[h][d[g]]||(a.data[h][d[g]]=0),parseFloat(a.data[h][d[g]])>100&&(this.bigValues=!0),i[k].values[j].y=parseFloat(a.data[h][d[g]]));for(var h=0;h<i.length;h++)i[h].key=a.cols[i[h].key];return i},data:{data:[],title:"",xAxis:"",yAxis:"",legend:"",svg:""}});var ReportBarChart={getAggregate:function(a,b){for(var c=!1,d=0;d<b.length;d++)if(b[d].value.sum&&b[d].selectedField+"_sum"==a&&(c=!0),b[d].value.avg&&b[d].selectedField+"_avg"==a&&(c=!0),b[d].value.count&&b[d].selectedField+"_cnt"==a&&(c=!0),c)return b[d]},getGroup:function(a,b){for(var c=0;c<b.length;c++)if(b[c].name==a)return b[c]},parseDataItems:function(a,b,c,d,e){for(var f=0;f<a.length;f++){if("string"==typeof a[f]){var g=this.getAggregate(a[f],b),h=this.getGroup(a[f],c);g&&e.push(g),h&&d.push(h)}"object"==typeof a[f]&&this.parseDataItems(a[f],b,c,d,e)}},prepareData:function(a,b,c,d,e){var f=ReportData.chartAxisX,g=ReportData.chartAxisY,h=ReportData.chartLegend,i=[],j=[],k=[];if(k.push(f),k.push(g),k.push(h),this.parseDataItems(k,d,e,j,i),ReportData.options.isCombined){var l=a.get("combinedSelectedFields.fields");for(moduleId in l)for(var m=l[moduleId],n=0;n<ReportData.availableFields.length;n++)for(var o=0;o<ReportData.availableFields[n].fields.length;o++)if(m==ReportData.availableFields[n].fields[o].name){var p=jQuery.extend(!0,{},ReportData.availableFields[n].fields[o]);p={name:m},p.sortAction="date_field"==ReportData.chartAxisX?"nogroup"!==ReportData.combinedSelectedFields.sortAction?ReportData.combinedSelectedFields.sortAction:"group":"nogroup",p.dateGrouping=ReportData.combinedSelectedFields.dateGrouping,p.sortDirection=ReportData.combinedSelectedFields.sortDirection,p.position=ReportData.combinedSelectedFields.position,j.unshift(p)}}for(var q=[],n=0;n<i.length;n++)q.indexOf(i[n].selectedField)>-1?(i.splice(n,1),n--):q.push(i[n].selectedField);var r={filters:JSON.stringify(b),columns:JSON.stringify(c),options:JSON.stringify(ReportData.chartOptions),labels:JSON.stringify(ReportData.labels),aggregates:JSON.stringify(i),grouping:JSON.stringify(j),calcFields:JSON.stringify(ReportData.calcFields)};return r},init:function(a,b,c,d,e){var f=this.prepareData(a,b,c,d,e);loadChart("bar",f,d,e)}},BarChartLegendManager=Ractive.extend({template:App._template("barChartLegendTemplate"),init:function(){var a=this;this.get("yAxis")instanceof String&&this.set("yAxis",[this.get("yAxis")]),this.get("legend")instanceof String&&this.set("legend",[this.get("legend")]);var b=function(){for(var b=[],c=[],d=a.get("groups"),e=a.get("aggregates"),f=a.get("fieldsByName"),g=0;g<e.length;g++){var h=f[e[g].selectedField].title,i=e[g].selectedField;e[g].value.sum&&c.push({name:i+"_sum",title:h+" "+translated_labels.label_sum}),e[g].value.count&&c.push({name:i+"_cnt",title:h+" "+translated_labels.label_count}),e[g].value.avg&&c.push({name:i+"_avg",title:h+" "+translated_labels.label_average})}for(var g=0;g<d.length;g++)"group"!=d[g].sortAction&&"groupsort"!=d[g].sortAction||(d[g].title=f[d[g].name].title,b.push(d[g]));c=_.uniq(c,function(a){return a.name}),b=_.uniq(b,function(a){return a.name});var j=[{key:translated_labels.label_groups,values:b},{key:translated_labels.label_aggregates,values:c}],c=[{key:translated_labels.label_aggregates,values:c}];a.set("availableAxis",c),ReportData.options.isCombined&&b.unshift({name:"date_field",title:translated_labels.label_date,showAggregates:{},sortAction:"group",sortDirection:"DESC",aggregate:"",position:"",dateGrouping:""}),a.set("availableGroups",b),a.set("availableLegends",j)};this.observe("groups",b),this.observe("aggregates",b,{init:!1}),this.observe("xAxis",validateXAxis,{init:!1}),this.observe("yAxis",function(b){1==b.length?a.set("legend",[this.get("xAxis")]):a.set("legend",b),ReportData.chartAxisY=b},{init:!1}),this.observe("xAxis",function(b){1==a.get("yAxis").length&&a.set("legend",[this.get("xAxis")])},{init:!1}),this.observe("y2Axis",function(a){ReportData.chartAxisY2=a},{init:!1}),0==this.get("legend").length&&this.set("legend",[this.get("xAxis")]),this.observe("legend",function(b){ReportData.chartLegend=b;for(var c=a.get("aggregates"),d=!1,e=0;e<b.length;e++)if(ReportBarChart.getAggregate(b[e],c)){d=!0;break}d&&a.set("yAxis",b)}),this.observe("chartSize",function(a){ReportData.chartSize=a})},data:{xAxis:ReportData.chartAxisX,yAxis:ReportData.chartAxisY,y2Axis:ReportData.chartAxisY2,chartTitle:ReportData.chartTitle,legend:ReportData.chartLegend,availableLegends:[],labelName:ReportData.chartLabels,groups:[],aggregates:[],availableAxis:[],availableGroups:[],chartSizes:ReportData.chartSizes,chartSize:ReportData.chartSize},components:{chartButtons:chartButtons,selectBox:selectBox,multiSelectBox:multiSelectBox}}),PieChartComponent=BaseChartComponent.extend({template:App._template("chartViewTemplate"),init:function(){this.parentInit();var a=this,b=a.get("data"),c=a.get("title"),d=a.get("svg"),e=a.get("isWidget"),f=a.get("showPercents"),g={top:10,right:10,bottom:10,left:10};ReportData.chartMargin&&(g=ReportData.chartMargin),nv.addGraph(function(){var h=nv.models.pieChart().x(function(a){return a.label}).y(function(a){return a.value}).margin(g).showLabels(!0).color(d3.scale.category10().range());return h.pie.pieLabelsOutside(!0).labelType("value").showPercents(f),e||h.legend.margin({top:20,bottom:20}),d3.select(d).datum(a.normalise(b)).transition().duration(350).call(h),e||d3.select(d).append("text").attr("x",100).attr("y",10).style({"text-anchor":"left","font-weight":"bold"}).text(c),nv.utils.windowResize(h.update),a.chart=h,h})},normalise:function(a){var b=this.get("xAxis"),c=this.get("yAxis");b=reportUtils.appendDateGrouping(a,b);var d=[],e=[];_.each(a.data,function(a){var e={label:a[b],value:parseFloat(a[c])};d.push(e)});var e=d;return e},data:{data:[],title:"",xAxis:"",yAxis:"",showPercents:!1}}),ReportPieChart={prepareData:function(a,b,c,d,e){var f=ReportData.chartAxisX,g=ReportData.chartAxisY,h=[];_.each(d,function(a){a.selectedField+"_sum"!=g&&a.selectedField+"_avg"!=g&&a.selectedField+"_cnt"!=g&&a.selectedField!=g||h.push(a)});var i=[];if(_.each(e,function(a){a.name==f&&i.push(a)}),ReportData.options.isCombined){var j=a.get("combinedSelectedFields.fields");for(moduleId in j)for(var k=j[moduleId],l=0;l<ReportData.availableFields.length;l++)for(var m=0;m<ReportData.availableFields[l].fields.length;m++)if(k==ReportData.availableFields[l].fields[m].name){var n=jQuery.extend(!0,{},ReportData.availableFields[l].fields[m]);n={name:k},n.sortAction="date_field"==ReportData.chartAxisX?"nogroup"!==ReportData.combinedSelectedFields.sortAction?ReportData.combinedSelectedFields.sortAction:"group":"nogroup",n.dateGrouping=ReportData.combinedSelectedFields.dateGrouping,n.sortDirection=ReportData.combinedSelectedFields.sortDirection,n.position=ReportData.combinedSelectedFields.position,i.unshift(n)}}var o={filters:JSON.stringify(b),columns:JSON.stringify(c),options:JSON.stringify(ReportData.chartOptions),labels:JSON.stringify(ReportData.labels),aggregates:JSON.stringify(h),grouping:JSON.stringify(i),calcFields:JSON.stringify(ReportData.calcFields)};return o},init:function(a,b,c,d,e){var f=this.prepareData(a,b,c,d,e);loadChart("pie",f,d,e)}},PieChartLegendManager=Ractive.extend({template:App._template("pieChartLegendTemplate"),init:function(){var a=this,b=function(){for(var b=[],c=[],d=a.get("groups"),e=a.get("aggregates"),f=a.get("fieldsByName"),g=0;g<e.length;g++){var h=f[e[g].selectedField].title,i=e[g].selectedField;e[g].value.sum&&c.push({name:i+"_sum",title:h+" "+translated_labels.label_sum}),e[g].value.count&&c.push({name:i+"_cnt",title:h+" "+translated_labels.label_count}),e[g].value.avg&&c.push({name:i+"_avg",title:h+" "+translated_labels.label_average})}for(var g=0;g<d.length;g++)"group"!=d[g].sortAction&&"groupsort"!=d[g].sortAction&&"nogroup"!=d[g].sortAction||(d[g].title=f[d[g].name].title,b.push(d[g]));ReportData.options.isCombined&&b.unshift({name:"date_field",title:translated_labels.label_date,showAggregates:{},sortAction:"group",sortDirection:"DESC",aggregate:"",position:"",dateGrouping:""}),c=_.uniq(c,function(a){return a.name}),b=_.uniq(b,function(a){return a.name}),a.set("availableAxis",c),a.set("availableGroups",b),a.set("availableLegends",b)};this.observe("groups",b),this.observe("aggregates",b),this.observe("xAxis",validateXAxis),this.observe("yAxis",function(a){ReportData.chartAxisY=a}),this.observe("y2Axis",function(a){ReportData.chartAxisY2=a}),this.observe("chartSize",function(a){ReportData.chartSize=a}),this.observe("showPercents",function(a){ReportData.chartShowPercents=a})},data:{xAxis:ReportData.chartAxisX,yAxis:ReportData.chartAxisY,y2Axis:ReportData.chartAxisY2,chartTitle:ReportData.chartTitle,showPercents:ReportData.chartShowPercents,labelName:ReportData.chartLabels,groups:[],aggregates:[],chartSizes:ReportData.chartSizes,chartSize:ReportData.chartSize,availableAxis:[],availableGroups:[],availableLegends:[]},components:{chartButtons:chartButtons,selectBox:selectBox}}),LineChartComponent=BaseChartComponent.extend({template:App._template("chartViewTemplate"),axisKeys:[],init:function(){this.parentInit();var a=this,b=a.get("data"),c=a.get("title"),d=a.get("svg"),e=this.get("xAxis"),f=a.get("isWidget"),g={top:50,right:50,bottom:120,left:100};ReportData.chartMargin&&(g=ReportData.chartMargin),nv.addGraph(function(){var h=nv.models.lineChart().options({reduceXTicks:!1}).margin(g).useInteractiveGuideline(!0).transitionDuration(350).showLegend(!0).color(d3.scale.category10().range());e=jQuery.grep(ReportData.fieldGroupingSorting,function(a){return a.name==e}),e=ReportData.options.isCombined&&"date_field"==a.get("xAxis")?"Date":e[0].title,h.xAxis.axisLabel(e).tickFormat(function(b){return"undefined"!=typeof a.axisKeys[b]?a.axisKeys[b]:""}),h.xAxis.rotateLabels(-30),a.bigValues&&h.yAxis.tickFormat(d3.format(".0f")),f||h.legend.margin({top:20,bottom:30}),h.forceY(0);var i=a.normalise(b);return d3.select(d).datum(i).call(h),f||d3.select(d).append("text").attr("x",100).attr("y",10).style({"text-anchor":"left","font-weight":"bold"}).text(c),nv.utils.windowResize(h.update),a.chart=h,h})},normalise:function(a){var b=ReportData.chartLegend,c=this.get("xAxis"),d=this.get("yAxis"),e=this.get("aggregates");c=reportUtils.appendDateGrouping(a,c);for(var f=!1,g=0;g<b.length;g++){var h=ReportLineChart.getAggregate(b[g],e);if(h){f=!0;break}}return f?this.parseAggregates(a,c,d,b):(b=reportUtils.appendDateGrouping(a,b),this.parseGroups(a,c,d,b))},parseAggregates:function(a,b,c,d){for(var e=[],f=[],g=0;g<d.length;g++)e.push(d[g]);for(var h=0;h<a.data.length;h++)a.data[h][b]||(a.data[h][b]="-"),f.push(a.data[h][b]);e=unique(e),f=unique(f),this.axisKeys=f;for(var i=[],h=0;h<e.length;h++){i[h]={key:e[h],values:[]};for(var g=0;g<f.length;g++)i[h].values[g]={x:g,y:0}}for(var h=0;h<a.data.length;h++)for(var j=f.indexOf(a.data[h][b]),g=0;g<d.length;g++)for(var k=0;k<i.length;k++)i[k].key==d[g]&&(a.data[h][d[g]]||(a.data[h][d[g]]=0),parseFloat(a.data[h][d[g]])>100&&(this.bigValues=!0),i[k].values[j].y=parseFloat(a.data[h][d[g]]));for(var h=0;h<i.length;h++)i[h].key=a.cols[i[h].key];return i},parseGroups:function(a,b,c,d){for(var e=[],f=[],g=0;g<a.data.length;g++){for(var h=0;h<d.length;h++)a.data[g][d[h]]||(a.data[g][d[h]]="-"),e.push(a.data[g][d[h]]);a.data[g][b]||(a.data[g][b]="-"),f.push(a.data[g][b])}e=unique(e),f=unique(f),this.axisKeys=f;for(var i=[],g=0;g<e.length;g++){i[g]={key:e[g],values:[]};for(var h=0;h<f.length;h++)i[g].values[h]={x:h,y:0}}for(var g=0;g<a.data.length;g++)for(var j=!1,k=f.indexOf(a.data[g][b]),h=0;h<d.length;h++)j=e.indexOf(a.data[g][d[h]]),a.data[g][c]||(a.data[g][c]=0),i[j].values[k].y=parseFloat(a.data[g][c]);return i},data:{data:[],title:"",xAxis:"",yAxis:""}}),ReportLineChart={getAggregate:function(a,b){for(var c=!1,d=0;d<b.length;d++)if(b[d].value.sum&&b[d].selectedField+"_sum"==a&&(c=!0),b[d].value.avg&&b[d].selectedField+"_avg"==a&&(c=!0),b[d].value.count&&b[d].selectedField+"_cnt"==a&&(c=!0),c)return b[d]},getGroup:function(a,b){for(var c=0;c<b.length;c++)if(b[c].name==a)return b[c]},parseDataItems:function(a,b,c,d,e){for(var f=0;f<a.length;f++){if("string"==typeof a[f]){var g=this.getAggregate(a[f],b),h=this.getGroup(a[f],c);g&&e.push(g),h&&d.push(h)}"object"==typeof a[f]&&this.parseDataItems(a[f],b,c,d,e)}},prepareData:function(a,b,c,d,e){var f=ReportData.chartAxisX,g=ReportData.chartAxisY,h=ReportData.chartLegend,i=[],j=[],k=[];if(k.push(f),k.push(g),k.push(h),this.parseDataItems(k,d,e,j,i),ReportData.options.isCombined){var l=a.get("combinedSelectedFields.fields");for(moduleId in l)for(var m=l[moduleId],n=0;n<ReportData.availableFields.length;n++)for(var o=0;o<ReportData.availableFields[n].fields.length;o++)if(m==ReportData.availableFields[n].fields[o].name){var p=jQuery.extend(!0,{},ReportData.availableFields[n].fields[o]);p={name:m},p.sortAction=ReportData.combinedSelectedFields.sortAction,p.dateGrouping=ReportData.combinedSelectedFields.dateGrouping,p.sortDirection=ReportData.combinedSelectedFields.sortDirection,p.position=ReportData.combinedSelectedFields.position,j.unshift(p)}}for(var q=[],n=0;n<i.length;n++)q.indexOf(i[n].selectedField)>-1?(i.splice(n,1),n--):q.push(i[n].selectedField);var r={filters:JSON.stringify(b),columns:JSON.stringify(c),options:JSON.stringify(ReportData.chartOptions),labels:JSON.stringify(ReportData.labels),aggregates:JSON.stringify(i),grouping:JSON.stringify(j),calcFields:JSON.stringify(ReportData.calcFields)};return r},init:function(a,b,c,d,e){var f=this.prepareData(a,b,c,d,e);loadChart("line",f,d,e)}},LineChartLegendManager=Ractive.extend({template:App._template("lineChartLegendTemplate"),
init:function(){var a=this,b=function(){for(var b=[],c=[],d=a.get("groups"),e=a.get("aggregates"),f=a.get("fieldsByName"),g=0;g<e.length;g++){var h=f[e[g].selectedField].title,i=e[g].selectedField;e[g].value.sum&&c.push({name:i+"_sum",title:h+" "+translated_labels.label_sum}),e[g].value.count&&c.push({name:i+"_cnt",title:h+" "+translated_labels.label_count}),e[g].value.avg&&c.push({name:i+"_avg",title:h+" "+translated_labels.label_average})}for(var g=0;g<d.length;g++)"group"!=d[g].sortAction&&"groupsort"!=d[g].sortAction||(d[g].title=f[d[g].name].title,b.push(d[g]));c=_.uniq(c,function(a){return a.name}),b=_.uniq(b,function(a){return a.name});var j=[{key:translated_labels.label_groups,values:b},{key:translated_labels.label_aggregates,values:c}];c=[{key:translated_labels.label_aggregates,values:c}],a.set("availableAxis",c),ReportData.options.isCombined&&b.unshift({name:"date_field",title:translated_labels.label_date,showAggregates:{},sortAction:"group",sortDirection:"DESC",aggregate:"",position:"",dateGrouping:""}),a.set("availableGroups",b),a.set("availableLegends",j)};this.observe("groups",b,{init:!1}),this.observe("aggregates",b,{init:!1}),b(),this.observe("xAxis",validateXAxis,{init:!1}),this.observe("yAxis",function(b){1==b.length?a.set("legend",[this.get("xAxis")]):a.set("legend",b),ReportData.chartAxisY=b},{init:!1}),this.observe("xAxis",function(b){1==a.get("yAxis").length&&a.set("legend",[this.get("xAxis")])},{init:!1}),0==this.get("legend").length&&this.set("legend",[this.get("xAxis")]),this.observe("y2Axis",function(a){ReportData.chartAxisY2=a},{init:!1}),this.observe("legend",function(b){ReportData.chartLegend=b;for(var c=a.get("aggregates"),d=!1,e=0;e<b.length;e++)if(ReportLineChart.getAggregate(b[e],c)){d=!0;break}if(d){a.get("yAxis");a.merge("yAxis",b)}},{init:!1}),this.observe("chartSize",function(a){ReportData.chartSize=a})},data:{xAxis:ReportData.chartAxisX,yAxis:ReportData.chartAxisY,y2Axis:ReportData.chartAxisY2,chartTitle:ReportData.chartTitle,legend:ReportData.chartLegend,availableLegends:[],labelName:ReportData.chartLabels,groups:[],aggregates:[],availableAxis:[],availableGroups:[],chartSizes:ReportData.chartSizes,chartSize:ReportData.chartSize},components:{chartButtons:chartButtons,selectBox:selectBox,multiSelectBox:multiSelectBox}});CombinedChartComponent=BaseChartComponent.extend({template:App._template("chartViewTemplate"),init:function(){this.parentInit();var a=this,b=a.get("data"),c=a.get("title"),d=a.get("svg"),e=a.get("isWidget"),f={top:50,right:50,bottom:120,left:70};ReportData.chartMargin&&(f=ReportData.chartMargin);var g=a.get("bars1Stacked"),h=a.get("bars2Stacked");nv.addGraph(function(){var i=nv.models.multiChart().options({reduceXTicks:!1}).margin(f).color(d3.scale.category10().range()).bars1stacked(g).bars2stacked(h);i.xAxis.tickFormat(function(b){return"undefined"!=typeof a.axisKeys[b]?a.axisKeys[b]:""}),i.xAxis.rotateLabels(-30),a.bigValues&&(i.yAxis1.tickFormat(d3.format(".0f")),i.yAxis2.tickFormat(d3.format(".0f")));for(var j=a.normalise(b),k=0,l=0,m=0,n=0,o=0;o<j.length;o++)for(var p=j[o].yAxis,q=j[o].values,r=0;r<q.length;r++)1==p&&q[r].y>m&&(m=q[r].y),2==p&&q[r].y>n&&(n=q[r].y);return i.yDomain1([k,m]),i.yDomain2([l,n]),d3.select(d).datum(j).call(i),e||d3.select(d).append("text").attr("x",100).attr("y",10).style({"text-anchor":"left","font-weight":"bold"}).text(c),nv.utils.windowResize(i.update),a.chart=i,i})},normalise:function(a){var b=this.get("legend"),c=this.get("xAxis"),d=this.get("yAxis"),e=this.get("yAxis2"),f=(this.get("aggregates"),this.get("yAxisType")),g=this.get("yAxis2Type");c=reportUtils.appendDateGrouping(a,c);for(var h=[],i=[],j=0;j<b.length;j++)h.push(b[j]);for(var k=0;k<a.data.length;k++)a.data[k][c]||(a.data[k][c]="-"),i.push(a.data[k][c]);h=unique(h),i=unique(i),this.axisKeys=i,"string"==typeof d&&(d=[d],this.set("yAxis",d)),"string"==typeof e&&(e=[e],this.set("yAxis2",e)),!f&&d.length>0&&(f="line",this.set("yAxisType",f)),!g&&e.length>0&&(g="line",this.set("yAxis2Type",g));var l=[];l.push({keys:d,type:f,position:1}),l.push({keys:e,type:g,position:2});for(var m=[],n=0,k=0;k<l.length;k++)for(var o=l[k].type,p=l[k].position,j=0;j<l[k].keys.length;j++){var q=l[k].keys[j];m[n]={key:q,type:o,yAxis:p,values:[]};for(var r=0;r<i.length;r++)m[n].values[r]={x:r,y:0};n++}for(var k=0;k<a.data.length;k++)for(var s=i.indexOf(a.data[k][c]),j=0;j<b.length;j++)for(var r=0;r<m.length;r++)if(m[r].key==b[j]){var t=parseFloat(a.data[k][b[j]]);t||(t=0),t>100&&(this.bigValues=!0),m[r].values[s].y=t}for(var k=0;k<m.length;k++)m[k].key=a.cols[m[k].key];return m},data:{data:[],title:"",xAxis:"",yAxis:[],yAxis2:[],yAxisType:"",yAxis2Type:"",bars1Stacked:!1,bars2Stacked:!1,legend:[]}});var ReportCombinedChart={getAggregate:function(a,b){for(var c=!1,d=0;d<b.length;d++)if(b[d].value.sum&&b[d].selectedField+"_sum"==a&&(c=!0),b[d].value.avg&&b[d].selectedField+"_avg"==a&&(c=!0),b[d].value.count&&b[d].selectedField+"_cnt"==a&&(c=!0),c)return b[d]},getGroup:function(a,b){for(var c=0;c<b.length;c++)if(b[c].name==a)return b[c]},parseDataItems:function(a,b,c,d,e){for(var f=0;f<a.length;f++){if("string"==typeof a[f]){var g=this.getAggregate(a[f],b),h=this.getGroup(a[f],c);g&&e.push(g),h&&d.push(h)}"object"==typeof a[f]&&this.parseDataItems(a[f],b,c,d,e)}},prepareData:function(a,b,c,d,e){var f=ReportData.chartAxisX,g=ReportData.chartAxisY,h=ReportData.chartAxisY2,i=(ReportData.chartYAxisType,ReportData.chartYAxis2Type,ReportData.chartLegend),j=[],k=[],l=[];if(l.push(f),l.push(g),l.push(h),l.push(i),this.parseDataItems(l,d,e,k,j),ReportData.options.isCombined){var m=a.get("combinedSelectedFields.fields");for(moduleId in m)for(var n=m[moduleId],o=0;o<ReportData.availableFields.length;o++)for(var p=0;p<ReportData.availableFields[o].fields.length;p++)if(n==ReportData.availableFields[o].fields[p].name){var q=jQuery.extend(!0,{},ReportData.availableFields[o].fields[p]);q={name:n},q.sortAction="date_field"==ReportData.chartAxisX?"nogroup"!==ReportData.combinedSelectedFields.sortAction?ReportData.combinedSelectedFields.sortAction:"group":"nogroup",q.dateGrouping=ReportData.combinedSelectedFields.dateGrouping,q.sortDirection=ReportData.combinedSelectedFields.sortDirection,q.position=ReportData.combinedSelectedFields.position,k.unshift(q)}}for(var r=[],o=0;o<j.length;o++)r.indexOf(j[o].selectedField)>-1?(j.splice(o,1),o--):r.push(j[o].selectedField);var s={filters:JSON.stringify(b),columns:JSON.stringify(c),options:JSON.stringify(ReportData.chartOptions),labels:JSON.stringify(ReportData.labels),aggregates:JSON.stringify(j),grouping:JSON.stringify(k),calcFields:JSON.stringify(ReportData.calcFields)};return s},init:function(a,b,c,d,e){var f=this.prepareData(a,b,c,d,e);loadChart("combined",f,d,e)}},CombinedChartLegendManager=Ractive.extend({template:App._template("combinedChartLegendTemplate"),init:function(){var a=this;this.get("yAxis")instanceof String&&this.set("yAxis",[this.get("yAxis")]),this.get("yAxis2")instanceof String&&this.set("yAxis2",[this.get("yAxis2")]),this.get("legend")instanceof String&&this.set("legend",[this.get("legend")]);var b=function(){for(var b=[],c=[],d=[],e=[],f=[],g=a.get("groups"),h=a.get("aggregates"),i=a.get("legend"),j=a.get("fieldsByName"),k=0;k<i.length;k++)for(var l=0;l<g.length;l++)g[l].name==i[k]&&i.splice(k,1);for(var m=a.get("yAxis"),n=a.get("yAxis2"),o=m.length-1,p=n.length-1,k=0;k<h.length;k++){var q,r=j[h[k].selectedField].title,s=h[k].selectedField;if(h[k].value.sum){c.push({name:s+"_sum",title:r+" "+translated_labels.label_sum}),q=!0;for(var t=o;t>=0;t--)m[t]==s+"_sum"&&(q=!1);q&&e.push({name:s+"_sum",title:r+" "+translated_labels.label_sum}),q=!0;for(var t=p;t>=0;t--)n[t]==s+"_sum"&&(q=!1);q&&d.push({name:s+"_sum",title:r+" "+translated_labels.label_sum}),f.push({name:s+"_sum",title:r+" "+translated_labels.label_sum})}if(h[k].value.count){c.push({name:s+"_cnt",title:r+" "+translated_labels.label_count}),q=!0;for(var t=o;t>=0;t--)m[t]==s+"_cnt"&&(q=!1);q&&e.push({name:s+"_cnt",title:r+" "+translated_labels.label_count}),q=!0;for(var t=p;t>=0;t--)n[t]==s+"_cnt"&&(q=!1);q&&d.push({name:s+"_cnt",title:r+" "+translated_labels.label_count}),f.push({name:s+"_cnt",title:r+" "+translated_labels.label_count})}if(h[k].value.avg){c.push({name:s+"_avg",title:r+" "+translated_labels.label_average}),q=!0;for(var t=o;t>=0;t--)m[t]==s+"_avg"&&(q=!1);q&&e.push({name:s+"_avg",title:r+" "+translated_labels.label_average}),q=!0;for(var t=p;t>=0;t--)n[t]==s+"_avg"&&(q=!1);q&&d.push({name:s+"_avg",title:r+" "+translated_labels.label_average}),f.push({name:s+"_avg",title:r+" "+translated_labels.label_average})}}for(var k=0;k<g.length;k++)"group"!=g[k].sortAction&&"groupsort"!=g[k].sortAction&&"nogroup"!=g[k].sortAction||(g[k].title=j[g[k].name].title,b.push(g[k]));c=_.uniq(c,function(a){return a.name}),d=_.uniq(d,function(a){return a.name}),e=_.uniq(e,function(a){return a.name}),b=_.uniq(b,function(a){return a.name}),u=f.length>0?f:c;var u=[{key:translated_labels.label_aggregates,values:u}],c=[{key:translated_labels.label_aggregates,values:c}],d=[{key:translated_labels.label_aggregates,values:d}],e=[{key:translated_labels.label_aggregates,values:e}],v=[{name:"line",title:translated_labels.label_line},{name:"bar",title:translated_labels.label_column}];a.set("availableAxis",c),a.set("availableAxis1",c),a.set("availableAxis2",c),ReportData.options.isCombined&&b.unshift({name:"date_field",title:translated_labels.label_date,showAggregates:{},sortAction:"group",sortDirection:"DESC",aggregate:"",position:"",dateGrouping:""}),a.set("availableGroups",b),a.set("availableLegends",u),a.set("availableTypes",v)};this.observe("groups",b,{init:!1}),this.observe("aggregates",b,{init:!1}),b(),this.observe("xAxis",validateXAxis),this.observe("yAxis",function(b){for(var c=a.get("yAxis2"),d=[],e=c.length-1,f=e;f>=0;f--)jQuery.inArray(c[f],b)==-1&&d.push(c[f]);a.set("legend",a.get("yAxis").concat(a.get("yAxis2"))),ReportData.chartAxisY=b},{init:!1}),this.observe("yAxis2",function(b){for(var c=a.get("yAxis"),d=[],e=c.length-1,f=e;f>=0;f--)jQuery.inArray(c[f],b)==-1&&d.push(c[f]);a.set("legend",a.get("yAxis").concat(a.get("yAxis2"))),ReportData.chartAxisY2=b},{init:!1}),this.observe("bars1Stacked",function(a){ReportData.chartBars1Stacked=a},{init:!1}),this.observe("bars2Stacked",function(a){ReportData.chartBars2Stacked=a},{init:!1}),this.observe("yAxisType",function(b){ReportData.chartYAxisType=b,"bar"!==b&&a.set("bars1Stacked",!1)},{init:!1}),this.observe("yAxis2Type",function(b){ReportData.chartYAxis2Type=b,"bar"!==b&&a.set("bars2Stacked",!1)},{init:!1}),this.observe("legend",function(a){ReportData.chartLegend=a},{init:!1}),this.observe("chartSize",function(a){ReportData.chartSize=a})},data:{xAxis:ReportData.chartAxisX,yAxis:ReportData.chartAxisY,yAxis2:ReportData.chartAxisY2,chartTitle:ReportData.chartTitle,yAxisType:ReportData.chartYAxisType,yAxis2Type:ReportData.chartYAxis2Type,bars1Stacked:ReportData.chartBars1Stacked,bars2Stacked:ReportData.chartBars2Stacked,legend:ReportData.chartLegend,availableLegends:[],availableTypes:[],labelName:ReportData.chartLabels,groups:[],aggregates:[],availableAxis:[],availableGroups:[],chartSizes:ReportData.chartSizes,chartSize:ReportData.chartSize,availableAxis1:[],availableAxis2:[]},components:{chartButtons:chartButtons,selectBox:selectBox,multiSelectBox:multiSelectBox}}),FunnelChartComponent=BaseChartComponent.extend({template:App._template("chartViewTemplate"),init:function(){function a(){jQuery(e).empty();var g=new D3Funnel(e);return g.update=function(){a()},g.draw(b.normalise(c),h),f||d3.select(e).append("text").attr("x",100).attr("y",10).style({"text-anchor":"left","font-weight":"bold"}).text(d),b.chart=g,g}this.parentInit();var b=this,c=b.get("data"),d=b.get("title"),e=b.get("svg"),f=b.get("isWidget"),g=(b.get("showPercents"),{top:10,right:10,bottom:10,left:10});ReportData.chartMargin&&(g=ReportData.chartMargin);var h={hoverEffects:!0,fillType:"gradient",dynamicArea:!0};f||(h.margin={left:100,right:0,top:30,bottom:0}),a()},getTotal:function(a,b){for(var c=0,d=0;d<a.length;d++)a[d][b]&&(c+=parseFloat(a[d][b]));return c},getPercents:function(a,b){var c=0;return a>0&&b>0&&(c=b/a*100),c},normalise:function(a){for(var b=this.get("xAxis"),c=this.get("yAxis"),d=this.get("cumulated"),e=this.get("groups"),f=(this.get("showPercents"),0);f<e.length;f++)e[f].name==b&&e[f].dateGrouping&&(b=b+"_"+e[f].dateGrouping);return d?this.normaliseCumulated(a,b,c):this.normaliseNonCumulated(a,b,c)},normaliseCumulated:function(a,b,c,d){var e=this,f=this.get("sortableValues"),g=[],h=[],i=e.getTotal(a.data,c),j=e.get("showPercents");if(_.each(a.data,function(a){var d={key:a[b],val:parseFloat(a[c])};g.push(d)}),0==f.length&&(g=g.sort(function(a,b){return a.val-b.val}),g=this.cumulateValues(g),g=g.sort(function(a,b){return b.val-a.val})),f.length>0){for(var k=[],l=0;l<f.length;l++)for(var m=f[l].value,n=0;n<g.length;n++)m==g[n].key&&k.push(g[n]);g=this.cumulateValues(k)}for(var l=0;l<g.length;l++){var o=g[l].key,p=g[l].val;j&&(o+=" ("+e.getPercents(i,p).toFixed(2)+"%)");var q=[o,p.toFixed(2)];h.push(q)}return h},cumulateValues:function(a){for(var b=0,c=!1,a=a.reverse(),d=0;d<a.length;d++){if(a[d].val>0)c=!0;else if(!c){a.splice(d,1);continue}c&&(a[d].val=a[d].val+b,b=a[d].val)}var e=a.reverse();return e},normaliseNonCumulated:function(a,b,c){var d=this,e=[],f=[],g=d.getTotal(a.data,c),h=d.get("showPercents");_.each(a.data,function(a){var f=a[b],i=parseFloat(a[c]);h&&(f+=" ("+d.getPercents(g,i).toFixed(2)+"%)");var j={key:f,val:i};e.push(j)}),e=e.sort(function(a,b){return b.val-a.val});for(var e=e.reverse(),i=!1,j=0;j<e.length;j++){if(e[j].val>0)i=!0;else if(!i){e.splice(j,1);continue}var k=[e[j].key,e[j].val.toFixed(2)];f.push(k)}return f.reverse()},data:{cumulated:!0,sortableValues:[],data:[],title:"",xAxis:"",yAxis:"",showPercents:!1}}),ReportFunnelChart={prepareData:function(a,b,c,d,e){var f=ReportData.chartAxisX,g=ReportData.chartAxisY,h=[];_.each(d,function(a){a.selectedField+"_sum"!=g&&a.selectedField+"_avg"!=g&&a.selectedField+"_cnt"!=g&&a.selectedField!=g||h.push(a)});var i=[];if(_.each(e,function(a){a.name==f&&i.push(a)}),ReportData.options.isCombined){var j=a.get("combinedSelectedFields.fields");for(moduleId in j)for(var k=j[moduleId],l=0;l<ReportData.availableFields.length;l++)for(var m=0;m<ReportData.availableFields[l].fields.length;m++)if(k==ReportData.availableFields[l].fields[m].name){var n=jQuery.extend(!0,{},ReportData.availableFields[l].fields[m]);n={name:k},n.sortAction="date_field"==ReportData.chartAxisX?"nogroup"!==ReportData.combinedSelectedFields.sortAction?ReportData.combinedSelectedFields.sortAction:"group":"nogroup",n.dateGrouping=ReportData.combinedSelectedFields.dateGrouping,n.sortDirection=ReportData.combinedSelectedFields.sortDirection,n.position=ReportData.combinedSelectedFields.position,i.unshift(n)}}var o={filters:JSON.stringify(b),columns:JSON.stringify(c),options:JSON.stringify(ReportData.chartOptions),labels:JSON.stringify(ReportData.labels),aggregates:JSON.stringify(h),grouping:JSON.stringify(i),calcFields:JSON.stringify(ReportData.calcFields)};return o},init:function(a,b,c,d,e){var f=this.prepareData(a,b,c,d,e);loadChart("funnel",f,d,e)}},FunnelChartLegendManager=Ractive.extend({template:App._template("funnelChartLegendTemplate"),init:function(){var a=this,b=function(){for(var b=[],c=[],d=a.get("groups"),e=a.get("aggregates"),f=a.get("fieldsByName"),g=0;g<e.length;g++){var h=f[e[g].selectedField].title,i=e[g].selectedField;e[g].value.sum&&c.push({name:i+"_sum",title:h+" "+translated_labels.label_sum}),e[g].value.count&&c.push({name:i+"_cnt",title:h+" "+translated_labels.label_count}),e[g].value.avg&&c.push({name:i+"_avg",title:h+" "+translated_labels.label_average})}for(var g=0;g<d.length;g++)"group"!=d[g].sortAction&&"groupsort"!=d[g].sortAction&&"nogroup"!=d[g].sortAction||(d[g].title=f[d[g].name].title,b.push(d[g]));ReportData.options.isCombined&&b.unshift({name:"date_field",title:translated_labels.label_date,showAggregates:{},sortAction:"group",sortDirection:"DESC",aggregate:"",position:"",dateGrouping:""}),c=_.uniq(c,function(a){return a.name}),b=_.uniq(b,function(a){return a.name}),a.set("availableAxis",c),a.set("availableGroups",b),a.set("availableLegends",b)};this.observe("groups",b),this.observe("aggregates",b),this.observe("xAxis",validateXAxis),this.observe("xAxis",function(){a.loadSortingValues(ReportData.chartAxisX)}),this.observe("yAxis",function(a){ReportData.chartAxisY=a}),this.observe("y2Axis",function(a){ReportData.chartAxisY2=a}),this.observe("chartSize",function(a){ReportData.chartSize=a}),this.observe("showPercents",function(a){ReportData.chartShowPercents=a}),this.observe("sortableValues",function(a){ReportData.chartSortableValues=a}),this.observe("cumulated",function(a){ReportData.chartCumulated=a})},loadSortingValues:function(a){var b=this,c={fieldName:a};jQuery.post(ReportData.urlLoadPicklists,c,function(a){var c;try{c=JSON.parse(a)}catch(a){console.log("Error loading sorting values: "+a)}var d=[];c.length>0&&(d=b.mergeSortingValues(c)),b.set("sortableValues",d)})},mergeSortingValues:function(a){var b=this,c=[],d=b.get("sortableValues");d||(d=[]);for(var e=0;e<d.length;e++){for(var f=!1,g=0;g<a.length;g++)if(d[e].key==a[g].key){f=!0;break}f&&c.push(d[e])}for(var e=0;e<a.length;e++){for(var f=!1,g=0;g<c.length;g++)if(a[e].key==c[g].key){f=!0;break}f||c.push(a[e])}return c},data:{xAxis:ReportData.chartAxisX,yAxis:ReportData.chartAxisY,y2Axis:ReportData.chartAxisY2,chartTitle:ReportData.chartTitle,cumulated:ReportData.chartCumulated,sortableValues:ReportData.chartSortableValues,showPercents:ReportData.chartShowPercents,labelName:ReportData.chartLabels,groups:[],aggregates:[],chartSizes:ReportData.chartSizes,chartSize:ReportData.chartSize,availableAxis:[],availableGroups:[],availableLegends:[]},components:{chartButtons:chartButtons,selectBox:selectBox}}),GaugeChartComponent=BaseChartComponent.extend({template:App._template("chartViewTemplate"),init:function(){function a(){var g=jQuery(b.get("svg")).height();i.margin&&(g=g-i.margin.top-i.margin.bottom),i.size=g,jQuery(e).empty();var h=new D3Gauge(e,i);return h.update=function(){a()},h.write(b.normalise(c)),f||d3.select(e).append("text").attr("x",100).attr("y",10).style({"text-anchor":"left","font-weight":"bold"}).text(d),b.chart=h,h}this.parentInit();var b=this,c=b.get("data"),d=b.get("title"),e=b.get("svg"),f=b.get("isWidget"),g=b.get("valueZones"),h=(b.get("showLabels"),b.get("showZoneLabels"),{top:10,right:10,bottom:10,left:10});ReportData.chartMargin&&(h=ReportData.chartMargin);var i={min:b.getValueZonesMin(),max:b.getValueZonesMax(),transitionDuration:900,label:"",minorTicks:5,majorTicks:10,needleWidthRatio:.6,needleContainerRadiusRatio:.7,clazz:"small",zones:g,showLabels:ReportData.chartShowLabels,showZoneLabels:ReportData.chartShowZoneLabels};f||(i.margin={left:100,right:0,top:30,bottom:0}),a()},getValueZonesMin:function(){for(var a=this.get("valueZones"),b=0,c=0;c<a.length;c++)a[c].from<b&&(b=parseFloat(a[c].from));return b},getValueZonesMax:function(){for(var a=this.get("data"),b=this.get("valueZones"),c=0,d=0;d<b.length;d++)b[d].to>c&&(c=parseFloat(b[d].to));var e=this.normalise(a);return e>c?e:c},normalise:function(a){var b=this.get("xAxis"),c=this.get("xAxisSegment"),d=this.get("yAxis");b=reportUtils.appendDateGrouping(a,b);var e=0;return _.each(a.data,function(a){if(c){if(a[b]&&a[b]==c){var f=parseFloat(a[d]);f&&(e+=f)}}else{var f=parseFloat(a[d]);f&&(e+=f)}}),e||(e=0),e},data:{data:[],title:"",xAxis:"",yAxis:"",showPercents:!1,valueZones:[],xAxisSegment:!1,showLabels:ReportData.chartShowLabels,showZoneLabels:ReportData.chartShowZoneLabels}}),ReportGaugeChart={prepareData:function(a,b,c,d,e){var f=ReportData.chartAxisX,g=ReportData.chartAxisY,h=[];_.each(d,function(a){a.selectedField+"_sum"!=g&&a.selectedField+"_avg"!=g&&a.selectedField+"_cnt"!=g&&a.selectedField!=g||h.push(a)});var i=[];if(_.each(e,function(a){a.name==f&&i.push(a)}),ReportData.options.isCombined){var j=a.get("combinedSelectedFields.fields");for(moduleId in j)for(var k=j[moduleId],l=0;l<ReportData.availableFields.length;l++)for(var m=0;m<ReportData.availableFields[l].fields.length;m++)if(k==ReportData.availableFields[l].fields[m].name){var n=jQuery.extend(!0,{},ReportData.availableFields[l].fields[m]);n={name:k},n.sortAction="date_field"==ReportData.chartAxisX?"nogroup"!==ReportData.combinedSelectedFields.sortAction?ReportData.combinedSelectedFields.sortAction:"group":"nogroup",n.dateGrouping=ReportData.combinedSelectedFields.dateGrouping,n.sortDirection=ReportData.combinedSelectedFields.sortDirection,n.position=ReportData.combinedSelectedFields.position,i.unshift(n)}}var o={filters:b,columns:c,options:ReportData.chartOptions,labels:ReportData.labels,aggregates:d,grouping:i,calcFields:ReportData.calcFields};return ReportData.options.isCombined&&(o.combinedSelectedFields=a.get("combinedSelectedFields.fields")),o=reportUtils.convertToJSONPost(o)},init:function(a,b,c,d,e){var f=this.prepareData(a,b,c,d,e);loadChart("gauge",f,d,e)}},GaugeChartLegendManager=Ractive.extend({template:App._template("gaugeChartLegendTemplate"),init:function(){var a=this,b=a.get("valueZones");b&&0!=b.length||a.addValueZone();var c=function(){for(var b=[],c=[],d=a.get("groups"),e=a.get("aggregates"),f=a.get("fieldsByName"),g=0;g<e.length;g++){var h=f[e[g].selectedField].title,i=e[g].selectedField;e[g].value.sum&&c.push({name:i+"_sum",title:h+" "+translated_labels.label_sum}),e[g].value.count&&c.push({name:i+"_cnt",title:h+" "+translated_labels.label_count}),e[g].value.avg&&c.push({name:i+"_avg",title:h+" "+translated_labels.label_average})}for(var g=0;g<d.length;g++)"group"!=d[g].sortAction&&"groupsort"!=d[g].sortAction&&"nogroup"!=d[g].sortAction||(d[g].title=f[d[g].name].title,b.push(d[g]));ReportData.options.isCombined&&b.unshift({name:"date_field",title:translated_labels.label_date,showAggregates:{},sortAction:"group",sortDirection:"DESC",aggregate:"",position:"",dateGrouping:""}),c=_.uniq(c,function(a){return a.name}),b=_.uniq(b,function(a){return a.name}),a.set("availableAxis",c),a.set("availableGroups",b),a.set("availableLegends",b)};this.on("addValueZone",function(b){b.original.preventDefault(),a.addValueZone()}),this.on("removeValueZone",function(b,c){b.original.preventDefault(),a.removeValueZone(c)}),this.observe("groups",c),this.observe("aggregates",c),this.observe("yAxis",function(a){ReportData.chartAxisY=a}),this.observe("xAxis",function(b){ReportData.chartAxisX=b,a.loadGroupingSegments(ReportData.chartAxisX)}),this.observe("xAxisSegment",function(a){ReportData.chartAxisXSegment=a}),this.observe("valueZones",function(a){ReportData.chartValueZones=a}),this.observe("showLabels",function(a){ReportData.chartShowLabels=a}),this.observe("showZoneLabels",function(a){ReportData.chartShowZoneLabels=a})},loadGroupingSegments:function(a){"date"==a&&(a="date_field");var b=this,c=ReportData.url+ReportData.id+"&distinct="+a,d=b.getReportMainDataPreview();d=reportUtils.convertToJSONPost(d),jQuery.post(c,d,function(a){var c;try{c=JSON.parse(a)}catch(a){console.log("Error loading grouping segments: "+a)}var d=[];d.push({name:"",title:translated_labels.label_all}),c.length>0&&(d=jQuery.merge(d,c)),b.set("availableGroupSegments",d)})},addValueZone:function(){var a=this.get("valueZones");a||(a=[]);var b={clazz:"green-zone",from:0,to:100};a.push(b),this.set("valueZones",a)},removeValueZone:function(a){var b=this.get("valueZones");b.splice(a,1),this.set("valueZones",b)},data:{xAxis:!1,yAxis:!1,y2Axis:!1,chartTitle:"",showPercents:!1,showLabels:ReportData.chartShowLabels,showZoneLabels:ReportData.chartShowZoneLabels,labelName:"",groups:[],aggregates:[],chartSizes:[],chartSize:!1,availableAxis:[],availableGroups:[],availableLegends:[],valueZones:[],availableValueZones:[{title:translated_labels.label_color_light_blue,name:"light-blue-zone"},{title:translated_labels.label_color_blue,name:"blue-zone"},{title:translated_labels.label_color_light_green,name:"light-green-zone"},{title:translated_labels.label_color_green,name:"green-zone"},{title:translated_labels.label_color_yellow,name:"yellow-zone"},{title:translated_labels.label_color_orange,name:"orange-zone"},{title:translated_labels.label_color_brown,name:"brown-zone"},{title:translated_labels.label_color_gray,name:"gray-zone"},{title:translated_labels.label_color_red,name:"red-zone"},{title:translated_labels.label_color_pink,name:"pink-zone"},{title:translated_labels.label_color_violet,name:"violet-zone"}],xAxisSegment:!1},components:{chartButtons:chartButtons,selectBox:selectBox}}),chartButtons=Ractive.extend({template:'<reportBtn text="'+translated_labels.label_preview+'" on-clicked="preview" className="green" />',data:{className:""},components:{reportBtn:reportBtn}}),chartTypeManager=Ractive.extend({template:App._template("chartTypeTemplate"),init:function(){this.observe("chartSize",function(a){ReportData.chartSize=a}),this.observe("chartType",function(a){ReportData.chartType=a})},data:{chartTypes:[{name:"pie",title:translated_labels.label_pie_chart},{name:"bar",title:translated_labels.label_column_chart},{name:"line",title:translated_labels.label_line_chart},{name:"combined",title:translated_labels.label_combined_chart},{name:"funnel",title:translated_labels.label_funnel_chart},{name:"gauge",title:translated_labels.label_gauge_chart}],chartType:ReportData.chartType,chartTitle:ReportData.chartTitle,chartSizes:ReportData.chartSizes,chartSize:ReportData.chartSize},components:{chartButtons:chartButtons,selectBoxImg:selectBoxImg,selectBox:selectBox}});