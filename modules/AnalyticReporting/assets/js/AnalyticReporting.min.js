/*! AnalyticReporting 26-06-2017 */
function capitalize(a){return a&&a[0].toUpperCase()+a.slice(1)}function getLimit(a){var b="",c=a.get("selectedFields");if(c[0]&&c[0].showTop){var d=c[0].showTop;!isNaN(parseFloat(d))&&isFinite(d)&&(b=c[0].showTop)}return b}function unique(a){var b=[];return jQuery.each(a,function(a,c){jQuery.inArray(c,b)==-1&&b.push(c)}),b}function pop_include_details(){newwindow2=window.open("","name","height=300,width=600");var a=newwindow2.document;a.write("<html><head><title>Include Details Help</title>"),a.write("</head><body>"),a.write("<p>"+translated_labels.label_tooltip_msg_1+"</p>"),a.write("</body></html>"),a.close()}function pop_crosstab(){newwindow2=window.open("","name","height=300,width=600");var a=newwindow2.document;a.write("<html><head><title>Is Crosstab Help</title>"),a.write("</head><body>"),a.write("<p>"+translated_labels.label_tooltip_msg_2+"</p>"),a.write("</body></html>"),a.close()}function pop_aggregates_as_column(){newwindow2=window.open("","name","height=300,width=600");var a=newwindow2.document;a.write("<html><head><title>Aggregates as column Help</title>"),a.write("</head><body>"),a.write("<p>"+translated_labels.label_tooltip_msg_3+"</p>"),a.write("</body></html>"),a.close()}function push_page(a,b,c){var d={pageNumber:a};return b==a&&(d.currentPage=!0),c.push(d),c}function push_separator(a,b){var c={pageSeparator:!0,symbol:a};return b.push(c),b}function getGrandTotalsLabel(){var a=translated_labels.label_grand_total;return ReportData.labels.grandTotal&&(a=ReportData.labels.grandTotal),a}function getColumnWidth(a){var b=a.data,c=a.label,d=a.name,e=0;a.grouped&&(e=20),a.grouped&&a.groupedLevel>0&&(e+=30);for(var f=0,g=0,h=0;h<b.length;h++)b[h][d]&&b[h][d].length>g&&(g=b[h][d].length);if(f=c.length>g?c.length:g,f>17)var i=7;else if(f>10)var i=8;else var i=9;var j=i*f+e;return j}function parseDateGroups(a){for(var b=jQuery.extend(!0,[],a),c=0;c<b.length;c++)b[c].dateGrouping&&(b[c].name=b[c].name+"_"+b[c].dateGrouping,b[c].aggregate=b[c].aggregate+"_"+b[c].dateGrouping,b[c].title=b[c].title+" ("+capitalize(b[c].dateGrouping)+")");return b}function getChartObject(a){var b;switch(a){case"gauge":b=ReportGaugeChart;break;case"funnel":b=ReportFunnelChart;break;case"bar":b=ReportBarChart;break;case"line":b=ReportLineChart;break;case"combined":b=ReportCombinedChart;break;case"pie":default:b=ReportPieChart}return b}function getChartComponent(a,b,c){var d;switch(a){case"gauge":d=GaugeChartComponent;break;case"funnel":d=FunnelChartComponent;break;case"bar":d=b!=c?MultiBarChartComponent:BarChartComponent;break;case"line":d=LineChartComponent;break;case"combined":d=CombinedChartComponent;break;case"pie":default:d=PieChartComponent}return d}function loadChart(a,b,c,d){jQuery.post(ReportData.url+ReportData.id+"&chart=1",b,function(e){if(ReportData.chartSize){if(ReportData.chartHeight||ReportData.chartHeight>0)var f=ReportData.chartHeight+"px";else var f=200+400*ReportData.chartSize/100+"px";var g=ReportData.chartSize+"%";jQuery("#chart1").css({width:g,height:f})}ReportData.chartData=JSON.parse(e),initChartView(a,b,!0,c,d)})}function initChartView(a,b,c,d,e){return e=e||ReportData.fieldGroupingSorting,d=d||ReportData.selectedAggregates,c=c||!1,chartView=new ChartView({el:"#chart1",data:{svg:"#chart1 svg",data:ReportData.chartData,title:ReportData.chartTitle,showPercents:ReportData.chartShowPercents,showLabels:ReportData.chartShowLabels,showZoneLabels:ReportData.chartShowZoneLabels,valueZones:ReportData.chartValueZones,xAxisSegment:ReportData.chartAxisXSegment,legend:ReportData.chartLegend,xAxis:ReportData.chartAxisX,yAxis:ReportData.chartAxisY,yAxis2:ReportData.chartAxisY2,yAxisType:ReportData.chartYAxisType,yAxis2Type:ReportData.chartYAxis2Type,aggregates:d,groups:e,bars1Stacked:ReportData.chartBars1Stacked,bars2Stacked:ReportData.chartBars2Stacked,showLinks:c,isWidget:ReportData.isWidget,cumulated:ReportData.chartCumulated,sortableValues:ReportData.chartSortableValues},components:{chartComponent:getChartComponent(a,ReportData.chartLegend,ReportData.chartAxisX)}})}var App={Views:{},Models:{},Collections:{},init:function(){},template:function(a){return _.template(this._template(a))},_template:function(a){return jQuery("#"+a).html()}};Ractive.decorators.select2.type.filter={width:"resolve",dropdownAutoWidth:!0};var postToURL=function(a,b){var c=jQuery("<form/>",{action:a,method:"POST",style:"display: none;"});jQuery.each(b,function(a,b){c.append(jQuery("<input/>",{name:a,value:b,type:"hidden"}))}),c.appendTo("body").submit()},cleanAggregates=function(a){for(var b=0;b<a.length;b++)delete a[b].blocks,delete a[b].availableFields;return a},showData=function(a,b,c,d,e,f,g){return function(h){jQuery(".ar-loading").hide(),ReportData.currentResult=JSON.parse(h);var i=reportUtils.isMultiSummaryReport(a,b,c,ReportData.isCrosstab);c?DetailGrid.init(d,e):i?DetailGrid.init(d,e,i):SummaryGrid.init(d,e),ReportData.currentResult.meta&&(f.set("meta",ReportData.currentResult.meta),f.set("isCrosstab",ReportData.options.isCrosstab),g.set("meta",ReportData.currentResult.meta),g.set("isCrosstab",ReportData.options.isCrosstab))}},chartView;jQuery(document).ready(function(a){function b(){var a=n.get("chartType"),b=null;switch(a){case"gauge":b=ReportGaugeChart;break;case"funnel":b=ReportFunnelChart;break;case"bar":b=ReportBarChart;break;case"pie":b=ReportPieChart;break;case"line":b=ReportLineChart;break;case"combined":b=ReportCombinedChart}var c=i.get("groups"),d=j.get("aggregates"),e=k.get("selectedFields"),f=h.get("selectedFields");b.init(k,c,f,d,e)}jQuery("#ar-rv-editor-tabs, #ar-rv-chart-editor-tabs").tabs(),jQuery(".ar-rv-section .toggle").click(function(a){a.preventDefault(),jQuery(this).is(".asc")?(jQuery(this).removeClass("asc"),jQuery(this).addClass("desc")):(jQuery(this).removeClass("desc"),jQuery(this).addClass("asc"));var b=jQuery(this).parent().siblings();jQuery(b[0]).slideToggle(100)});var c=[],d=function(a){for(var b={},d=0;d<a.length;d++)for(var e=0;e<a[d].fields.length;e++)b[a[d].fields[e].name]=a[d].fields[e],c.push(a[d].fields[e]);return b};ReportData.fieldsByName=d(ReportData.options.isCombined?ReportData.selectableFields:ReportData.availableFields);var e,f,g,h,i,j,k,l,m,n,o,p,q,r;ReportData.chartAxisY instanceof Array||(ReportData.chartAxisY=[ReportData.chartAxisY]),ReportData.chartAxisY2 instanceof Array||(ReportData.chartAxisY2=[ReportData.chartAxisY2]);var s={blocks:ReportData.availableFields,groups:ReportData.selectedFilters},t={blocks:ReportData.availableFields,selectedFields:ReportData.selectedFields,fieldsByName:ReportData.fieldsByName},u={aggregates:ReportData.selectedAggregates,fieldsByName:ReportData.fieldsByName},v={selectedFields:ReportData.fieldGroupingSorting,aggregates:ReportData.selectedAggregates,fieldsByName:ReportData.fieldsByName,availableFields:c,totalAggregates:ReportData.totalAggregates,combinedSelectedFields:ReportData.combinedSelectedFields,aggregatesAsColumn:ReportData.options.aggregateColumn,blocks:ReportData.availableFields},w={labels:ReportData.labels,aggregates:ReportData.selectedAggregates,availableFields:ReportData.availableFields,fieldsByName:ReportData.fieldsByName,totalAggregates:ReportData.totalAggregates,aggregatesAsColumn:ReportData.options.aggregateColumn,isCombined:ReportData.options.isCombined},x={users:ReportData.reportAccessUsers,accessRights:ReportData.reportAccessUsersSelected,globalSharing:ReportData.sharedAccess,availableOwners:ReportData.users,owner:ReportData.owner,globalSharingRights:ReportData.sharedAccessRights},y={users:ReportData.reportScheduleUsers,isScheduled:ReportData.schedule.isScheduled,selectedUsers:ReportData.reportScheduleUsersSelected,timeH:ReportData.schedule.timeH,timeM:ReportData.schedule.timeM,interval:ReportData.schedule.interval,intervalOptions:ReportData.schedule.intervalOptions,scheduledFormats:ReportData.schedule.formats},z={fieldsByName:ReportData.fieldsByName,fns:[{name:"plus",title:translated_labels.label_fn_plus,valCount:2,argTitles:["","+"],acceptedFields:["number","integer"],summary:!1},{name:"minus",title:translated_labels.label_fn_minus,valCount:2,argTitles:["","-"],acceptedFields:["number","integer"],summary:!1},{name:"mult",title:translated_labels.label_fn_multiply,valCount:2,argTitles:["","*"],acceptedFields:["number","integer"],summary:!1},{name:"div",title:translated_labels.label_fn_divide,valCount:2,argTitles:["","/"],acceptedFields:["number","integer"],summary:!1}],calcFields:ReportData.calcFields};paginationManagerOpt={isCrosstab:ReportData.options.isCrosstab},ReportData.options.isCombined&&(t.blocks=ReportData.selectableFields,v.availableFieldsPossible=c),h=new reportFieldManager({data:t}),k=new reportGroupingManager({data:v});var A=h.get("fieldsByName"),B=[];for(var C in A)B.push(A[C]);z.availableFields=B,p=new reportCalcFieldManager({data:z}),q=new reportPaginationManager({data:paginationManagerOpt}),r=new reportPaginationManager({data:paginationManagerOpt});var D={filters:ReportData.selectedFilters,columns:ReportData.selectedFields,aggregates:ReportData.selectedAggregates,grouping:JSON.parse(JSON.stringify(ReportData.fieldGroupingSorting)),options:ReportData.options,labels:ReportData.labels,showTop:getLimit(k),calcFields:ReportData.calcFields};if(ReportData.options.isCombined){var E=ReportData.combinedSelectedFields.fields,F=ReportData.combinedSelectedFields;for(var G in E){var H=E[G];if(ReportData.fieldsByName[H]){var I={name:H,sortAction:F.sortAction,dateGrouping:F.dateGrouping,sortDirection:F.sortDirection,position:F.position};D.grouping.unshift(I)}}D.combinedSelectedFields=E}jQuery.post(ReportData.url+ReportData.id,reportUtils.convertToJSONPost(D),showData(ReportData.selectedAggregates,ReportData.fieldGroupingSorting,ReportData.options.includeDetails,h,k,q,r)),i=new reportFilterManager({data:s}),i.render("#ar-rv-editor-filters").then(function(){return h.render("#ar-rv-editor-fields")}).then(function(){return!!ReportData.isCombined||p.render("#ar-rv-editor-calcfields")}).then(function(){return q.render("#pagination-top")}).then(function(){return r.render("#pagination-bottom")}).then(function(){return u.availableFields=h.get("selectableFields"),j=new reportAggregateManager({data:u}),p.observe("calcFields",function(a){for(var b=h.get("selectableFields"),c=j.get("fieldsByName"),d=0;d<a.length;d++)c[a[d].name]=a[d];j.set("fieldsByName",c),j.set("availableFields",b.concat(a)),k.set("fieldsByName",c)}),h.observe("selectableFields",function(a){for(var b=p.get("calcFields"),c=j.get("fieldsByName"),d=0;d<b.length;d++)c[b[d].name]=b[d];j.set("fieldsByName",c),j.set("availableFields",a.concat(b))},{init:!1}),j.render("#ar-rv-editor-agregates")}).then(function(){return k.set("aggregates",j.get("aggregates")),k.set("availableFields",h.get("selectableFields")),ReportData.options.isCombined&&k.set("availableFieldsPossible",h.get("selectableFields")),h.observe("selectableFields",function(a){k.set("availableFields",a),ReportData.options.isCombined&&k.set("availableFieldsPossible",a)},{init:!1}),j.observe("aggregates",function(a){k.set("aggregates",a)},{init:!1}),k.render("#ar-rv-editor-groupingsorting")}).then(function(){return l=new reportAccessManager({data:x}),l.render("#ar-rv-editor-access-sharing")}).then(function(){return m=new reportScheduleManager({data:y}),m.render("#ar-rv-editor-access-scheduling")}).then(function(){return w.selectableFields=h.get("selectableFields"),w.aggregates=j.get("aggregates"),labelManager=new reportLabelManager({data:w}),h.observe("selectableFields",function(a){labelManager.set("selectableFields",a)},{init:!1}),j.observe("aggregates",function(a){labelManager.set("aggregates",a)},{init:!1}),k.observe("totalAggregates",function(a){labelManager.set("totalAggregates",a)},{init:!1}),k.observe("aggregatesAsColumn",function(a){labelManager.set("aggregatesAsColumn",a)},{init:!1}),labelManager.render("#ar-rv-editor-labels")}).then(function(){var a=!0;return(0==k.get("selectedFields").length&&0==ReportData.isCombined||0==j.get("aggregates").length)&&(a=!1),!!a&&(n=new chartTypeManager({data:{chartType:ReportData.chartType}}),n.observe("chartType",function(a){var c={el:"#ar-rv-chart-editor-labels",data:{groups:k.get("selectedFields"),aggregates:j.get("aggregates"),chartTitle:ReportData.chartTitle,fieldsByName:ReportData.fieldsByName,legend:ReportData.chartLegend,xAxis:ReportData.chartAxisX,yAxis:ReportData.chartAxisY,y2Axis:ReportData.chartAxisY2,xAxisSegment:ReportData.chartAxisXSegment,valueZones:ReportData.chartValueZones,chartSize:ReportData.chartSize,chartSizes:ReportData.chartSizes,labelName:ReportData.chartLabels,showPercents:ReportData.chartShowPercents,chartTitle:ReportData.chartTitle,showLabels:ReportData.chartShowLabels,showZoneLabels:ReportData.chartShowZoneLabels}};switch(c.legend instanceof Array||(c.legend=[c.legend]),c.yAxis instanceof Array||(c.yAxis=[c.yAxis]),a){case"gauge":c.getReportMainDataPreview=M,o=new GaugeChartLegendManager(c);break;case"funnel":o=new FunnelChartLegendManager(c);break;case"bar":o=new BarChartLegendManager(c);break;case"line":o=new LineChartLegendManager(c);break;case"combined":o=new CombinedChartLegendManager(c);break;case"pie":default:o=new PieChartLegendManager(c)}o.on("preview",b),o.observe("chartTitle",function(a){ReportData.chartTitle=a;var b=this.get("chartTitle");chartView&&chartView.set("title",b)},{init:!1})}),n.observe("chartTitle",function(a){var b=this.get("chartTitle");"undefined"!=typeof chartView&&chartView.set("title",b),o&&o.set("chartTitle",b)}),j.observe("aggregates",function(a){o.set("aggregates",a)}),k.observe("selectedFields",function(a){o.set("groups",a)}),n.render("#ar-rv-chart-editor-type"))}).then(function(a){labelManager.on("preview",e),h.on("preview",e),i.on("preview",e),k.on("preview",e),j.on("preview",e),l.on("preview",e),p.on("preview",e),q.on("preview",e),r.on("preview",e),a===!1?(jQuery("#ar-rv-chart-editor-type").append("<h3>"+translated_labels.label_chart_not_possible+"</h3>"),jQuery("#ar-rv-chart-editor-labels").append("<h3>"+translated_labels.label_chart_not_possible+"</h3>")):(n.on("preview",b),b())}).catch(function(a){console.log(a)});var J=function(){var a={filters:i.get("groups"),columns:h.get("selectedFields"),aggregates:j.get("aggregates"),grouping:JSON.parse(JSON.stringify(k.get("selectedFields"))),options:ReportData.options,totalAggregates:k.get("totalAggregates"),labels:ReportData.labels,showTop:getLimit(k),calcFields:p.get("calcFields")};if(ReportData.options.isCombined&&(a.combinedSelectedFields=k.get("combinedSelectedFields.fields")),ReportData.options.isCombined){var b=k.get("combinedSelectedFields.fields"),c=k.get("combinedSelectedFields");for(var d in b){var e=b[d];if(ReportData.fieldsByName[e]){var f={name:e,sortAction:c.sortAction,dateGrouping:c.dateGrouping,sortDirection:c.sortDirection,position:c.position};a.grouping.unshift(f)}}}return ReportData.currentResult&&ReportData.currentResult.meta&&(ReportData.currentResult.meta.limit&&(a.limit=parseInt(ReportData.currentResult.meta.limit)),ReportData.currentResult.meta.currentPage&&(a.currentPage=parseInt(ReportData.currentResult.meta.currentPage))),a},K=function(){var a,b,c=J();return n?(a=getChartObject(n.get("chartType")),b=a.prepareData(k,c.filters,c.columns,c.aggregates,JSON.parse(JSON.stringify(c.grouping)))):b={aggregates:"[]",grouping:"[]"},c.chartSettings={chartTitle:n?n.get("chartTitle"):"",chartType:n?n.get("chartType"):"pie",chartLabels:ReportData.chartLabels,chartAxisX:ReportData.chartAxisX,chartAxisY:ReportData.chartAxisY,chartAxisY2:ReportData.chartAxisY2,chartYAxisType:ReportData.chartYAxisType,chartYAxis2Type:ReportData.chartYAxis2Type,chartBars1Stacked:ReportData.chartBars1Stacked,chartBars2Stacked:ReportData.chartBars2Stacked,chartLegend:ReportData.chartLegend,chartStacked:ReportData.chartStacked,chartCumulated:ReportData.chartCumulated,chartSortableValues:ReportData.chartSortableValues,chartAggregates:cleanAggregates(JSON.parse(b.aggregates)),chartGrouping:JSON.parse(b.grouping),chartSize:ReportData.chartSize,chartHeight:ReportData.chartHeight,chartShowPercents:ReportData.chartShowPercents,chartValueZones:ReportData.chartValueZones,chartAxisXSegment:ReportData.chartAxisXSegment,chartShowLabels:ReportData.chartShowLabels,chartShowZoneLabels:ReportData.chartShowZoneLabels},c.globalSharing=l.get("globalSharing"),c.globalSharingRights=l.get("globalSharingRights"),c.userSharing=l.getSelectedAccess(),c.owner=l.get("owner"),c.isScheduled=1==m.get("isScheduled")?1:0,c.interval=m.get("interval"),c.intervalH=m.get("timeH"),c.intervalM=m.get("timeM"),c.intervalOptions=m.get("intervalOptions"),c.scheduledRecipients=m.getSelectedRecipients(),c.scheduledFormats=m.get("scheduledFormats"),ReportData.options.isCombined&&(c.combinedSelectedFields=k.get("combinedSelectedFields")),c},L=function(){var a=j.get("aggregates");ReportData.errorsAgg=-1;for(var b=0;b<a.length;b++){var c=a[b].selectedField;if(!(a[b].value.sum||a[b].value.count||a[b].value.avg)){var d=3;return ReportData.options.isCombined&&(d=2),jQuery("#ar-rv-editor-tabs").tabs("option","active",d),ReportData.errorsAgg=b,jQuery("body").trigger("aggregateError"),!1}}if(jQuery("body").trigger("aggregateError"),ReportData.options.includeDetails)ReportData.errors=-1,jQuery("body").trigger("totalTableError");else{for(var e=-1,f=ReportData.fieldGroupingSorting.length-1;f>-1;){if("row"==ReportData.fieldGroupingSorting[f].position||!ReportData.fieldGroupingSorting[f].position){e=f;break}f-=1}if(e>-1){var g=0;for(b=0;b<a.length;b++){var c=a[b].selectedField;ReportData.fieldGroupingSorting[e].showAggregates[c]?(a[b].value.sum&&!ReportData.fieldGroupingSorting[e].showAggregates[c].sum&&g++,a[b].value.count&&!ReportData.fieldGroupingSorting[e].showAggregates[c].count&&g++,a[b].value.avg&&!ReportData.fieldGroupingSorting[e].showAggregates[c].avg&&g++):g++}if(a.length==g){alert(translated_labels.label_select_one+" "+ReportData.fieldGroupingSorting[e].title);var d=4;return ReportData.options.isCombined&&(d=3),jQuery("#ar-rv-editor-tabs").tabs("option","active",d),ReportData.errors=e,jQuery("body").trigger("totalTableError"),!1}ReportData.errors=-1,jQuery("body").trigger("totalTableError")}else ReportData.errors=-1,jQuery("body").trigger("totalTableError")}var h=!1;if(ReportData.options.isCrosstab){for(f=ReportData.fieldGroupingSorting.length-1;f>-1;){if("column"==ReportData.fieldGroupingSorting[f].position){h=!0;break}f-=1}if("column"==ReportData.combinedSelectedFields.position&&(h=!0),!h)return alert(translated_labels.label_at_least_column),!1}return!0},M=function(){var a=J();return a};e=function(){if(L()){var a=M();jQuery(".ar-loading").show(),jQuery.post(ReportData.url+ReportData.id,reportUtils.convertToJSONPost(a),showData(j.get("aggregates"),k.get("selectedFields"),ReportData.options.includeDetails,h,k,q,r))}};var N=["globalSharing","globalSharingRights","owner","isScheduled","interval","intervalH","intervalM","intervalOptions","scheduledRecipients"];f=function(){if(L()){var a=K();jQuery.post(ReportData.saveUrl+ReportData.id,reportUtils.convertToJSONPost(a,N),function(a){alert(a),window.location.reload()})}},g=function(){if(L()){var a=K();a=reportUtils.convertToJSONPost(a,N),a.saveAs=1;var b='<div style="padding-top:10px;"><label>'+translated_labels.label_report_name+': <input style="width: 280px;" type="text" name="reportName" /></label><br/>';b+="<label>"+translated_labels.label_report_folder+': <select style="width: 280px;" name="reportFolder">';for(var c in report_folders)isNaN(c)||(b+="<option ",current_folder==c&&(b+='selected="selected"'),b+="value="+c+">"+report_folders[c]+"</option>");b+="</select></label><br/><br/><label>"+translated_labels.label_report_description+': <textarea style="width: 280px;" name="reportDescription"></textarea></label></div>';new SaveDataAs({data:a,partials:{modalContent:b}})}};var O=new reportButtons({el:"#reportControls",append:!0});O.on("save",f),O.on("saveAs",g),O.on("delete",function(){var a=confirm(translated_labels.label_sure_to_delete);1==a&&(window.location="index.php?module=AnalyticReporting&action=Delete&record="+ReportData.id)}),O.on("back",function(){window.location="index.php?module=AnalyticReporting&action=index"}),jQuery("#ar-rv-editor-title").click(function(){new EditTitle({data:{title:jQuery("#reportTitle").text(),description:jQuery("#reportDescription").text()},partials:{modalContent:'<div style="padding-top:10px;"><label>'+translated_labels.label_report_name+': <input style="width: 280px;" type="text" name="reportName" value="{{title}}" /></label><br/><label>'+translated_labels.label_report_description+': <textarea style="width: 280px;" name="reportDescription">{{description}}</textarea></label></div>'}})}),jQuery("#exportChartAs").live("click",function(a){a.preventDefault(),jQuery("#chart1 svg").attr("width",jQuery("#chart1 svg").width()),jQuery("#chart1 svg").attr("height",jQuery("#chart1 svg").height()),jQuery("#chart1 svg").attr("id","svg"),saveSvgAsPng(document.getElementById("svg"),"chart.png",1)}),jQuery("#addToDashboard").live("click",function(a){a.preventDefault();var b={record:ReportData.id,title:ReportData.chartTitle};jQuery.post(ReportData.addToDashboardUrl,b,function(){alert(translated_labels.label_chart_added_to_dashboard)})}),jQuery("#loadXLSX").click(function(){var a=M();return postToURL(ReportData.urlXLS+ReportData.id,reportUtils.convertToJSONPost(a)),!1}),jQuery("#loadPDF").click(function(){var a=M();return postToURL(ReportData.urlPDF+ReportData.id,reportUtils.convertToJSONPost(a)),!1}),jQuery("#printReport").click(function(){var a=jQuery("#ar-rv-chart-view > h5:first > a.toggle");a.hasClass("asc")&&a.click(),setTimeout(window.print,200)}),jQuery("#printReportChart").click(function(){var a=jQuery("#ar-rv-chart-view > h5:first > a.toggle");a.hasClass("desc")&&a.click(),setTimeout(window.print,200)})});var multiSelectDecorator=function(a,b){var c,d,e=a._ractive.root,f=!1,g={header:!1,selectedList:1,click:function(){window.setTimeout(function(){jQuery(a).multiselect("refresh")},0)}};if(jQuery(a).multiselect(g),e.observe("disableSelectBox",function(b){b?jQuery(a).multiselect("disable"):jQuery(a).multiselect("enable")},{init:!1}),a._ractive.binding){var h=function(){f||(f=!0,window.setTimeout(function(){jQuery(a).change(),jQuery(a).multiselect("refresh"),f=!1},0))};c=e.observe(a._ractive.binding.keypath,h),d=e.observe("optionGroups",h)}return jQuery(a).multiselect(g).on("change",function(){f||(f=!0,e.updateModel(),f=!1)}),{teardown:function(){jQuery(a).multiselect("destroy"),c&&(c.cancel(),d.cancel())}}},selectBoxCache={},selectBox=Ractive.extend({template:function(a){return"undefined"==typeof selectBoxCache[a.valueName+"|"+a.titleName]&&(selectBoxCache[a.valueName+"|"+a.titleName]=Ractive.parse('<select value="{{selected}}">{{#options}}<option value="{{'+a.valueName+'}}">{{'+a.titleName+"}}</option>{{/options}}</select>")),selectBoxCache[a.valueName+"|"+a.titleName]},complete:function(){if(this.data.autoSelectFirst){var a=this,b=function(b){for(var c=!1,d=0;d<b.length;d++)if(b[d][a.data.valueName]==a.data.selected){c=!0;break}!c&&b.length>0&&a.set("selected",a.data.options[0][a.data.valueName])};b(this.data.options),this.observe("options",b,{init:!1})}},data:{selected:null,options:[],titleName:"",valueName:"",autoSelectFirst:!0},modifyArrays:!1}),selectBoxImg=Ractive.extend({template:App._template("selectBoxImgTemplate"),complete:function(){var a=!1;this.data.autoSelect&&""===this.data.selected&&this.set("selected",this.data.options[0][this.data.valueName]);var b=this.find("select"),c=this;jQuery(b).ddslick({width:250,background:"transparent",imagePosition:"left",onSelected:function(b){if(a){for(var d=0,e=ReportData.selectedAggregates.length-1;e>=0;e--)ReportData.selectedAggregates[e].value.sum&&d++,ReportData.selectedAggregates[e].value.count&&d++,ReportData.selectedAggregates[e].value.avg&&d++;"Combined"!=b.selectedData.text||ReportData.fieldGroupingSorting.length>0&&d>1?(c.get("selected")!=b.selectedData.value&&jQuery("#ar-rv-chart-editor-tabs").tabs("option","active",1),c.set("selected",b.selectedData.value)):alert(translated_labels.label_chart_error)}}}),setTimeout(function(){for(var b=0,c=ReportData.selectedAggregates.length-1;c>=0;c--)ReportData.selectedAggregates[c].value.sum&&b++,ReportData.selectedAggregates[c].value.count&&b++,ReportData.selectedAggregates[c].value.avg&&b++;0==ReportData.fieldGroupingSorting.length||b<2?(jQuery(".dd-options").children()[3].style.backgroundColor="lightgrey;",jQuery(".dd-options").children()[3].children[0].backgroundColor="lightgrey;"):(jQuery(".dd-options").children()[3].backgroundColor="white;",jQuery(".dd-options").children()[3].children[0].backgroundColor="white;"),a=!0},3e3)},data:{options:[],selected:"",autoSelect:!0,id:""}}),multiSelectBox=Ractive.extend({template:App._template("multiSelectBoxTemplate"),init:function(){},complete:function(){var a=this,b=function(){var b=a.get("selected"),c=a.getDisabledValues(b),d=a.get("options"),e=a.convertData(d,"key","values","name","title",c,b),f=!1;JSON.stringify(e.options)!==JSON.stringify(a.get("optionGroups"))&&(f=!0),a.set("optionGroups",e.options).then(function(){return JSON.stringify(e.selected)===JSON.stringify(a.get("selected"))||(f=!0,a.set("selected",e.selected))}).then(function(){f&&setTimeout(function(){a.fire("selectChanged")},10)})};this.observe("options",b,{init:!1}),this.observe("selected",function(a){this.data.selected=a,b()},{init:!1}),b()},getDisabledValues:function(a){for(var b=this.get("aggregates"),c=this.get("groups"),d=[],e=!1,f=!1,g=0;g<a.length;g++){if(c.length>0)for(var h=0;h<c.length;h++)if(a[g]==c[h].name){e=!0;break}if(ReportData.options.isCombined&&"date_field"==a[g]){e=!0;break}if(b.length>0)for(var h=0;h<b.length;h++){if(b[h].value.sum&&a[g]==b[h].selectedField+"_sum"){f=!0;break}if(b[h].value.avg&&a[g]==b[h].selectedField+"_avg"){f=!0;break}if(b[h].value.count&&a[g]==b[h].selectedField+"_cnt"){f=!0;break}}}if(e){for(var g=0;g<b.length;g++)b[g].value.sum&&d.push(b[g].selectedField+"_sum"),b[g].value.avg&&d.push(b[g].selectedField+"_avg"),b[g].value.count&&d.push(b[g].selectedField+"_cnt");for(var g=0;g<a.length;g++){for(var h=0;h<c.length;h++)a[g]!=c[h].name&&d.push(c[h].name);ReportData.options.isCombined&&"date_field"!=a[g]&&d.push("date_field")}}if(f){for(var g=0;g<c.length;g++)d.push(c[g].name);ReportData.options.isCombined&&d.push("date_field")}return d},convertData:function(a,b,c,d,e,f,g){for(var h=[],i=[],j=0;j<a.length;j++){for(var k=[],l=0;l<a[j][c].length;l++){var m=!1;jQuery.inArray(a[j][c][l][d],f)!==-1&&(m=!0);var n=!1;m||jQuery.inArray(a[j][c][l][d],g)===-1||(n=!0,i.push(a[j][c][l][d])),k.push({value:a[j][c][l][d],title:a[j][c][l][e],disabled:m})}h.push({title:a[j][b],items:k})}return h={options:h,selected:i}},decorators:{multiSelect:multiSelectDecorator},data:{options:[],selected:"",optionGroups:[],disabledValues:[],disabledSelectBox:!1,groups:[],aggregates:[]}}),reportUtils={appendDateGrouping:function(a,b){return"undefined"==typeof a.cols[b]&&("undefined"!=typeof a.cols[b+"_year"]?b+="_year":"undefined"!=typeof a.cols[b+"_quarter"]?b+="_quarter":"undefined"!=typeof a.cols[b+"_quarterAndYear"]?b+="_quarterAndYear":"undefined"!=typeof a.cols[b+"_month"]?b+="_month":"undefined"!=typeof a.cols[b+"_monthAndYear"]?b+="_monthAndYear":"undefined"!=typeof a.cols[b+"_week"]?b+="_week":"undefined"!=typeof a.cols[b+"_weekAndYear"]?b+="_weekAndYear":"undefined"!=typeof a.cols[b+"_day"]&&(b+="_day")),b},generateFieldsByNameFromBlocks:function(a){for(var b={},c=0;c<a.length;c++)for(var d=0;d<a[c].fields.length;d++)b[a[c].fields[d].name]=a[c].fields[d];return b},isMultiSummaryReport:function(a,b,c,d){d=d||!1;for(var e=[],f=0;f<b.length;f++){var g=b[f],h=g.showAggregates;if("column"!=g.position||!d)for(var i=0;i<a.length;i++){var j=h[a[i].selectedField];if(j){var k=!1;j.sum&&(k=!0),j.count&&(k=!0),j.avg&&(k=!0),k&&e.push(!0)}}}return c||e.pop(),e.length>0},convertToJSONPost:function(a,b){var c={};b=b||[];for(var d=Object.keys(a),e=0;e<d.length;e++)b.indexOf(d[e])==-1?c[d[e]]=JSON.stringify(a[d[e]]):c[d[e]]=a[d[e]];return c}},NumberFormatter=function(a){var b=jQuery.extend({},{format:"",seperator:"'",decimal:".",numdec:significantDigits},a);this.format=b.format,this.decimal=b.decimal,this.seperator=b.seperator,this.numdec=b.numdec,this.countAggregateByLabel=this.getCountAggregateByLabel(),this.integerFields=this.getIntegerFields(),this.integerAggregates=this.getIntegerAggregates()};NumberFormatter.prototype.format="",NumberFormatter.prototype.decimal=".",NumberFormatter.prototype.seperator="'",NumberFormatter.prototype.makeFormatter=function(){var a=this;switch(this.format){case"123,456,789":return function(b,c,d,e,f){if(null==d)return"";if(!a.isNumber(d))return d;if(d.length&&!d[0].match("[0-9]"))return d;d=a.roundByType(d,e,f);var g=d.split("."),h="";return g.length>1&&(h=a.decimal+g[1]),g[0].length>3&&(g[0]=a.by3(g[0])),g[0]+h};case"12,34,56,789":return function(b,c,d,e,f){if(null==d)return"";if(!a.isNumber(d))return d;if(d.length&&!d[0].match("[0-9]"))return d;d=a.roundByType(d,e,f);var g=d.split("."),h="";return g.length>1&&(h=a.decimal+g[1]),g[0].length>3&&(g[0]=a.by3then2(g[0])),g[0]+h};case"123456,789":return function(b,c,d,e,f){if(null==d)return"";if(!a.isNumber(d))return d;if(d.length&&!d[0].match("[0-9]"))return d;d=a.roundByType(d,e,f);var g=d.split("."),h="";return g.length>1&&(h=a.decimal+g[1]),g[0].length>3&&(g[0]=a.first3(g[0])),g[0]+h};case"123456789":default:return function(b,c,d,e,f){if(null==d)return"";if(!a.isNumber(d))return d;if(d.length&&!d[0].match("[0-9]"))return d;d=a.roundByType(d,e,f);var g=d.split("."),h="";return g.length>1&&(h=a.decimal+g[1]),g[0].length>3&&(g[0]=a.noFormat(g[0])),g[0]+h}}},NumberFormatter.prototype.noFormat=function(a){return a},NumberFormatter.prototype.by3=function(a){for(var b=a.split("").reverse(),c=[],d=1;d<b.length;d++)c.push(b[d-1]),d%3==0&&c.push(this.seperator);return c.push(b[b.length-1]),c.reverse().join("")},NumberFormatter.prototype.by3then2=function(a){for(var b=a.split("").reverse(),c=[],d=1;d<b.length&&d<4;d++)c.push(b[d-1]),d%3==0&&c.push(this.seperator);for(var d=4;d<b.length;d++)c.push(b[d-1]),d-4&&(d-1)%2==0&&c.push(this.seperator);return c.push(b[b.length-1]),c.reverse().join("")},NumberFormatter.prototype.first3=function(a){var b=a.split(""),c=b.splice(-3,3);return b.length>0&&(c=b.join("")+this.seperator+c.join("")),c},NumberFormatter.prototype.isNumber=function(a){return!isNaN(parseFloat(a))&&isFinite(a)},NumberFormatter.prototype.isCountAggregate=function(a,b){var c=a.substr(a.lastIndexOf("_")+1),d=["sum","min","max","avg"];if("cnt"==c||"ctn"==b)return!0;if(d.indexOf(c)>-1)return!1;if("undefined"!=typeof b&&ReportData.options.aggregateColumn)return!!b.aggregates&&this.countAggregateByLabel.indexOf(b.aggregates)>-1;for(var e=0;e<ReportData.selectedAggregates.length;e++)if(a.indexOf(ReportData.selectedAggregates[e].selectedField)>-1)return ReportData.selectedAggregates[e].value.count;return!1},NumberFormatter.prototype.getIntegerFields=function(){for(var a=[],b=0;b<ReportData.availableFields.length;b++)for(var c=0;c<ReportData.availableFields[b].fields.length;c++)"integer"==ReportData.availableFields[b].fields[c].type&&a.push(ReportData.availableFields[b].fields[c].name);return a},NumberFormatter.prototype.getIntegerAggregates=function(){for(var a=[],b=0;b<ReportData.selectedAggregates.length;b++){var c=ReportData.selectedAggregates[b];this.integerFields.indexOf(c.selectedField)>-1&&(c.value.sum&&a.push(ReportData.labels[c.selectedField+"_sum"]),c.value.max&&a.push(ReportData.labels[c.selectedField+"_max"]),c.value.min&&a.push(ReportData.labels[c.selectedField+"_min"]))}return a},NumberFormatter.prototype.getCountAggregateByLabel=function(){var a=[];for(var b in ReportData.labels)ReportData.labels.hasOwnProperty(b)&&"_cnt"==b.substr(b.length-4)&&a.push(ReportData.labels[b]);return a},NumberFormatter.prototype.isIntegerType=function(a,b){if("undefined"!=typeof b&&ReportData.options.aggregateColumn)return this.integerAggregates.indexOf(b.aggregates)>-1;
for(var c=0;c<this.integerFields.length;c++)if(a.indexOf("_avg")<0&&a.indexOf(this.integerFields[c])>-1)return!0},NumberFormatter.prototype.roundByType=function(a,b,c){return"undefined"!=typeof b&&(this.isCountAggregate(b.field,c)||this.isIntegerType(b.field,c))&&"avg"!=c?(Math.round(100*parseFloat(a))/100).toFixed(0):Number(Math.round(a+"e+"+this.numdec)+"e-"+this.numdec).toFixed(this.numdec)};var validateXAxis=function(a){for(var b=this.get("availableGroups"),c=!1,d=0;d<b.length;d++)if(a==b[d].name){c=!0;break}var e=a;c||b.length>0&&(e=b[0].name,that.set("xAxis",e)),ReportData.chartAxisX=e},reportBtn=Ractive.extend({template:'<a href="javascript:void(0);" class="ar-button {{className}}" on-click="clicked">{{text}}</a>',data:{text:"",className:""}}),reportBtnGC=Ractive.extend({template:'<a href="javascript:void(0);" on-click="clicked" class="tooltipX"><img src="modules/AnalyticReporting/assets/img/cross_g.png"/><span>{{text}}</span></a>',data:{text:""}}),includeDetails=Ractive.extend({template:'<label style="vertical-align:middle;"><input class="includeDetailsCheckbox" type="checkbox" on-change="changed" checked="{{checked}}" /> {{text}}</label> (<a onclick="pop_include_details();" class="tooltipX" href="#">?<span>'+translated_labels.label_tooltip_msg_1+"</span></a>)",init:function(){var a=this;this.observe("checked",function(a){ReportData.options.includeDetails=a,jQuery("body").trigger("includedDetails")}),jQuery("body").on("includedDetails",function(){a.set("checked",ReportData.options.includeDetails)}),this.observe("isCrosstab",function(b){1==ReportData.options.isCrosstab&&a.set("checked",!1)})},data:{text:translated_labels.label_include_details,checked:ReportData.options.includeDetails}}),isCrosstab=Ractive.extend({template:'<label style="vertical-align:middle;"><input id="isCrosstabCheckbox" type="checkbox" checked="{{val}}" /> {{text}}</label> (<a onclick="pop_crosstab();" class="tooltipX" href="#">?<span>'+translated_labels.label_tooltip_msg_2+'</span></a>) {{#val}}<label style="vertical-align:middle;"><input type="checkbox" checked="{{aggregatesAsColumnVal}}" /> {{textCol}}</label><!-- (<a onclick="pop_aggregates_as_column();" class="tooltipX" href="#">?<span>'+translated_labels.label_tooltip_msg_3+"</span></a>)-->{{/val}}",init:function(){var a=this;this.observe("val",function(a){ReportData.options.isCrosstab=a,a?(ReportData.options.includeDetails=!1,jQuery("body").trigger("includedDetails")):this.set("aggregatesAsColumnVal",!1)}),this.observe("aggregatesAsColumnVal",function(a){ReportData.options.aggregateColumn=a}),jQuery("body").on("includedDetails",function(){1==ReportData.options.includeDetails&&a.set("val",!1)})},data:{text:translated_labels.label_is_crosstab,textCol:translated_labels.label_aggregates_as_column,val:ReportData.options.isCrosstab,aggregatesAsColumnVal:!!ReportData.options.aggregateColumn&&ReportData.options.aggregateColumn}}),reportButtons=Ractive.extend({template:App._template("reportButtonsTemplate"),components:{reportBtn:reportBtn}}),reportButtonPreview=Ractive.extend({template:'<reportBtn text="'+translated_labels.label_preview+'" on-clicked="preview" className="green"/> <img class="ar-loading" src="modules/AnalyticReporting/assets/css/select2-spinner.gif" alt="Loading..." />',components:{reportBtn:reportBtn}}),SaveDataAs=Ractive.extend({el:jQuery("#modalWindow"),append:!1,template:"{{>modalContent}}",data:{},init:function(){data=this.data,jQuery("#modalWindow").dialog({modal:!0,draggable:!1,resizable:!1,title:translated_labels.label_save_report_as,buttons:[{text:translated_labels.label_save,click:function(){var a=this,b=jQuery(this).find("[name=reportName]").val(),c=jQuery(this).find("[name=reportDescription]").val(),d=jQuery(this).find("[name=reportFolder]").val();data.title=b,data.description=c,data.reportFolder=d,jQuery.post(ReportData.saveUrl+ReportData.id,data,function(b){b=JSON.parse(b),ReportData.id=b.id,jQuery(a).dialog("close"),window.location="index.php?module=AnalyticReporting&action=report&record="+ReportData.id})}},{text:translated_labels.label_cancel,click:function(){jQuery(this).dialog("close")}}]})}}),EditTitle=Ractive.extend({el:jQuery("#modalWindow"),append:!1,template:"{{>modalContent}}",data:{},init:function(){var a=this.data;jQuery("#modalWindow").dialog({modal:!0,draggable:!1,resizable:!1,title:"   ",buttons:[{text:translated_labels.label_save,click:function(){var b=jQuery(this).find("[name=reportName]").val(),c=jQuery(this).find("[name=reportDescription]").val();a.title=b,a.description=c,a.changeTitle=1,jQuery("#reportTitle").text(b),jQuery("#reportDescription").text(c),jQuery(this).dialog("close"),jQuery.post(ReportData.saveUrl+ReportData.id,a,function(){})}},{text:translated_labels.label_cancel,click:function(){jQuery(this).dialog("close")}}]})}}),reportLabelManager=Ractive.extend({template:App._template("reportLabelsTemplate"),init:function(){var a=this;ReportData.labels&&a.set("labels",this.transformToArray(ReportData.labels)),a.observe("selectableFields",function(b){a.set("labels",a.buildLabels(b,!1,!1,!1))}),a.observe("aggregates",function(b){a.set("labels",a.buildLabels(!1,b,!1,!1))}),a.observe("totalAggregates",function(b){a.set("labels",a.buildLabels(!1,!1,b,!1))}),a.observe("aggregatesAsColumn",function(b){a.set("labels",a.buildLabels(!1,!1,!1,b))}),a.observe("labels",function(b){ReportData.labels=a.transformToObject(b)},{init:!1})},buildLabels:function(a,b,c,d){var e=this,f=[],g=e.get("fieldsByName");a=a||e.get("selectableFields"),b=b||e.get("aggregates"),c=c||e.get("totalAggregates"),d=d||e.get("aggregatesAsColumn");for(var h=0;h<a.length;h++){var i=a[h],j=i.bareTitle,k="";if("00_ALL_assigned_user_id"!=i.name&&(k="Calculated","__virtual__"!==i.table&&(k=i.title.match(/\(([^)]+)\)/)[1])),e.get("isCombined")&&k.length>0)var j=k+" "+i.bareTitle;var l=j,m=e.findLabelsValueByKey(i.name);m&&(l=m);var n={key:i.name,value:l,origValue:j};f.push(n)}for(var h=0;h<b.length;h++)for(var o=[{name:"sum",label:translated_labels.label_sum,isSet:b[h].value.sum},{name:"cnt",label:translated_labels.label_count,isSet:b[h].value.count},{name:"avg",label:translated_labels.label_average,isSet:b[h].value.avg}],p=0;p<o.length;p++)if(o[p].isSet){var i=g[b[h].selectedField],k="Calculated";"__virtual__"!==i.table&&(k=i.title.match(/\(([^)]+)\)/)[1]);var q=i.bareTitle,r=b[h].selectedField+"_"+o[p].name,j=o[p].label+"("+q+")";e.get("isCombined")&&(j=k+" "+j);var l=j,m=e.findLabelsValueByKey(r);m&&(l=m);var n={key:r,value:l,origValue:j};f.push(n)}var s=!1;for(_ag in c){var t=c[_ag];if(t.count||t.sum||t.avg){s=!0;break}}if(s){var r="grandTotal",j=translated_labels.label_grand_total,l=j,m=e.findLabelsValueByKey(r);m&&(l=m);var n={key:r,value:l,origValue:j};f.push(n)}if(e.get("isCombined")){var r="date_field",j=translated_labels.label_date,l=j,m=e.findLabelsValueByKey(r);m&&(l=m);var n={key:r,value:l,origValue:j};f.push(n)}if(d){var r="aggregates",j=translated_labels.label_aggregates,l=j,m=e.findLabelsValueByKey(r);m&&(l=m);var n={key:r,value:l,origValue:j};f.push(n)}return f},findLabelsValueByKey:function(a){for(var b=this,c=b.get("labels"),d=0;d<c.length;d++)if(c[d].key==a)return c[d].value;return!1},findValueByKey:function(a){for(var b=this,c=b.get("aggregates"),d=b.get("selectableFields"),e=0;e<c.length;e++)if(c[e].selectedField==a)return c[e].bareTitle;for(var e=0;e<d.length;e++)if(d[e].fields){var f=d[e].fields.length;if(f>0)for(var g=0;g<f;g++){var h=d[e].fields[g];if(h.name==a)return h.bareTitle}}return!1},transformToObject:function(a){for(var b={},c=0;c<a.length;c++)b[a[c].key]=a[c].value;return b},transformToArray:function(a){var b=this,c=[];for(var d in a){var e=b.findValueByKey(d);e||(e=a[d]);var f={key:d,value:a[d],origValue:e};c.push(f)}return c},data:{labels:[],selectableFields:[],aggregates:[],fieldsByName:{},aggregatesAsColumn:!1,totalAggregates:[],isCombined:!1},components:{reportButtonPreview:reportButtonPreview},modifyArrays:!1}),fieldSelector=Ractive.extend({template:'<select value="{{selectedField}}" decorator="select2:filter">{{{fieldHTML}}}</select>',data:{selectedField:"",fieldHTML:""}}),fieldConnector=Ractive.extend({template:'<selectBox selected="{{connector}}" options="{{connectors}}" titleName="title" valueName="name" />',data:{connectors:[{name:"AND",title:translated_labels.label_and},{name:"OR",title:translated_labels.label_or}],connector:"AND"},components:{selectBox:selectBox}}),fieldCondition=Ractive.extend({template:'<selectBox class="sortGroup" selected="{{condition}}" options="{{ filterConditions (fieldType ) }}" titleName="title" valueName="type"/>',init:function(){this.observe("fieldType",function(){})},conditions:[{title:translated_labels.label_is,type:"eq",fieldtype:["txt","select","number","integer","date","datetime","time","user"]},{title:translated_labels.label_isnt,type:"neq",fieldtype:["txt","select","number","integer","date","datetime","time","user"]},{title:translated_labels.label_contains,type:"cont",fieldtype:["txt","select","user"]},{title:translated_labels.label_doesnt_contain,type:"ncont",fieldtype:["txt","select","user"]},{title:translated_labels.label_starts_with,type:"start",fieldtype:["txt"]},{title:translated_labels.label_ends_with,type:"end",fieldtype:["txt"]},{title:translated_labels.label_is_empty,type:"empty",fieldtype:["txt","select","number","integer","date","datetime","time","user"]},{title:translated_labels.label_isnt_empty,type:"filled",fieldtype:["txt","select","number","integer","date","datetime","time","user"]},{title:translated_labels.label_is_before,type:"before",fieldtype:["date","datetime"]},{title:translated_labels.label_is_after,type:"after",fieldtype:["date","datetime"]},{title:translated_labels.label_between,type:"between",fieldtype:["date","datetime"]},{title:translated_labels.label_not_between,type:"nbetween",fieldtype:["date","datetime"]},{title:translated_labels.label_today,type:"today",fieldtype:["date","datetime"]},{title:translated_labels.label_tomorrow,type:"tomorrow",fieldtype:["date","datetime"]},{title:translated_labels.label_tomorrow_onwards,type:"aftert",fieldtype:["date","datetime"]},{title:translated_labels.label_yesterday,type:"yesterday",fieldtype:["date","datetime"]},{title:translated_labels.label_until_yesterday,type:"tilly",fieldtype:["date","datetime"]},{title:translated_labels.label_next_days,type:"ndays",fieldtype:["date","datetime"]},{title:translated_labels.label_passed_days,type:"pdays",fieldtype:["date","datetime"]},{title:translated_labels.label_greater_than_days,type:"gtdays",fieldtype:["date","datetime"]},{title:translated_labels.label_less_than_days,type:"ltdays",fieldtype:["date","datetime"]},{title:translated_labels.label_this_week,type:"tweek",fieldtype:["date","datetime"]},{title:translated_labels.label_last_week,type:"lweek",fieldtype:["date","datetime"]},{title:translated_labels.label_this_month,type:"tmonth",fieldtype:["date","datetime"]},{title:translated_labels.label_last_month,type:"lmonth",fieldtype:["date","datetime"]},{title:translated_labels.label_this_year,type:"tyear",fieldtype:["date","datetime"]},{title:translated_labels.label_last_year,type:"lyear",fieldtype:["date","datetime"]},{title:translated_labels.label_next_quarter,type:"nquarter",fieldtype:["date","datetime"]},{title:translated_labels.label_last_quarter,type:"lquarter",fieldtype:["date","datetime"]},{title:translated_labels.label_next_week,type:"nweek",fieldtype:["date","datetime"]},{title:translated_labels.label_greater_than,type:"gt",fieldtype:["number","integer"]},{title:translated_labels.label_less_than,type:"lt",fieldtype:["number","integer"]},{title:translated_labels.label_eqgreater_than,type:"egt",fieldtype:["number","integer"]},{title:translated_labels.label_eqless_than,type:"elt",fieldtype:["number","integer"]},{title:translated_labels.label_checked,type:"checked",fieldtype:["checkbox"]},{title:translated_labels.label_unchecked,type:"unchecked",fieldtype:["checkbox"]},{title:translated_labels.label_currentuser,type:"assignedto",fieldtype:["user"]}],data:{filterConditions:function(a){for(var b=[],c=0;c<this.conditions.length;c++)this.conditions[c].fieldtype.indexOf(a)>-1&&b.push(this.conditions[c]);return b},condition:"",fieldType:""},components:{selectBox:selectBox}}),fieldFilterValue=Ractive.extend({template:App._template("fieldFilterValueTemplate"),init:function(){this.observe("fieldType",function(a,b){a!==b&&this.set("value",[])},{init:!1}),this.observe("condition",function(a,b){("ndays"==a&&"ndays"!=b||"pdays"==a&&"pdays"!=b||"gtdays"==a&&"gtdays"!=b||"ltdays"==a&&"ltdays"!=b||"ndays"!=a&&"ndays"==b||"pdays"!=a&&"pdays"==b||"gtdays"!=a&&"gtdays"==b||"ltdays"!=a&&"ltdays"==b)&&this.set("value",[])},{init:!1})},data:{fieldType:"",condition:"",value:[],timeValues:{minutes:[{name:"00"},{name:"10"},{name:"20"},{name:"30"},{name:"40"},{name:"50"}],hours:[{name:"1"},{name:"2"},{name:"3"},{name:"5"},{name:"5"},{name:"6"},{name:"7"},{name:"8"},{name:"9"},{name:"10"},{name:"11"},{name:"12"}],AmPm:[{name:"AM"},{name:"PM"}]}},decorators:{datepicker:function(a){var b=this;return jQuery(a).datepicker({dateFormat:"yy-mm-dd",firstDay:1,onSelect:function(){b.set(a._ractive.binding.keypath,this.value)}}),{teardown:function(){}}}},components:{selectBox:selectBox}}),filterRule=Ractive.extend({template:App._template("filterRuleTemplate"),beforeInit:function(a){var b=this.generateFieldsByName(a.data.blocks);a.data.fieldsByName=b},generateFieldsByName:reportUtils.generateFieldsByNameFromBlocks,init:function(){this.observe("fieldName",function(a){this.set("fieldType",this.data.fieldsByName[a].type),"select"==this.data.fieldsByName[a].type&&this.set("availableValues",this.data.fieldsByName[a].availableValues)}),this.observe("blocks",function(){this.set("fieldsByName",this.generateFieldsByName(this.get("blocks")))}),this.observe("sequence",function(){var a=this.get("sequence");0==a&&this.set("connector","AND")}),this.on("delete",function(a,b){this.fire("deleteRule",b)})},data:{connector:"AND",blocks:[],fieldType:"",condition:"",fieldName:"",value:[],sequence:0,availableValues:[]},components:{fieldConnector:fieldConnector,fieldSelector:fieldSelector,fieldCondition:fieldCondition,fieldFilterValue:fieldFilterValue}}),filterRuleGroup=Ractive.extend({template:App._template("filterRuleGroupTemplate"),init:function(){this.on("ruleDeleted",function(a){var b=this.get("filters");b.splice(a,1),this.set("filters",b)}),this.observe("sequence",function(){var a=this.get("sequence");0==a&&this.set("connector","AND")}),this.on("delete",function(a,b){this.fire("deleteGroup",b)})},data:{blocks:[],connector:"AND",filters:[],sequence:0,canDelete:!1},components:{filterRule:filterRule,fieldConnector:fieldConnector}}),reportFilterManager=Ractive.extend({template:App._template("reportFilterManagerTemplate"),components:{filterRuleGroup:filterRuleGroup,reportButtons:reportButtons,reportButtonPreview:reportButtonPreview,reportBtn:reportBtn,reportBtnGC:reportBtnGC,includeDetails:includeDetails},beforeInit:function(a){a.data.fieldHTML="";for(var b=0;b<a.data.blocks.length;b++)if(a.data.blocks[b].fields&&a.data.blocks[b].fields.length>0){a.data.fieldHTML+='<optgroup label="'+a.data.blocks[b].title+'">';for(var c=0;c<a.data.blocks[b].fields.length;c++)a.data.fieldHTML+='<option value="'+a.data.blocks[b].fields[c].name+'"> '+a.data.blocks[b].fields[c].title+"</option>";a.data.fieldHTML+="</optgroup>"}return a},init:function(){this.on("groupDeleted",function(a){var b=this.get("groups");b.splice(a,1),this.set("groups",b)}),this.on("addFilter",function(){var a=this.get("groups"),b=a.length-1;a[b].filters.push({connector:"AND",condition:"neq",fieldName:this.data.blocks[0].fields[0].name,value:[]}),this.set("groups",a)}),this.on("addGroup",function(){var a=this.get("groups");a.push({connector:"AND",filters:[{connector:"AND",condition:"neq",fieldName:"",value:[]}]}),this.set("groups",a)})}}),reportFieldManager=Ractive.extend({template:App._template("reportFieldManagerTemplate"),data:{blocks:[],selectedFields:[],fieldsByName:[],filter:"",markedFields:[],markedFieldsSelected:[]},init:function(){var a=this;this.on("selectField",function(b){b.original.preventDefault();for(var c=a.get("markedFields"),d=a.get("selectedFields"),e=0;e<c.length;e++)d.push(c[e]);a.set("markedFields",[]),a.set("selectedFields",d),a.set("markedFieldsSelected",c)}),this.on("removeField",function(b){b.original.preventDefault();for(var c=a.get("markedFieldsSelected"),d=a.get("selectedFields"),e=0;e<c.length;e++){var f=d.indexOf(c[e]);d.splice(f,1)}a.set("selectedFields",d)}),this.on("moveUp",function(b){b.original.preventDefault();for(var c=a.get("selectedFields"),d=a.get("markedFieldsSelected"),e=0,f=0;f<d.length;f++){var g=c.indexOf(d[f]);if(g>e){var h=c.splice(g,1);c.splice(g-1,0,h[0])}else e++}a.set("selectedFields",c)}),this.on("moveDown",function(b){b.original.preventDefault();for(var c=a.get("selectedFields"),d=a.get("markedFieldsSelected"),e=c.length-1,f=d.length-1;f>-1;f--){var g=c.indexOf(d[f]);if(g<e){var h=c.splice(g,1);c.splice(g+1,0,h[0])}else e--}a.set("selectedFields",c)})},computed:{filteredBlocks:function(){var a=this.get("filter").toLowerCase(),b=JSON.parse(JSON.stringify(this.get("blocks"))),c=this.get("selectedFields"),d=b.filter(function(b){return b.fields=b.fields.filter(function(b){return(!a||b.title.toLowerCase().match(a))&&!(c.indexOf(b.name)>-1)}),!!b.fields.length});return d},selectableFields:function(){for(var a=this.get("fieldsByName"),b=this.get("selectedFields"),c=[],d=0;d<b.length;d++)"undefined"!=typeof a[b[d]]&&c.push(a[b[d]]);return c}},modifyArrays:!1,components:{reportButtonPreview:reportButtonPreview,includeDetails:includeDetails}}),reportAggregate=Ractive.extend({template:App._template("reportAggregateTemplate"),init:function(){this.observe("selectedField",function(a){this.set("title",this.data.fieldsByName[a].title),this.set("bareTitle",this.data.fieldsByName[a].bareTitle),"number"==this.data.fieldsByName[a].type||"integer"==this.data.fieldsByName[a].type?this.set("notNumeric",!1):(this.set("notNumeric",!0),this.set("value.sum",!1),this.set("value.avg",!1)),"__virtual__"==this.data.fieldsByName[a].table?(this.set("value.sum",!0),this.set("value.count",!1),this.set("virtual",!0)):this.set("virtual",!1)}),this.on("remove",function(a){a.original.preventDefault(),this.fire("deleteAggregate",this.get("seq"))});var a=this;jQuery("body").on("aggregateError",function(b){a.set("invalidAggregate",ReportData.errorsAgg)})},data:{availableFields:[],fieldsByName:{},selectedField:"",value:{sum:!1,count:!1,avg:!1},notNumeric:!1,title:"",bareTitle:"",invalidAggregate:[],virtual:!1},components:{selectBox:selectBox},modifyArrays:!1}),reportAggregateManager=Ractive.extend({template:App._template("reportAggregateManagerTemplate"),data:{aggregates:[],availableFields:[],fieldsByName:{}},components:{reportAggregate:reportAggregate,reportButtonPreview:reportButtonPreview,reportBtnGC:reportBtnGC,includeDetails:includeDetails},init:function(){this.on("addAggregate",function(a){a.original.preventDefault(),this.push("aggregates",{selectedField:this.data.availableFields?this.data.availableFields[0].name:"",title:this.data.availableFields?this.data.availableFields[0].title:"",value:{sum:!1,count:!0,avg:!1}})}),this.on("deleteAggregate",function(a){this.splice("aggregates",a,1)})},modifyArrays:!1}),totalTable=Ractive.extend({template:App._template("totalTableTemplate"),init:function(){var a=this,b=function(){var b,c,d,e=a.get("selectedFields"),f=a.get("aggregates"),g=a.get("totalAggregates"),h=!1,i={},j=f.map(function(a){return i[a.selectedField]=a.value,a.selectedField});for(b=0;b<e.length;b++){for(e[b].showAggregates||(e[b]={}),d=Object.keys(e[b].showAggregates),c=0;c<d.length;c++)j.indexOf(d[c])<0?(h=!0,delete e[b].showAggregates[d[c]]):(!i[d[c]].sum&&e[b].showAggregates[d[c]].sum&&(h=!0,delete e[b].showAggregates[d[c]].sum),!i[d[c]].avg&&e[b].showAggregates[d[c]].avg&&(h=!0,delete e[b].showAggregates[d[c]].avg),!i[d[c]].count&&e[b].showAggregates[d[c]].count&&(h=!0,delete e[b].showAggregates[d[c]].count));for(d=Object.keys(e[b].showAggregates),c=0;c<j.length;c++)d.indexOf(j[c])<0&&(h=!0,e[b].showAggregates[j[c]]={count:!0,sum:!0,avg:!0},setTimeout(function(){a.data.selectedFields[b]&&a.set("selectedFields["+b+"].showAggregates."+j[c],{count:!0,sum:!0,avg:!0})},0))}for(h&&a.set("selectedFields",e),d=Object.keys(g),b=0;b<d.length;b++)j.indexOf(d[b])<0&&(h=!0,delete g[d[b]]);for(d=Object.keys(g),b=0;b<j.length;b++)d.indexOf(j[b])<0&&(h=!0,g[j[b]]={count:!1,sum:!1,avg:!1});h&&a.set("totalAggregates",g)};this.observe("aggregates",b,{init:!1}),this.observe("selectedFields",b,{init:!1}),b(),jQuery("body").on("totalTableError",function(b){a.set("errorAggregates",ReportData.errors)})},data:{selectedFields:[],fieldsByName:{},totalAggregates:{},aggregates:[],addonTitle:function(a,b,c){var d="";return c.dateGrouping&&(d=" ("+capitalize(c.dateGrouping)+")"),d},errorAggregates:null},modifyArrays:!1}),sortingByField=Ractive.extend({template:App._template("sortingByFieldTemplate"),init:function(){var a=this;this.on("delete",function(b,c){a.fire("deleted",c)}),jQuery("body").on("includedDetails",function(){a.set("canSort",ReportData.options.includeDetails)}),this.observe("isCrosstab",function(b){a.set("canSort",ReportData.options.includeDetails)})},complete:function(){var a=this;this.observe("isDate",function(b){b||a.set("dateGrouping","")}),this.observe("canSort",function(b,c,d){a.get("sortOptions").length>1?1==b?a.set("sortOptions",[{name:"sort",title:translated_labels.label_sort},{name:"group",title:translated_labels.label_group},{name:"groupsort",title:translated_labels.label_group_sort}]):a.set("sortOptions",[{name:"groupsort",title:translated_labels.label_group_sort},{name:"group",title:translated_labels.label_group}]):0==b&&a.set("sortOptions",[{name:"groupsort",title:translated_labels.label_group_sort},{name:"group",title:translated_labels.label_group}])}),this.observe("canSortParam",function(b,c,d){b&&(1==a.get("canSort")?a.set("sortOptions",[{name:"sort",title:translated_labels.label_sort},{name:"group",title:translated_labels.label_group},{name:"groupsort",title:translated_labels.label_group_sort}]):a.set("sortOptions",[{name:"groupsort",title:translated_labels.label_group_sort},{name:"group",title:translated_labels.label_group}]))})},data:{sortOptions:[{name:"sort",title:translated_labels.label_sort},{name:"group",title:translated_labels.label_group},{name:"groupsort",title:translated_labels.label_group_sort}],sortDirections:[{name:"ASC",title:translated_labels.label_ascending},{name:"DESC",title:translated_labels.label_descending}],isCombined:ReportData.options.isCombined,fieldsByName:{},dateOptions:[{name:"day",title:translated_labels.label_day},{name:"week",title:translated_labels.label_week},{name:"weekAndYear",title:translated_labels.label_week_and_year},{name:"month",title:translated_labels.label_month},{name:"monthAndYear",title:translated_labels.label_month_and_year},{name:"quarter",title:translated_labels.label_quarter},{name:"quarterAndYear",title:translated_labels.label_quarter_and_year},{name:"year",title:translated_labels.label_year}],positions:[{name:"row",title:translated_labels.label_row},{name:"column",title:translated_labels.label_column}],canSort:ReportData.options.includeDetails,canOnlySort:!1,position:null,transform:!0,showAggregates:{},showTop:""},computed:{hasAggregates:function(){for(var a=this.get("showAggregates"),b=Object.keys(a),c=!1,d=0;d<b.length;d++)if(a[b[d]].sum||a[b[d]].avg||a[b[d]].count){c=!0;break}return c},getAggregates:function(){var a=this.get("showAggregates"),b=this.get("fieldsByName"),c=this.get("name"),d=this.get("isCombined"),e=Object.keys(a),f="";b[c]&&(f=b[c].bareTitle);var g=[{name:c,title:f}];if(!d)for(var h=0;h<e.length;h++)b[e[h]]&&(a[e[h]].sum&&g.push({name:"sum_"+e[h],title:translated_labels.label_sum+"("+b[e[h]].bareTitle+")"}),a[e[h]].count&&g.push({name:"count_"+e[h],title:translated_labels.label_count+"("+b[e[h]].bareTitle+")"}),a[e[h]].avg&&g.push({name:"avg_"+e[h],title:translated_labels.label_average+"("+b[e[h]].bareTitle+")"}));return g},isDate:function(){var a=!1,b=this.get("fieldsByName"),c=b[this.get("name")];return!c||"date"!=c.type&&"datetime"!=c.type||(a=!0),a},isMultiSelect:function(){var a=!1,b=this.get("fieldsByName"),c=b[this.get("name")];return c&&33==c.uitype&&(a=!0),a}},components:{selectBox:selectBox},modifyArrays:!1}),sortingByCombinedField=Ractive.extend({template:App._template("sortingByCombinedFieldTemplate"),init:function(){var a=this;this.observe("selectedValue",function(b){var c=a.get("seq");ReportData.combinedSelectedFields.fields[c]=b})},data:{sortDirections:[{name:"ASC",title:translated_labels.label_ascending},{name:"DESC",title:translated_labels.label_descending}],dateOptions:[{name:"day",title:translated_labels.label_day},{name:"week",title:translated_labels.label_week},{name:"weekAndYear",title:translated_labels.label_week_and_year},{name:"month",title:translated_labels.label_month},{name:"monthAndYear",title:translated_labels.label_month_and_year},{name:"quarter",title:translated_labels.label_quarter},{name:"quarterAndYear",title:translated_labels.label_quarter_and_year},{name:"year",title:translated_labels.label_year}],positions:[{name:"row",title:translated_labels.label_row},{name:"column",title:translated_labels.label_column}],position:null,fields:[],selectedValue:""},components:{selectBox:selectBox},modifyArrays:!1}),sortingBy=Ractive.extend({template:App._template("sortingByTemplate"),beforeInit:function(a){for(var b=0;b<a.data.selectedFields.length;b++)"undefined"==typeof a.data.selectedFields[b].transform&&(a.data.selectedFields[b].transform=null);return a},init:function(){var a=this,b=function(){var b=a.get("availableFields");a.set("fields",b)};b(),this.observe("blocks",b),this.observe("availableFields",b),this.on("updateField",function(a){for(var b=0;b<this.data.fields.length;b++)if(this.data.fields[b].name==a.field){this.set("selectedFields."+a.seq+".title",this.data.fields[b].title);break}}),this.on("deleteSort",function(a){var b=this.get("selectedFields");b.splice(a,1),this.set("selectedFields",b)})},data:{blocks:[],sortOptions:[{name:"sort",title:translated_labels.label_sort},{name:"group",title:translated_labels.label_group},{name:"groupsort",title:translated_labels.label_group_sort}],fields:[],availableFields:[],aggregates:[],selectedFields:[],canSort:ReportData.options.includeDetails,isCrosstab:ReportData.options.isCrosstab,isCombined:ReportData.options.isCombined,excluded:[]},components:{sortingByField:sortingByField},modifyArrays:!1}),sortingByCombined=Ractive.extend({template:App._template("sortingByCombinedTemplate"),init:function(){var a=this;this.set("combinedModulesCount",ReportData.combinedModules.length);var b=function(){for(var b={},c=a.get("availableFields"),d=!0,e=0;e<c.length;e++){var f=c[e];("datetime"==f.type||"date"==f.type)&&ReportData.combinedModules.indexOf(parseInt(f.moduleId))>-1&&("undefined"==typeof b[f.moduleId]&&(b[f.moduleId]=[]),d&&(b[f.moduleId].isFirst=!0),b[f.moduleId].push(f),d=!1)}a.set("combinedFields",b)};b(),this.observe("combinedSelectedFields.sortDirection",function(a){this._parent.set("combinedSelectedFields.sortDirection",a)}),this.observe("availableFields",b,{init:!1}),this.observe("combinedSelectedFields.sortAction",function(a){this.set("combinedSelectedFields.sortAction",a),this._parent.set("combinedSelectedFields.sortAction",a)}),this.observe("combinedSelectedFields",function(a){ReportData.combinedSelectedFields=a})},data:{isCombined:ReportData.options.isCombined,combinedModules:ReportData.combinedModules,combinedFields:[],availableFields:[],combinedSelectedFields:ReportData.combinedSelectedFields,sortOptions:[{name:"groupsort",title:translated_labels.label_group_sort},{name:"group",title:translated_labels.label_group},{name:"nogroup",title:translated_labels.label_dont_group}],sortDirections:[{name:"ASC",title:translated_labels.label_ascending},{name:"DESC",title:translated_labels.label_descending}],dateOptions:ReportData.options.isCombined?[{name:"day",title:translated_labels.label_day},{name:"weekAndYear",title:translated_labels.label_week_and_year},{name:"monthAndYear",title:translated_labels.label_month_and_year},{name:"quarterAndYear",title:translated_labels.label_quarter_and_year},{name:"year",title:translated_labels.label_year}]:[{name:"day",title:translated_labels.label_day},{name:"week",title:translated_labels.label_week},{name:"weekAndYear",title:translated_labels.label_week_and_year},{name:"month",title:translated_labels.label_month},{name:"monthAndYear",title:translated_labels.label_month_and_year},{name:"quarter",title:translated_labels.label_quarter},{name:"quarterAndYear",title:translated_labels.label_quarter_and_year},{name:"year",title:translated_labels.label_year}],positions:[{name:"row",title:translated_labels.label_row},{name:"column",title:translated_labels.label_column}],position:null},components:{sortingByCombinedField:sortingByCombinedField,selectBox:selectBox},modifyArrays:!1}),reportGroupingManager=Ractive.extend({template:App._template("reportGroupingManagerTemplate"),init:function(){var a=this;this.data.isCombined&&(this.set("availableFieldsPossible",this.get("availableFields")),this.observe("availableFields",function(b){for(var c=[],d=0;d<b.length;d++)ReportData.commonModules.indexOf(b[d].moduleId)>-1&&c.push(b[d]);a.set("availableFieldsPossible",c)},{init:!1})),this.observe("aggregatesAsColumn",function(b){if(b){for(var c=this.get("aggregates"),d=this.get("totalAggregates"),e=0;e<c.length;e++)"undefined"==typeof d[c[e].selectedField]&&(d[c[e].selectedField]={sum:!1,avg:!1,count:!1}),c[e].value.sum&&(d[c[e].selectedField].sum=!0),c[e].value.avg&&(d[c[e].selectedField].avg=!0),c[e].value.count&&(d[c[e].selectedField].count=!0);a.set("totalAggregates",d)}}),ReportData.options.isCombined&&this.observe("availableFieldsPossible",function(a){for(var b=[],c=ReportData.combinedModules,d=0;d<a.length;d++)c.indexOf(parseInt(a[d].moduleId))==-1&&b.push(a[d]);b.length<a.length&&this.set("availableFieldsPossible",b)}),this.on("addItem",function(){var a={name:this.data.availableFields[0].name,showAggregates:{},sortAction:"groupsort",sortDirection:"ASC",aggregate:"",position:""};this.data.selectedFields.length>0&&"sort"==this.data.selectedFields[this.data.selectedFields.length-1].sortAction&&(a.sortOptions=[{name:"sort",title:translated_labels.label_sort}]),this.get("isCrosstab")&&(a.position="row"),this.push("selectedFields",a)})},data:{blocks:[],selectedFields:[],aggregates:[],totalAggregates:{},combinedSelectedFields:ReportData.combinedSelectedFields,combinedModules:ReportData.combinedModules,isCombined:ReportData.options.isCombined,canSort:ReportData.options.includeDetails,aggregatesAsColumn:ReportData.options.aggregateColumn},components:{sortingByCombined:sortingByCombined,totalTable:totalTable,sortingBy:sortingBy,reportButtons:reportButtons,reportButtonPreview:reportButtonPreview,reportBtn:reportBtn,reportBtnGC:reportBtnGC,includeDetails:includeDetails,isCrosstab:isCrosstab},modifyArrays:!1}),reportAccessRights=Ractive.extend({template:'<selectBox selected="{{level}}" options="{{rights}}" titleName="title" valueName="name" />',data:{rights:[{name:"VIEW",title:translated_labels.label_can_view},{name:"EDIT",title:translated_labels.label_can_edit},{name:"DELETE",title:translated_labels.label_can_delete}],level:"VIEW"},components:{selectBox:selectBox}}),reportAccessManager=Ractive.extend({template:App._template("reportAccessTemplate"),beforeInit:function(a){for(var b={},c=[],d=0;d<a.data.users.length;d++)b[a.data.users[d].id]=a.data.users[d],"undefined"!=typeof a.data.accessRights[a.data.users[d].id]?(b[a.data.users[d].id].accessRights=a.data.accessRights[a.data.users[d].id],b[a.data.users[d].id].selected=!0,c.push(a.data.users[d].id)):b[a.data.users[d].id].accessRights="VIEW";a.data.selectedUsers=c,a.data.usersById=b},init:function(){var a=this;this.on("selectUsers",function(b,c){
for(var d=a.get("selectedUsers"),e=0;e<c.length;e++)d.push(c[e]),a.set("usersById."+c[e]+".selected",!0);a.set("selectedUsers",d),a.set("updatePermissions",!0)}),this.on("removeUser",function(b,c){var d=a.get("selectedUsers"),e=d.indexOf(c);d.splice(e,1),a.set("usersById."+c+".selected",!1),a.set("selectedUsers",d)}),this.observe("globalSharing",function(b){if("PUB"===b){for(var c=a.get("selectedUsers"),d=0;d<c.length;d++)a.set("usersById."+c[d]+".selected",!1);a.set("selectedUsers",c)}},{init:!1})},data:{users:[],selectedUsers:[],usersById:{},accessRights:{},globalSharing:"PRIV",availableOwners:[],updatePermissions:!1,owner:0},getSelectedAccess:function(){for(var a=this.get("selectedUsers"),b=this.get("usersById"),c={},d=0;d<a.length;d++)void 0!==typeof b[a[d]].selected&&b[a[d]].selected&&(c[a[d]]=b[a[d]].accessRights);return c},components:{reportAccessRights:reportAccessRights,reportButtons:reportButtons,reportButtonPreview:reportButtonPreview,selectBox:selectBox}}),reportScheduleManager=Ractive.extend({template:App._template("reportSchedulingTemplate"),beforeInit:function(a){for(var b={},c=0;c<a.data.users.length;c++)b[a.data.users[c].id]=a.data.users[c],a.data.selectedUsers.indexOf(a.data.users[c].id)>-1?b[a.data.users[c].id].selected=!0:b[a.data.users[c].id].selected=!1;a.data.usersById=b},init:function(){var a=this;this.on("selectUsers",function(b,c){b.original.preventDefault();for(var d=a.get("selectedUsers"),e=0;e<c.length;e++)d.push(c[e]),a.set("usersById."+c[e]+".selected",!0);a.set("selectedUsers",d),a.set("isScheduled",!0)}),this.on("removeUser",function(b,c){b.original.preventDefault();var d=a.get("selectedUsers"),e=d.indexOf(c);d.splice(e,1),a.set("usersById."+c+".selected",!1),a.set("selectedUsers",d)});var b=function(b){var c=a.get("interval"),d=["02","04","06","09","11"];4==c&&(d.indexOf(b)>-1?"02"==b?a.set("days",[{val:"01",title:"1"},{val:"02",title:"2"},{val:"03",title:"3"},{val:"04",title:"4"},{val:"05",title:"5"},{val:"06",title:"6"},{val:"07",title:"7"},{val:"08",title:"8"},{val:"09",title:"9"},{val:"10",title:"10"},{val:"11",title:"11"},{val:"12",title:"12"},{val:"13",title:"13"},{val:"14",title:"14"},{val:"15",title:"15"},{val:"16",title:"16"},{val:"17",title:"17"},{val:"18",title:"18"},{val:"19",title:"19"},{val:"20",title:"20"},{val:"21",title:"21"},{val:"22",title:"22"},{val:"23",title:"23"},{val:"24",title:"24"},{val:"25",title:"25"},{val:"26",title:"26"},{val:"27",title:"27"},{val:"28",title:"28"}]):a.set("days",[{val:"01",title:"1"},{val:"02",title:"2"},{val:"03",title:"3"},{val:"04",title:"4"},{val:"05",title:"5"},{val:"06",title:"6"},{val:"07",title:"7"},{val:"08",title:"8"},{val:"09",title:"9"},{val:"10",title:"10"},{val:"11",title:"11"},{val:"12",title:"12"},{val:"13",title:"13"},{val:"14",title:"14"},{val:"15",title:"15"},{val:"16",title:"16"},{val:"17",title:"17"},{val:"18",title:"18"},{val:"19",title:"19"},{val:"20",title:"20"},{val:"21",title:"21"},{val:"22",title:"22"},{val:"23",title:"23"},{val:"24",title:"24"},{val:"25",title:"25"},{val:"26",title:"26"},{val:"27",title:"27"},{val:"28",title:"28"},{val:"29",title:"29"},{val:"30",title:"30"}]):a.set("days",[{val:"01",title:"1"},{val:"02",title:"2"},{val:"03",title:"3"},{val:"04",title:"4"},{val:"05",title:"5"},{val:"06",title:"6"},{val:"07",title:"7"},{val:"08",title:"8"},{val:"09",title:"9"},{val:"10",title:"10"},{val:"11",title:"11"},{val:"12",title:"12"},{val:"13",title:"13"},{val:"14",title:"14"},{val:"15",title:"15"},{val:"16",title:"16"},{val:"17",title:"17"},{val:"18",title:"18"},{val:"19",title:"19"},{val:"20",title:"20"},{val:"21",title:"21"},{val:"22",title:"22"},{val:"23",title:"23"},{val:"24",title:"24"},{val:"25",title:"25"},{val:"26",title:"26"},{val:"27",title:"27"},{val:"28",title:"28"},{val:"29",title:"29"},{val:"30",title:"30"},{val:"31",title:"31"}]))};this.observe("intervalOptions.0",b),this.observe("interval",function(a){4==a?b(this.get("intervalOptions.0")):3==a&&b("01")})},getSelectedRecipients:function(){for(var a=this.get("selectedUsers"),b=this.get("usersById"),c=[],d=0;d<a.length;d++)"undefined"!=typeof b[a[d]]&&"undefined"!=typeof b[a[d]].selected&&b[a[d]].selected&&c.push(a[d]);return c},data:{users:[],selectedUsers:[],usersById:{},isScheduled:!1,interval:0,intervalOptions:[],timeM:"00",timeH:"00",minutes:[{m:"00"},{m:"05"},{m:"10"},{m:"15"},{m:"20"},{m:"25"},{m:"30"},{m:"35"},{m:"40"},{m:"45"},{m:"50"},{m:"55"}],hours:[{h:"00"},{h:"01"},{h:"02"},{h:"03"},{h:"04"},{h:"05"},{h:"06"},{h:"07"},{h:"08"},{h:"09"},{h:"10"},{h:"11"},{h:"12"},{h:"13"},{h:"14"},{h:"15"},{h:"16"},{h:"17"},{h:"18"},{h:"19"},{h:"20"},{h:"21"},{h:"22"},{h:"23"}],weekdays:[{val:"0",title:translated_labels.label_monday},{val:"1",title:translated_labels.label_tuesday},{val:"2",title:translated_labels.label_wednesday},{val:"3",title:translated_labels.label_thursday},{val:"4",title:translated_labels.label_friday},{val:"5",title:translated_labels.label_saturday},{val:"6",title:translated_labels.label_sunday}],monthweeks:[{val:0,title:translated_labels.label_week_first_third},{val:1,title:translated_labels.label_week_second_fourth}],months:[{val:"01",title:"1"},{val:"02",title:"2"},{val:"03",title:"3"},{val:"04",title:"4"},{val:"05",title:"5"},{val:"06",title:"6"},{val:"07",title:"7"},{val:"08",title:"8"},{val:"09",title:"9"},{val:"10",title:"10"},{val:"11",title:"11"},{val:"12",title:"12"}],days:[{val:"01",title:"1"},{val:"02",title:"2"},{val:"03",title:"3"},{val:"04",title:"4"},{val:"05",title:"5"},{val:"06",title:"6"},{val:"07",title:"7"},{val:"08",title:"8"},{val:"09",title:"9"},{val:"10",title:"10"},{val:"11",title:"11"},{val:"12",title:"12"},{val:"13",title:"13"},{val:"14",title:"14"},{val:"15",title:"15"},{val:"16",title:"16"},{val:"17",title:"17"},{val:"18",title:"18"},{val:"19",title:"19"},{val:"20",title:"20"},{val:"21",title:"21"},{val:"22",title:"22"},{val:"23",title:"23"},{val:"24",title:"24"},{val:"25",title:"25"},{val:"26",title:"26"},{val:"27",title:"27"},{val:"28",title:"28"},{val:"29",title:"29"},{val:"30",title:"30"},{val:"31",title:"31"}],intervalAvailableValues:[{value:0,title:translated_labels.label_daily},{value:1,title:translated_labels.label_weekly},{value:2,title:translated_labels.label_biweekly},{value:3,title:translated_labels.label_monthly},{value:4,title:translated_labels.label_yearly}],scheduledFormats:{xlsx:!1,pdf:!1,url:!1}},components:{selectBox:selectBox}}),calcFieldDefaults={op:"sum",fullOP:{op:"sum",valType:["c"],val:["0.01"]},selectedFn:function(){return{name:"sum",title:translated_labels.label_fn_sum,valCount:1,argTitles:[""],acceptedFields:["number"]}},valType:"c",val:"0.01",fullField:function(a){return{val:{op:this.op,valType:[this.valType],val:[this.val]},name:"X_Calculated_calField"+a,availableValues:[],title:"Untitled field "+a,bareTitle:"Calculated field "+a,column:"calcField_"+a,type:"number",table:"__virtual__",uitype:"71"}},findSelectedFn:function(a,b){for(var c=calcFieldDefaults.selectedFn(),d=0;d<a.length;d++)if(a[d].name==b){c=a[d];break}return c||b==calcFieldDefaults.op||(c=this.findSelectdFn(a,calcFieldDefaults.op)),c},filterFieldsByType:function(a,b){for(var c=[],d=0;d<a.length;d++)b.indexOf(a[d].type)>-1&&c.push(a[d]);return c}},calcField=Ractive.extend({template:App._template("reportCalcFieldTemplate"),onconstruct:function(a){return a.data.val=a.data.val||calcFieldDefaults.fullOP,a.data.val.op=a.data.val.op||calcFieldDefaults.op,a.data.selectedFn=calcFieldDefaults.findSelectedFn(a.data.fns,a.data.val.op),a.data.availableFieldsFiltered=calcFieldDefaults.filterFieldsByType(a.data.availableFields,a.data.selectedFn.acceptedFields),a},init:function(){this.observe(this.observers,{init:!1})},observers:{"selectedFn.valCount":function(a,b){var c=a-b;if(c>0)for(var d=0;d<c;d++)this.push("val.val",calcFieldDefaults.val),this.push("val.valType",calcFieldDefaults.valType);else if(c<0)for(var d=0;d<-c;d++)this.pop("val.valType"),this.pop("val.val")},"val.op":function(a){a||(a="plus"),this.set("selectedFn",calcFieldDefaults.findSelectedFn(this.get("fns"),a));var b=calcFieldDefaults.filterFieldsByType(this.get("availableFields"),this.get("selectedFn.acceptedFields"));this.set("availableFieldsFiltered",b)},"val.valType.*":function(a,b,c){var d=c.split(".")[2];"op"==a?this.set("val.val."+d,{op:"sum",valType:["c"],val:["0.01"]}):this.set("val.val."+d,"")},availableFields:function(a){var b=calcFieldDefaults.filterFieldsByType(a,this.get("selectedFn.acceptedFields"));this.set("availableFieldsFiltered",b)}},data:{fns:[],val:{op:"",valType:["c"],val:["0.01"]},opTypes:[{name:"c",title:translated_labels.label_op_const},{name:"f",title:translated_labels.label_op_field},{name:"op",title:translated_labels.label_op_sub_op}],selectedFn:calcFieldDefaults.selectedFn(),availableFields:[],availableFieldsFiltered:[],fieldsByName:{},level:0},components:{calcField:calcField,selectBox:selectBox}});calcField.components.calcField=calcField;var calcFieldDisplay=Ractive.extend({template:App._template("reportCalcFieldDisplayTemplate"),init:function(){this.observe("val.op",function(a){var b=calcFieldDefaults.findSelectedFn(this.get("fns"),a);this.set("fnName",b.title),this.set("fnArgs",b.argTitles)})},data:{fns:[],val:{},fnName:"",fnArgs:[]}});calcFieldDisplay.components.calcFieldDisplay=calcFieldDisplay;var reportCalcFieldManager=Ractive.extend({template:App._template("reportCalcFieldManagerTemplate"),onconstruct:function(){},init:function(){this.on("addField",function(){var a=this.get("calcFields").length;this.push("calcFields",calcFieldDefaults.fullField(a))}),this.on("removeItem",function(a,b){this.splice("calcFields",b,1)}),this.observe("calcFields.*.title",function(a,b,c,d){this.set("calcFields."+d+".bareTitle",a)})},data:{calcFields:[],fields:[],fns:[]},components:{reportBtnGC:reportBtnGC,calcField:calcField,calcFieldDisplay:calcFieldDisplay,reportButtonPreview:reportButtonPreview}}),reportPaginationManager=Ractive.extend({template:App._template("reportPaginationTemplate"),append:!1,init:function(){var a=this;this.initPagination(),this.observe("isCrosstab",function(a){this.set("showLimitInput",!a)}),this.observe("meta",function(){a.initPagination()}),this.observe("meta.limit",function(a){ReportData.options.limit=a},{init:!1})},changePage:function(a){ReportData.currentResult.meta.currentPage=a,this.fire("preview")},initPagination:function(){var a=this.get("meta"),b=[],c=!1,d=a.currentPage,e=3,f=a.pages,g=f-1,h="...";if(f>1)if(f<7+2*e)for(var i=1;i<a.pages+1;i++)b=push_page(i,a.currentPage,b);else if(d<1+2*e){for(i=1;i<4+2*e;i++)b=push_page(i,a.currentPage,b);b=push_separator(h,b),b=push_page(g,a.currentPage,b),b=push_page(f,a.currentPage,b)}else if(f-2*e>d&&d>2*e){for(b=push_page(1,a.currentPage,b),b=push_page(2,a.currentPage,b),b=push_separator(h,b),i=d-e;i<=d+e;i++)b=push_page(i,a.currentPage,b);b=push_separator(h,b),b=push_page(g,a.currentPage,b),b=push_page(f,a.currentPage,b)}else for(b=push_page(1,a.currentPage,b),b=push_page(2,a.currentPage,b),b=push_separator(h,b),i=f-(1+3*e);i<=f;i++)b=push_page(i,a.currentPage,b);b.length>0&&(c=!0),this.set("isPagination",c),this.set("pagination",b)},data:{meta:[],pagination:[],isPagination:!1,showLimitInput:!0,isCrosstab:!1}}),numberFormat=null;DetailGrid={gridElement:"#ar-rv-data-grid",gridOptions:{explicitInitialization:!0,enableColumnReorder:!1,forceFitColumns:!1,autoHeight:!0,enableColumnReorder:!0},dataViewOptions:{groupItemMetadataProvider:null,inlineFilters:!0},columnOptions:{focusable:!1},grid:null,dataView:null,multiSummaryReport:!1,init:function(a,b,c){var d=this;this.multiSummaryReport=c,this.groupingManager=b;var e=b.get("selectedFields"),f=b.get("aggregates"),g=this.makeGridColumns(ReportData.currentResult,e),h=parseDateGroups(e),i=new Slick.Data.GroupItemMetadataProvider({groups:h,columns:g,groupingManager:b,groupFocusable:!1,grandTotalLabel:getGrandTotalsLabel(),multiSummaryReport:this.multiSummaryReport,isCrosstab:ReportData.options.isCrosstab});this.dataViewOptions.groupItemMetadataProvider=i,this.dataView=new Slick.Data.DataView(this.dataViewOptions),this.grid=new Slick.Grid(this.gridElement,this.dataView,g,this.gridOptions),this.grid.registerPlugin(this.dataViewOptions.groupItemMetadataProvider),d.dataView.onRowCountChanged.subscribe(function(a,b){d.grid.updateRowCount(),d.grid.render()}),d.dataView.onRowsChanged.subscribe(function(a,b){d.grid.invalidateRows(b.rows),d.grid.render()}),this.grid.init(),this.dataView.beginUpdate();var j=this.setTotals(ReportData.currentResult);this.dataView.setItems(j),this.setGrouping(f,e),this.dataView.endUpdate(),this.grid.invalidate(),jQuery(document).trigger("slickRenderCompleted")},makeGridColumns:function(a,b){var c=a.cols,d=a.data,e=this,f=[],g=0,h=reportUtils.generateFieldsByNameFromBlocks(ReportData.availableFields);numberFormat=new NumberFormatter(ReportData.numberFormat).makeFormatter();var i=parseDateGroups(b);return _.each(c,function(a,b){var c=!1,j=0,k="",l=i.length;e.multiSummaryReport&&!ReportData.options.includeDetails&&l--;for(var m=0,n=0;n<l;n++)if("column"==i[n].position&&ReportData.options.isCrosstab)m++;else if(i[n].name==b){c=!0,j=n-m,k+='<span class="slick-group-toggle expanded" level="'+j+'"></span>',k+='<span class="slick-group-toggle collapsed" level="'+j+'"></span>';break}var o=getColumnWidth({data:d,label:a,name:b,grouped:c,groupedLevel:j}),p={id:g++,field:b,name:k+a,nameName:a,focusable:!1,groupTotalsFormatter:DetailGrid.sumTotalsFormatter,formatter:DetailGrid.linkToEntityFormatter,width:o};("undefined"==typeof h[p.field]&&p.field.match(/_cnt$|_sum$|_avg$|(v[0-9]{1,}_){1,}$/g)||"X_Calculated_"==p.field.substring(0,13)||"undefined"!=typeof h[p.field]&&("number"===h[p.field].type||"integer"===h[p.field].type))&&(p.formatter=numberFormat),f.push(p)}),f},makeFormatter:function(a){return function(a){return a.value+" <span style='color:green'>("+a.count+")</span>"}},isLastGroupingLevel:function(a,b,c){for(var d=!1,e=c;e<b.length;e++)if("groupsort"==b[e].sortAction||"group"==b[e].sortAction){d=e;break}return d},getSubSorting:function(a,b,c){var d=DetailGrid.isLastGroupingLevel(a,b,c),e=[];if(d===c)return e;if(d===!1)for(var f=c;f<b.length;f++){for(var g={},h=!1,i=0;i<a.length;i++)if("undefined"!=typeof b[f].showAggregates[a[i].selectedField]&&b[f].name==a[i].selectedField&&"sort"==b[f].sortAction&&"undefined"!=typeof b[f].aggregate){g={direction:"ASC"==b[f].sortDirection?1:-1,aggregate:b[f].aggregate,name:a[i].selectedField},h=!0;break}h||(g={direction:"ASC"==b[f].sortDirection?1:-1,aggregate:null,name:b[f].name}),e.push(g)}else for(var f=c;f<d;f++)for(var i=0;i<a.length;i++)if("undefined"!=typeof b[f].showAggregates[a[i].selectedField]&&b[f].name==a[i].selectedField&&"sort"==b[f].sortAction&&"undefined"!=typeof b[f].aggregate){var g={direction:"ASC"==b[f].sortDirection?1:-1,aggregate:b[f].aggregate,name:a[i].selectedField};e.push(g);break}return e},getGroupSorting:function(a,b){for(var c=[],d=0;d<b.length;d++)if("groupsort"==b[d].sortAction){var e,f=b[d].aggregate.split("_"),g=f.shift();f=f.join("_"),e=1==DetailGrid.multiSummaryReport&&d==b.length-1?[{aggregate:"none",direction:"ASC"==b[d].sortDirection?1:-1,name:f+"_"+g}]:[{direction:"ASC"==b[d].sortDirection?1:-1,aggregate:"count"==g?"cnt":g,name:f}],c.push(e)}else if("group"==b[d].sortAction){var e=DetailGrid.getSubSorting(a,b,d+1);c.push(e)}return c},getFieldAggregator:function(a,b){for(var c=[{key:b+"_sum",aggregate:"sum"},{key:b+"_cnt",aggregate:"sum"},{key:b+"_avg",aggregate:"avg"}],d=0;d<c.length;d++){var e=a.replace(c[d].key,""),f=e.match(/v[0-9]+_$/);if(e!==a&&f)return{field:f[0]+c[d].key,aggregate:c[d].aggregate}}return!1},setGrouping:function(a,b){var c=[],d=DetailGrid.getGroupSorting(a,b),e=function(a){var b=a;return function(a,c){for(var d=0,e=0;e<b.length;e++)if("none"!==b[e].aggregate&&("sum"==b[e].aggregate||"cnt"==b[e].aggregate||"count"==b[e].aggregate||"avg"==b[e].aggregate)&&null!==a.totals){var f="undefined"==typeof a.totals[b[e].aggregate]||"undefined"==typeof a.totals[b[e].aggregate][b[e].name]?"undefined"==typeof a.totals.sum||"undefined"==typeof a.totals.sum[b[e].name+"_"+b[e].aggregate]?0:a.totals.sum[b[e].name+"_"+b[e].aggregate]:a.totals[b[e].aggregate][b[e].name],g="undefined"==typeof c.totals[b[e].aggregate]||"undefined"==typeof c.totals[b[e].aggregate][b[e].name]?"undefined"==typeof c.totals.sum||"undefined"==typeof c.totals.sum[b[e].name+"_"+b[e].aggregate]?0:c.totals.sum[b[e].name+"_"+b[e].aggregate]:c.totals[b[e].aggregate][b[e].name];if(d=b[e].direction*(f-g),0!=d)break}return 0===d&&(d=a.rows[0].id>=c.rows[0].id?1:-1),d}},f=parseDateGroups(b);if(ReportData.options.isCrosstab)for(var g=0;g<f.length;g++)"column"==f[g].position&&f.splice(g,1);this.multiSummaryReport&&!ReportData.options.includeDetails&&f.pop();for(var h=(f.length,-1),g=0;g<f.length;g++)if("sort"!=f[g].sortAction){h++;for(var i=f[g].title,j={getter:f[g].name,aggregators:[],formatter:DetailGrid.makeFormatter(i),aggregateCollapsed:!0,lazyTotalsCalculation:!1,displayTotalsRow:!1,comparer:e(d[h])},k=0;k<a.length;k++)if(f[g].showAggregates){var l=a[k].selectedField;if(ReportData.options.isCrosstab){for(column in ReportData.currentResult.cols)if(ReportData.currentResult.cols.hasOwnProperty(column)){var m=this.getFieldAggregator(column,l);m&&("sum"==m.aggregate&&j.aggregators.push(new Slick.Data.Aggregators.Sum(m.field)),"cnt"==m.aggregate&&j.aggregators.push(new Slick.Data.Aggregators.Sum(m.field)),"avg"==m.aggregate&&j.aggregators.push(new Slick.Data.Aggregators.Avg(m.field)))}}else"undefined"!=typeof f[g].showAggregates[a[k].selectedField]&&(f[g].showAggregates[a[k].selectedField].sum&&(_fieldName=l,this.multiSummaryReport&&(_fieldName+="_sum"),j.aggregators.push(new Slick.Data.Aggregators.Sum(_fieldName))),f[g].showAggregates[a[k].selectedField].count&&(_fieldName=l,this.multiSummaryReport?(_fieldName+="_cnt",j.aggregators.push(new Slick.Data.Aggregators.Sum(_fieldName))):j.aggregators.push(new Slick.Data.Aggregators.Cnt(_fieldName))),f[g].showAggregates[a[k].selectedField].avg&&(_fieldName=l,this.multiSummaryReport&&(_fieldName+="_avg"),j.aggregators.push(new Slick.Data.Aggregators.Avg(_fieldName))))}c.push(j)}this.dataView.setGrouping(c)},sumTotalsFormatter:function(a,b){var c="";return a?a.grandTotals&&a.grandTotals[b.field]?(val=a.grandTotals[b.field],"<b>"+numberFormat(null,null,val,b,"grandTotal")+"</b>"):(a.sum&&a.sum[b.field]?(val=a.sum&&a.sum[b.field],c+="<b>"+numberFormat(null,null,val,b,"sum")+"</b>"):a.cnt&&a.cnt[b.field]?(val=a.cnt[b.field],c+="<b>"+numberFormat(null,null,val,b,"count")+"</b>"):a.avg&&a.avg[b.field]&&(val=a.avg[b.field],c+="<b>"+numberFormat(null,null,val,b,"avg")+"</b>"),c):""},linkToEntityFormatter:function(a,b,c,d,e){var f=e[d.field+"_id"],g=e[d.field+"_setype"];if(f&&g){var h="index.php?module="+g+"&action=DetailView&record="+f;return'<a href="'+h+'" class="link-cell" target="_blank">'+c+"</a>"}return c},setTotals:function(a){var b=this,c=this.groupingManager.get("totalAggregates"),d=this.groupingManager.get("aggregates"),e=ReportData.options.aggregateColumn,f=ReportData.options.isCrosstab,g={},h=!1;if(gHasTotals=!1,jQuery.isEmptyObject(c))return a.data;jQuery.each(d,function(a,d){if((f||b.multiSummaryReport)&&c[d.selectedField]){if(c[d.selectedField].sum){var e=d.selectedField+"_sum";g[e]=0,h=!0}if(c[d.selectedField].count){var e=d.selectedField+"_cnt";g[e]=0,h=!0}if(c[d.selectedField].avg){var e=d.selectedField+"_avg";g[e]=0,h=!0}}else if(c[d.selectedField]){if(c[d.selectedField].sum){var e=d.selectedField;g[d.selectedField]=0,h=!0}if(c[d.selectedField].count){var e=d.selectedField;g[e]=0,h=!0}}});for(field in g)if(g.hasOwnProperty(field))for(column in a.cols)if(a.cols.hasOwnProperty(column)){var i=column.replace(field,""),j=i.match(/v[0-9]+_/);i!==column&&j&&(g[column]=0)}if(e&&h){var k="grandTotal",l=getGrandTotalsLabel(),m=this.grid.getColumns();m.push({id:k,name:l,field:k,focusable:!1,cssClass:"bold-column",formatter:numberFormat}),this.grid.setColumns(m)}var n=0;jQuery.each(a.data,function(){n=this.id;for(field in g)if(g.hasOwnProperty(field)){var a=null===this[field]||"-"==this[field]&&"undefined"!=typeof this[field+"_setype"],b=!ReportData.options.includeDetails||a&&DetailGrid.multiSummaryReport||c[field]&&c[field].sum?parseFloat(this[field]):1;b&&(g[field]+=b)}}),n++;for(field in g)g.hasOwnProperty(field)&&(g[field]=(+g[field]).toFixed(significantDigits));if(e&&h)for(var o=0;o<a.data.length;o++){var p=a.data[o],q=0;for(column in p)if(p.hasOwnProperty(column)&&column.match(/^(v[0-9]{1,}\_){1,}$/)){var r=!1;(""+p[column]).match(/^[\-]{0,}[0-9]+[.0-9]*$/)&&(r=!0),r&&(q+=parseFloat(p[column]))}p.grandTotal=q.toFixed(significantDigits)}if(!e&&h){var s=this.grid.getColumns(),t=[];for(field in g)g.hasOwnProperty(field)&&t.push(field);for(var o=0;o<s.length;o++)if(t.indexOf(s[o].field)==-1){g[s[o].field]="<strong>"+getGrandTotalsLabel()+"</strong>";break}}return g.id=n,g.noGrouping=!0,!e&&h&&(a.data.push(g),this.grandTotalId=g.id,gHasTotals=!0),a.data}},SummaryGrid={gridElement:"#ar-rv-data-grid",gridOptions:{explicitInitialization:!0,enableColumnReorder:!1,forceFitColumns:!1,autoHeight:!0,enableColumnReorder:!0},dataViewOptions:{groupItemMetadataProvider:null,inlineFilters:!0},columnOptions:{focusable:!1},grid:null,grandTotalId:null,dataView:null,init:function(a,b){var c=this;this.groupingManager=b;var d=this.makeGridColumns(ReportData.currentResult,!0);this.dataView=new Slick.Data.DataView(this.dataViewOptions),this.grid=new Slick.Grid(this.gridElement,this.dataView,d,this.gridOptions),this.grid.init(),this.dataView.beginUpdate();var e=this.setTotals(ReportData.currentResult);this.dataView.setItems(e),this.dataView.endUpdate(),this.grid.invalidate();var f="id",g=function(a,b){var c="undefined"==typeof a[f]?"":a[f],d="undefined"==typeof b[f]?"":b[f],e=parseFloat(c),g=parseFloat(d);return isNaN(e)||isNaN(g)||(c=e,d=g),c==d?0:c>d?1:-1};this.grid.onSort.subscribe(function(a,b){f=b.sortCol.field;var d;if(c.grandTotalId){var d=c.dataView.getItemById(c.grandTotalId);c.dataView.deleteItem(c.grandTotalId)}c.dataView.sort(g,b.sortAsc),c.grandTotalId&&c.dataView.addItem(d),c.grid.invalidate(),c.grid.render(),c.highlightGrandTotal()}),this.highlightGrandTotal(),jQuery(document).trigger("slickRenderCompleted")},highlightGrandTotal:function(){if(null!==this.grandTotalId&&!ReportData.options.aggregateColumn){var a=jQuery(this.grid.getCanvasNode()).children().last();a.children().wrapInner("<strong>")}},makeGridColumns:function(a,b){var c=a.data,d=a.cols;b=b||!1;var e=[],f=0,g=reportUtils.generateFieldsByNameFromBlocks(ReportData.availableFields);return numberFormat=new NumberFormatter(ReportData.numberFormat).makeFormatter(),_.each(d,function(a,d){var h=getColumnWidth({data:c,label:a,name:d,grouped:!1}),i={id:f++,field:d,name:a,focusable:!1,sortable:b,formatter:DetailGrid.linkToEntityFormatter,width:h};("undefined"==typeof g[i.field]&&i.field.match(/_cnt$|_sum$|_avg$|(v[0-9]{1,}_){1,}$/g)||"X_Calculated_"==i.field.substring(0,13)||"undefined"!=typeof g[i.field]&&"number"===g[i.field].type)&&(i.formatter=numberFormat),e.push(i)}),e},setTotals:function(a){var b=this.groupingManager.get("totalAggregates"),c=this.groupingManager.get("aggregates"),d=ReportData.options.aggregateColumn,e={},f=!1;if(jQuery.isEmptyObject(b))return a.data;jQuery.each(c,function(a,c){if(b[c.selectedField]){if(b[c.selectedField].sum){var d=c.selectedField+"_sum";e[d]=0,f=!0}if(b[c.selectedField].count){var d=c.selectedField+"_cnt";e[d]=0,f=!0}if(b[c.selectedField].avg){var d=c.selectedField+"_avg";e[d]=0,f=!0}}});for(field in e)if(e.hasOwnProperty(field))for(column in a.cols)if(a.cols.hasOwnProperty(column)){var g=column.replace(field,""),h=g.match(/v[0-9]+_/);g!==column&&h&&(e[column]=0)}if(d&&f){var i="grandTotal",j=getGrandTotalsLabel(),k=this.grid.getColumns();k.push({id:i,name:j,field:i,focusable:!1,cssClass:"bold-column"}),this.grid.setColumns(k)}var l=0;jQuery.each(a.data,function(){l=this.id;for(field in e)if(e.hasOwnProperty(field)){var a=parseFloat(this[field]);a&&(e[field]+=a)}}),l++;for(field in e)e.hasOwnProperty(field)&&(e[field]=(+e[field]).toFixed(significantDigits));if(d&&f)for(var m=0;m<a.data.length;m++){var n=a.data[m],o=0;for(column in n)if(n.hasOwnProperty(column)&&column.match(/^(v[0-9]{1,}\_){1,}$/)){var p=!1;(""+n[column]).match(/^[\-]{0,}[0-9]+[.0-9]*$/)&&(p=!0),p&&(o+=parseFloat(n[column]))}n.grandTotal=o.toFixed(significantDigits)}if(!d&&f){var q=this.grid.getColumns(),r=[];for(field in e)e.hasOwnProperty(field)&&r.push(field);for(var m=0;m<q.length;m++)if(r.indexOf(q[m].field)==-1){e[q[m].field]="<strong>"+getGrandTotalsLabel()+"</strong>";break}}return e.id=l,d||(a.data.push(e),this.grandTotalId=e.id),a.data}};var chartButtons=Ractive.extend({template:'<reportBtn text="'+translated_labels.label_preview+'" on-clicked="preview" className="green" />',data:{className:""},components:{reportBtn:reportBtn}}),chartTypeManager=Ractive.extend({template:App._template("chartTypeTemplate"),init:function(){this.observe("chartSize",function(a){ReportData.chartSize=a}),this.observe("chartType",function(a){ReportData.chartType=a})},data:{chartTypes:[{name:"pie",title:translated_labels.label_pie_chart},{name:"bar",title:translated_labels.label_column_chart},{name:"line",title:translated_labels.label_line_chart},{name:"combined",title:translated_labels.label_combined_chart},{name:"funnel",title:translated_labels.label_funnel_chart},{name:"gauge",title:translated_labels.label_gauge_chart}],chartType:ReportData.chartType,chartTitle:ReportData.chartTitle,chartSizes:ReportData.chartSizes,chartSize:ReportData.chartSize},components:{chartButtons:chartButtons,selectBoxImg:selectBoxImg,selectBox:selectBox}}),ChartView=Ractive.extend({template:'<chartComponent data="{{data}}" title="{{title}}" isWidget="{{isWidget}}" xAxis="{{xAxis}}" yAxis="{{yAxis}}" yAxis2="{{yAxis2}}" yAxisType="{{yAxisType}}" yAxis2Type="{{yAxis2Type}}" legend="{{legend}}" bars1Stacked="{{bars1Stacked}}" bars2Stacked="{{bars2Stacked}}" aggregates="{{aggregates}}" groups="{{groups}}" cumulated="{{cumulated}}" sortableValues="{{sortableValues}}" showPercents="{{showPercents}}" showLabels="{{showLabels}}" showZoneLabels="{{showZoneLabels}}" valueZones="{{valueZones}}" xAxisSegment="{{xAxisSegment}}" svg="{{svg}}" />',data:{title:"",xAxisSegment:!1,valueZones:[],showPercents:!1,showLabels:!0,showZoneLabels:!0,cumulated:!0,sortableValues:[],isWidget:!1,aggregates:[],groups:[],xAxis:[],yAxis:[],yAxis2:[],legend:[],yAxisType:[],yAxis2Type:[],svg:""}}),BaseChartComponent=Ractive.extend({chartHeight:600,chartHeightModifier:1.2,bigValues:!0,parentInit:function(){(ReportData.chartHeight||ReportData.chartHeight>0)&&(this.chartHeight=ReportData.chartHeight);var a=this;this.on("increaseHeight",function(){a.chartIncreaseHeight()}),this.on("decreaseHeight",function(){a.chartDecreaseHeight()}),setTimeout(function(){a.chart.update()},300)},chartUpdate:function(){this.chart.update()},chartIncreaseHeight:function(){this.chartHeight=Math.round(this.chartHeight*this.chartHeightModifier),jQuery("#chart1").css({height:this.chartHeight}),ReportData.chartHeight=this.chartHeight,this.chart.update()},chartDecreaseHeight:function(){this.chartHeight=Math.round(this.chartHeight/this.chartHeightModifier),jQuery("#chart1").css({height:this.chartHeight}),ReportData.chartHeight=this.chartHeight,this.chart.update()}}),BarChartComponent=BaseChartComponent.extend({template:App._template("chartViewTemplate"),init:function(){this.parentInit();var a=this,b=a.get("data"),c=ReportData.chartTitle,d=a.get("svg"),e=a.get("isWidget"),f={top:50,right:50,bottom:120,left:70};ReportData.chartMargin&&(f=ReportData.chartMargin),nv.addGraph(function(){var g=nv.models.discreteBarChart().options({reduceXTicks:!1}).x(function(a){return a.label}).y(function(a){return a.value}).staggerLabels(!1).tooltips(!1).showValues(!0).transitionDuration(350).margin(f).color(d3.scale.category10().range());return g.xAxis.rotateLabels(-30),a.bigValues&&g.yAxis.tickFormat(d3.format(".0f")),g.forceY(0),d3.select(d).datum(a.normalise(b)).call(g),e||d3.select(d).append("text").attr("x",100).attr("y",10).style({"text-anchor":"left","font-weight":"bold"}).text(c),nv.utils.windowResize(g.update),a.chart=g,g})},normalise:function(a){var b=this.get("xAxis"),c=this.get("yAxis");b=reportUtils.appendDateGrouping(a,b);var d=[],e=[];_.each(a.data,function(a){a[c]||(a[c]=0),a[c]>100&&(this.bigValues=!0);var e={label:a[b],value:parseFloat(a[c])};d.push(e)});var e=[{values:d}];return e},data:{data:[],title:"",xAxis:"",yAxis:"",svg:""}});MultiBarChartComponent=BaseChartComponent.extend({template:App._template("chartViewTemplate"),init:function(){this.parentInit();var a=this,b=a.get("data"),c=ReportData.chartTitle,d=a.get("svg"),e=a.get("isWidget"),f={top:50,right:150,bottom:120,left:70};ReportData.chartMargin&&(f=ReportData.chartMargin),nv.addGraph(function(){var g=nv.models.multiBarChart().reduceXTicks(!1).transitionDuration(350).margin(f).stacked(ReportData.chartStacked).color(d3.scale.category10().range()).showControls(!1);g.xAxis.tickFormat(function(b){return"undefined"!=typeof a.axisKeys[b]?a.axisKeys[b]:""}),g.xAxis.rotateLabels(-30),a.bigValues&&g.yAxis.tickFormat(d3.format(".0f")),e||g.legend.margin({top:20,bottom:20});var h=a.normalise(b);return d3.select(d).datum(h).call(g),g.dispatch.on("stateChange",function(a){ReportData.chartStacked=a.stacked}),e||d3.select(d).append("text").attr("x",100).attr("y",10).style({"text-anchor":"left","font-weight":"bold"}).text(c),nv.utils.windowResize(g.update),a.chart=g,g})},normalise:function(a){var b=ReportData.chartLegend,c=this.get("xAxis"),d=this.get("yAxis");c=reportUtils.appendDateGrouping(a,c);for(var e=this.get("aggregates"),f=!1,g=0;g<b.length;g++){var h=ReportBarChart.getAggregate(b[g],e);if(h){f=!0;break}}return f?this.parseAggregates(a,c,d,b):this.parseGroups(a,c,d,b)},parseGroups:function(a,b,c,d){for(var e=[],f=[],g=0;g<a.data.length;g++){for(var h=0;h<d.length;h++)a.data[g][d[h]]||(a.data[g][d[h]]="-"),e.push(a.data[g][d[h]]);a.data[g][b]||(a.data[g][b]="-"),f.push(a.data[g][b])}e=unique(e),f=unique(f),this.axisKeys=f;for(var i=[],g=0;g<e.length;g++){i[g]={key:e[g],values:[]};for(var h=0;h<f.length;h++)i[g].values[h]={x:h,y:0}}for(var g=0;g<a.data.length;g++)for(var j=!1,k=f.indexOf(a.data[g][b]),h=0;h<d.length;h++)j=e.indexOf(a.data[g][d[h]]),a.data[g][c]||(a.data[g][c]=0),i[j].values[k].y=parseFloat(a.data[g][c]);return i},parseAggregates:function(a,b,c,d){for(var e=[],f=[],g=0;g<d.length;g++)e.push(d[g]);for(var h=0;h<a.data.length;h++)a.data[h][b]||(a.data[h][b]="-"),f.push(a.data[h][b]);e=unique(e),f=unique(f),this.axisKeys=f;for(var i=[],h=0;h<e.length;h++){i[h]={key:e[h],values:[]};for(var g=0;g<f.length;g++)i[h].values[g]={x:g,y:0}}for(var h=0;h<a.data.length;h++)for(var j=f.indexOf(a.data[h][b]),g=0;g<d.length;g++)for(var k=0;k<i.length;k++)i[k].key==d[g]&&(a.data[h][d[g]]||(a.data[h][d[g]]=0),parseFloat(a.data[h][d[g]])>100&&(this.bigValues=!0),i[k].values[j].y=parseFloat(a.data[h][d[g]]));for(var h=0;h<i.length;h++)i[h].key=a.cols[i[h].key];return i},data:{data:[],title:"",xAxis:"",yAxis:"",legend:"",svg:""}});var ReportBarChart={getAggregate:function(a,b){for(var c=!1,d=0;d<b.length;d++)if(b[d].value.sum&&b[d].selectedField+"_sum"==a&&(c=!0),b[d].value.avg&&b[d].selectedField+"_avg"==a&&(c=!0),b[d].value.count&&b[d].selectedField+"_cnt"==a&&(c=!0),c)return b[d]},getGroup:function(a,b){for(var c=0;c<b.length;c++)if(b[c].name==a)return b[c]},parseDataItems:function(a,b,c,d,e){for(var f=0;f<a.length;f++){if("string"==typeof a[f]){var g=this.getAggregate(a[f],b),h=this.getGroup(a[f],c);g&&e.push(g),h&&d.push(h)}"object"==typeof a[f]&&this.parseDataItems(a[f],b,c,d,e)}},prepareData:function(a,b,c,d,e){var f=ReportData.chartAxisX,g=ReportData.chartAxisY,h=ReportData.chartLegend,i=[],j=[],k=[];if(k.push(f),k.push(g),k.push(h),this.parseDataItems(k,d,e,j,i),ReportData.options.isCombined){var l=a.get("combinedSelectedFields.fields");for(moduleId in l)for(var m=l[moduleId],n=0;n<ReportData.availableFields.length;n++)for(var o=0;o<ReportData.availableFields[n].fields.length;o++)if(m==ReportData.availableFields[n].fields[o].name){
var p=jQuery.extend(!0,{},ReportData.availableFields[n].fields[o]);p={name:m},p.sortAction="date_field"==ReportData.chartAxisX?"nogroup"!==ReportData.combinedSelectedFields.sortAction?ReportData.combinedSelectedFields.sortAction:"group":"nogroup",p.dateGrouping=ReportData.combinedSelectedFields.dateGrouping,p.sortDirection=ReportData.combinedSelectedFields.sortDirection,p.position=ReportData.combinedSelectedFields.position,j.unshift(p)}}for(var q=[],n=0;n<i.length;n++)q.indexOf(i[n].selectedField)>-1?(i.splice(n,1),n--):q.push(i[n].selectedField);var r={filters:JSON.stringify(b),columns:JSON.stringify(c),options:JSON.stringify(ReportData.chartOptions),labels:JSON.stringify(ReportData.labels),aggregates:JSON.stringify(i),grouping:JSON.stringify(j),calcFields:JSON.stringify(ReportData.calcFields)};return r},init:function(a,b,c,d,e){var f=this.prepareData(a,b,c,d,e);loadChart("bar",f,d,e)}},BarChartLegendManager=Ractive.extend({template:App._template("barChartLegendTemplate"),init:function(){var a=this;this.get("yAxis")instanceof String&&this.set("yAxis",[this.get("yAxis")]),this.get("legend")instanceof String&&this.set("legend",[this.get("legend")]);var b=function(){for(var b=[],c=[],d=a.get("groups"),e=a.get("aggregates"),f=a.get("fieldsByName"),g=0;g<e.length;g++){var h=f[e[g].selectedField].title,i=e[g].selectedField;e[g].value.sum&&c.push({name:i+"_sum",title:h+" "+translated_labels.label_sum}),e[g].value.count&&c.push({name:i+"_cnt",title:h+" "+translated_labels.label_count}),e[g].value.avg&&c.push({name:i+"_avg",title:h+" "+translated_labels.label_average})}for(var g=0;g<d.length;g++)"group"!=d[g].sortAction&&"groupsort"!=d[g].sortAction||(d[g].title=f[d[g].name].title,b.push(d[g]));c=_.uniq(c,function(a){return a.name}),b=_.uniq(b,function(a){return a.name});var j=[{key:translated_labels.label_groups,values:b},{key:translated_labels.label_aggregates,values:c}],c=[{key:translated_labels.label_aggregates,values:c}];a.set("availableAxis",c),ReportData.options.isCombined&&b.unshift({name:"date_field",title:translated_labels.label_date,showAggregates:{},sortAction:"group",sortDirection:"DESC",aggregate:"",position:"",dateGrouping:""}),a.set("availableGroups",b),a.set("availableLegends",j)};this.observe("groups",b),this.observe("aggregates",b,{init:!1}),this.observe("xAxis",validateXAxis,{init:!1}),this.observe("yAxis",function(b){1==b.length?a.set("legend",[this.get("xAxis")]):a.set("legend",b),ReportData.chartAxisY=b},{init:!1}),this.observe("xAxis",function(b){1==a.get("yAxis").length&&a.set("legend",[this.get("xAxis")])},{init:!1}),this.observe("y2Axis",function(a){ReportData.chartAxisY2=a},{init:!1}),0==this.get("legend").length&&this.set("legend",[this.get("xAxis")]),this.observe("legend",function(b){ReportData.chartLegend=b;for(var c=a.get("aggregates"),d=!1,e=0;e<b.length;e++)if(ReportBarChart.getAggregate(b[e],c)){d=!0;break}d&&a.set("yAxis",b)}),this.observe("chartSize",function(a){ReportData.chartSize=a})},data:{xAxis:ReportData.chartAxisX,yAxis:ReportData.chartAxisY,y2Axis:ReportData.chartAxisY2,chartTitle:ReportData.chartTitle,legend:ReportData.chartLegend,availableLegends:[],labelName:ReportData.chartLabels,groups:[],aggregates:[],availableAxis:[],availableGroups:[],chartSizes:ReportData.chartSizes,chartSize:ReportData.chartSize},components:{chartButtons:chartButtons,selectBox:selectBox,multiSelectBox:multiSelectBox}}),PieChartComponent=BaseChartComponent.extend({template:App._template("chartViewTemplate"),init:function(){this.parentInit();var a=this,b=a.get("data"),c=a.get("title"),d=a.get("svg"),e=a.get("isWidget"),f=a.get("showPercents"),g={top:10,right:10,bottom:10,left:10};ReportData.chartMargin&&(g=ReportData.chartMargin),nv.addGraph(function(){var h=nv.models.pieChart().x(function(a){return a.label}).y(function(a){return a.value}).margin(g).showLabels(!0).color(d3.scale.category10().range());return h.pie.pieLabelsOutside(!0).labelType("value").showPercents(f),e||h.legend.margin({top:20,bottom:20}),d3.select(d).datum(a.normalise(b)).transition().duration(350).call(h),e||d3.select(d).append("text").attr("x",100).attr("y",10).style({"text-anchor":"left","font-weight":"bold"}).text(c),nv.utils.windowResize(h.update),a.chart=h,h})},normalise:function(a){var b=this.get("xAxis"),c=this.get("yAxis");b=reportUtils.appendDateGrouping(a,b);var d=[],e=[];_.each(a.data,function(a){var e={label:a[b],value:parseFloat(a[c])};d.push(e)});var e=d;return e},data:{data:[],title:"",xAxis:"",yAxis:"",showPercents:!1}}),ReportPieChart={prepareData:function(a,b,c,d,e){var f=ReportData.chartAxisX,g=ReportData.chartAxisY,h=[];_.each(d,function(a){a.selectedField+"_sum"!=g&&a.selectedField+"_avg"!=g&&a.selectedField+"_cnt"!=g&&a.selectedField!=g||h.push(a)});var i=[];if(_.each(e,function(a){a.name==f&&i.push(a)}),ReportData.options.isCombined){var j=a.get("combinedSelectedFields.fields");for(moduleId in j)for(var k=j[moduleId],l=0;l<ReportData.availableFields.length;l++)for(var m=0;m<ReportData.availableFields[l].fields.length;m++)if(k==ReportData.availableFields[l].fields[m].name){var n=jQuery.extend(!0,{},ReportData.availableFields[l].fields[m]);n={name:k},n.sortAction="date_field"==ReportData.chartAxisX?"nogroup"!==ReportData.combinedSelectedFields.sortAction?ReportData.combinedSelectedFields.sortAction:"group":"nogroup",n.dateGrouping=ReportData.combinedSelectedFields.dateGrouping,n.sortDirection=ReportData.combinedSelectedFields.sortDirection,n.position=ReportData.combinedSelectedFields.position,i.unshift(n)}}var o={filters:JSON.stringify(b),columns:JSON.stringify(c),options:JSON.stringify(ReportData.chartOptions),labels:JSON.stringify(ReportData.labels),aggregates:JSON.stringify(h),grouping:JSON.stringify(i),calcFields:JSON.stringify(ReportData.calcFields)};return o},init:function(a,b,c,d,e){var f=this.prepareData(a,b,c,d,e);loadChart("pie",f,d,e)}},PieChartLegendManager=Ractive.extend({template:App._template("pieChartLegendTemplate"),init:function(){var a=this,b=function(){for(var b=[],c=[],d=a.get("groups"),e=a.get("aggregates"),f=a.get("fieldsByName"),g=0;g<e.length;g++){var h=f[e[g].selectedField].title,i=e[g].selectedField;e[g].value.sum&&c.push({name:i+"_sum",title:h+" "+translated_labels.label_sum}),e[g].value.count&&c.push({name:i+"_cnt",title:h+" "+translated_labels.label_count}),e[g].value.avg&&c.push({name:i+"_avg",title:h+" "+translated_labels.label_average})}for(var g=0;g<d.length;g++)"group"!=d[g].sortAction&&"groupsort"!=d[g].sortAction&&"nogroup"!=d[g].sortAction||(d[g].title=f[d[g].name].title,b.push(d[g]));ReportData.options.isCombined&&b.unshift({name:"date_field",title:translated_labels.label_date,showAggregates:{},sortAction:"group",sortDirection:"DESC",aggregate:"",position:"",dateGrouping:""}),c=_.uniq(c,function(a){return a.name}),b=_.uniq(b,function(a){return a.name}),a.set("availableAxis",c),a.set("availableGroups",b),a.set("availableLegends",b)};this.observe("groups",b),this.observe("aggregates",b),this.observe("xAxis",validateXAxis),this.observe("yAxis",function(a){ReportData.chartAxisY=a}),this.observe("y2Axis",function(a){ReportData.chartAxisY2=a}),this.observe("chartSize",function(a){ReportData.chartSize=a}),this.observe("showPercents",function(a){ReportData.chartShowPercents=a})},data:{xAxis:ReportData.chartAxisX,yAxis:ReportData.chartAxisY,y2Axis:ReportData.chartAxisY2,chartTitle:ReportData.chartTitle,showPercents:ReportData.chartShowPercents,labelName:ReportData.chartLabels,groups:[],aggregates:[],chartSizes:ReportData.chartSizes,chartSize:ReportData.chartSize,availableAxis:[],availableGroups:[],availableLegends:[]},components:{chartButtons:chartButtons,selectBox:selectBox}}),LineChartComponent=BaseChartComponent.extend({template:App._template("chartViewTemplate"),axisKeys:[],init:function(){this.parentInit();var a=this,b=a.get("data"),c=a.get("title"),d=a.get("svg"),e=this.get("xAxis"),f=a.get("isWidget"),g={top:50,right:50,bottom:120,left:100};ReportData.chartMargin&&(g=ReportData.chartMargin),nv.addGraph(function(){var h=nv.models.lineChart().options({reduceXTicks:!1}).margin(g).useInteractiveGuideline(!0).transitionDuration(350).showLegend(!0).color(d3.scale.category10().range());e=jQuery.grep(ReportData.fieldGroupingSorting,function(a){return a.name==e}),e=ReportData.options.isCombined&&"date_field"==a.get("xAxis")?"Date":e[0].title,h.xAxis.axisLabel(e).tickFormat(function(b){return"undefined"!=typeof a.axisKeys[b]?a.axisKeys[b]:""}),h.xAxis.rotateLabels(-30),a.bigValues&&h.yAxis.tickFormat(d3.format(".0f")),f||h.legend.margin({top:20,bottom:30}),h.forceY(0);var i=a.normalise(b);return d3.select(d).datum(i).call(h),f||d3.select(d).append("text").attr("x",100).attr("y",10).style({"text-anchor":"left","font-weight":"bold"}).text(c),nv.utils.windowResize(h.update),a.chart=h,h})},normalise:function(a){var b=ReportData.chartLegend,c=this.get("xAxis"),d=this.get("yAxis"),e=this.get("aggregates");c=reportUtils.appendDateGrouping(a,c);for(var f=!1,g=0;g<b.length;g++){var h=ReportLineChart.getAggregate(b[g],e);if(h){f=!0;break}}return f?this.parseAggregates(a,c,d,b):(b=reportUtils.appendDateGrouping(a,b),this.parseGroups(a,c,d,b))},parseAggregates:function(a,b,c,d){for(var e=[],f=[],g=0;g<d.length;g++)e.push(d[g]);for(var h=0;h<a.data.length;h++)a.data[h][b]||(a.data[h][b]="-"),f.push(a.data[h][b]);e=unique(e),f=unique(f),this.axisKeys=f;for(var i=[],h=0;h<e.length;h++){i[h]={key:e[h],values:[]};for(var g=0;g<f.length;g++)i[h].values[g]={x:g,y:0}}for(var h=0;h<a.data.length;h++)for(var j=f.indexOf(a.data[h][b]),g=0;g<d.length;g++)for(var k=0;k<i.length;k++)i[k].key==d[g]&&(a.data[h][d[g]]||(a.data[h][d[g]]=0),parseFloat(a.data[h][d[g]])>100&&(this.bigValues=!0),i[k].values[j].y=parseFloat(a.data[h][d[g]]));for(var h=0;h<i.length;h++)i[h].key=a.cols[i[h].key];return i},parseGroups:function(a,b,c,d){for(var e=[],f=[],g=0;g<a.data.length;g++){for(var h=0;h<d.length;h++)a.data[g][d[h]]||(a.data[g][d[h]]="-"),e.push(a.data[g][d[h]]);a.data[g][b]||(a.data[g][b]="-"),f.push(a.data[g][b])}e=unique(e),f=unique(f),this.axisKeys=f;for(var i=[],g=0;g<e.length;g++){i[g]={key:e[g],values:[]};for(var h=0;h<f.length;h++)i[g].values[h]={x:h,y:0}}for(var g=0;g<a.data.length;g++)for(var j=!1,k=f.indexOf(a.data[g][b]),h=0;h<d.length;h++)j=e.indexOf(a.data[g][d[h]]),a.data[g][c]||(a.data[g][c]=0),i[j].values[k].y=parseFloat(a.data[g][c]);return i},data:{data:[],title:"",xAxis:"",yAxis:""}}),ReportLineChart={getAggregate:function(a,b){for(var c=!1,d=0;d<b.length;d++)if(b[d].value.sum&&b[d].selectedField+"_sum"==a&&(c=!0),b[d].value.avg&&b[d].selectedField+"_avg"==a&&(c=!0),b[d].value.count&&b[d].selectedField+"_cnt"==a&&(c=!0),c)return b[d]},getGroup:function(a,b){for(var c=0;c<b.length;c++)if(b[c].name==a)return b[c]},parseDataItems:function(a,b,c,d,e){for(var f=0;f<a.length;f++){if("string"==typeof a[f]){var g=this.getAggregate(a[f],b),h=this.getGroup(a[f],c);g&&e.push(g),h&&d.push(h)}"object"==typeof a[f]&&this.parseDataItems(a[f],b,c,d,e)}},prepareData:function(a,b,c,d,e){var f=ReportData.chartAxisX,g=ReportData.chartAxisY,h=ReportData.chartLegend,i=[],j=[],k=[];if(k.push(f),k.push(g),k.push(h),this.parseDataItems(k,d,e,j,i),ReportData.options.isCombined){var l=a.get("combinedSelectedFields.fields");for(moduleId in l)for(var m=l[moduleId],n=0;n<ReportData.availableFields.length;n++)for(var o=0;o<ReportData.availableFields[n].fields.length;o++)if(m==ReportData.availableFields[n].fields[o].name){var p=jQuery.extend(!0,{},ReportData.availableFields[n].fields[o]);p={name:m},p.sortAction=ReportData.combinedSelectedFields.sortAction,p.dateGrouping=ReportData.combinedSelectedFields.dateGrouping,p.sortDirection=ReportData.combinedSelectedFields.sortDirection,p.position=ReportData.combinedSelectedFields.position,j.unshift(p)}}for(var q=[],n=0;n<i.length;n++)q.indexOf(i[n].selectedField)>-1?(i.splice(n,1),n--):q.push(i[n].selectedField);var r={filters:JSON.stringify(b),columns:JSON.stringify(c),options:JSON.stringify(ReportData.chartOptions),labels:JSON.stringify(ReportData.labels),aggregates:JSON.stringify(i),grouping:JSON.stringify(j),calcFields:JSON.stringify(ReportData.calcFields)};return r},init:function(a,b,c,d,e){var f=this.prepareData(a,b,c,d,e);loadChart("line",f,d,e)}},LineChartLegendManager=Ractive.extend({template:App._template("lineChartLegendTemplate"),init:function(){var a=this,b=function(){for(var b=[],c=[],d=a.get("groups"),e=a.get("aggregates"),f=a.get("fieldsByName"),g=0;g<e.length;g++){var h=f[e[g].selectedField].title,i=e[g].selectedField;e[g].value.sum&&c.push({name:i+"_sum",title:h+" "+translated_labels.label_sum}),e[g].value.count&&c.push({name:i+"_cnt",title:h+" "+translated_labels.label_count}),e[g].value.avg&&c.push({name:i+"_avg",title:h+" "+translated_labels.label_average})}for(var g=0;g<d.length;g++)"group"!=d[g].sortAction&&"groupsort"!=d[g].sortAction||(d[g].title=f[d[g].name].title,b.push(d[g]));c=_.uniq(c,function(a){return a.name}),b=_.uniq(b,function(a){return a.name});var j=[{key:translated_labels.label_groups,values:b},{key:translated_labels.label_aggregates,values:c}];c=[{key:translated_labels.label_aggregates,values:c}],a.set("availableAxis",c),ReportData.options.isCombined&&b.unshift({name:"date_field",title:translated_labels.label_date,showAggregates:{},sortAction:"group",sortDirection:"DESC",aggregate:"",position:"",dateGrouping:""}),a.set("availableGroups",b),a.set("availableLegends",j)};this.observe("groups",b,{init:!1}),this.observe("aggregates",b,{init:!1}),b(),this.observe("xAxis",validateXAxis,{init:!1}),this.observe("yAxis",function(b){1==b.length?a.set("legend",[this.get("xAxis")]):a.set("legend",b),ReportData.chartAxisY=b},{init:!1}),this.observe("xAxis",function(b){1==a.get("yAxis").length&&a.set("legend",[this.get("xAxis")])},{init:!1}),0==this.get("legend").length&&this.set("legend",[this.get("xAxis")]),this.observe("y2Axis",function(a){ReportData.chartAxisY2=a},{init:!1}),this.observe("legend",function(b){ReportData.chartLegend=b;for(var c=a.get("aggregates"),d=!1,e=0;e<b.length;e++)if(ReportLineChart.getAggregate(b[e],c)){d=!0;break}if(d){a.get("yAxis");a.merge("yAxis",b)}},{init:!1}),this.observe("chartSize",function(a){ReportData.chartSize=a})},data:{xAxis:ReportData.chartAxisX,yAxis:ReportData.chartAxisY,y2Axis:ReportData.chartAxisY2,chartTitle:ReportData.chartTitle,legend:ReportData.chartLegend,availableLegends:[],labelName:ReportData.chartLabels,groups:[],aggregates:[],availableAxis:[],availableGroups:[],chartSizes:ReportData.chartSizes,chartSize:ReportData.chartSize},components:{chartButtons:chartButtons,selectBox:selectBox,multiSelectBox:multiSelectBox}});CombinedChartComponent=BaseChartComponent.extend({template:App._template("chartViewTemplate"),init:function(){this.parentInit();var a=this,b=a.get("data"),c=a.get("title"),d=a.get("svg"),e=a.get("isWidget"),f={top:50,right:50,bottom:120,left:70};ReportData.chartMargin&&(f=ReportData.chartMargin);var g=a.get("bars1Stacked"),h=a.get("bars2Stacked");nv.addGraph(function(){var i=nv.models.multiChart().options({reduceXTicks:!1}).margin(f).color(d3.scale.category10().range()).bars1stacked(g).bars2stacked(h);i.xAxis.tickFormat(function(b){return"undefined"!=typeof a.axisKeys[b]?a.axisKeys[b]:""}),i.xAxis.rotateLabels(-30),a.bigValues&&(i.yAxis1.tickFormat(d3.format(".0f")),i.yAxis2.tickFormat(d3.format(".0f")));for(var j=a.normalise(b),k=0,l=0,m=0,n=0,o=0;o<j.length;o++)for(var p=j[o].yAxis,q=j[o].values,r=0;r<q.length;r++)1==p&&q[r].y>m&&(m=q[r].y),2==p&&q[r].y>n&&(n=q[r].y);return i.yDomain1([k,m]),i.yDomain2([l,n]),d3.select(d).datum(j).call(i),e||d3.select(d).append("text").attr("x",100).attr("y",10).style({"text-anchor":"left","font-weight":"bold"}).text(c),nv.utils.windowResize(i.update),a.chart=i,i})},normalise:function(a){var b=this.get("legend"),c=this.get("xAxis"),d=this.get("yAxis"),e=this.get("yAxis2"),f=(this.get("aggregates"),this.get("yAxisType")),g=this.get("yAxis2Type");c=reportUtils.appendDateGrouping(a,c);for(var h=[],i=[],j=0;j<b.length;j++)h.push(b[j]);for(var k=0;k<a.data.length;k++)a.data[k][c]||(a.data[k][c]="-"),i.push(a.data[k][c]);h=unique(h),i=unique(i),this.axisKeys=i,"string"==typeof d&&(d=[d],this.set("yAxis",d)),"string"==typeof e&&(e=[e],this.set("yAxis2",e)),!f&&d.length>0&&(f="line",this.set("yAxisType",f)),!g&&e.length>0&&(g="line",this.set("yAxis2Type",g));var l=[];l.push({keys:d,type:f,position:1}),l.push({keys:e,type:g,position:2});for(var m=[],n=0,k=0;k<l.length;k++)for(var o=l[k].type,p=l[k].position,j=0;j<l[k].keys.length;j++){var q=l[k].keys[j];m[n]={key:q,type:o,yAxis:p,values:[]};for(var r=0;r<i.length;r++)m[n].values[r]={x:r,y:0};n++}for(var k=0;k<a.data.length;k++)for(var s=i.indexOf(a.data[k][c]),j=0;j<b.length;j++)for(var r=0;r<m.length;r++)if(m[r].key==b[j]){var t=parseFloat(a.data[k][b[j]]);t||(t=0),t>100&&(this.bigValues=!0),m[r].values[s].y=t}for(var k=0;k<m.length;k++)m[k].key=a.cols[m[k].key];return m},data:{data:[],title:"",xAxis:"",yAxis:[],yAxis2:[],yAxisType:"",yAxis2Type:"",bars1Stacked:!1,bars2Stacked:!1,legend:[]}});var ReportCombinedChart={getAggregate:function(a,b){for(var c=!1,d=0;d<b.length;d++)if(b[d].value.sum&&b[d].selectedField+"_sum"==a&&(c=!0),b[d].value.avg&&b[d].selectedField+"_avg"==a&&(c=!0),b[d].value.count&&b[d].selectedField+"_cnt"==a&&(c=!0),c)return b[d]},getGroup:function(a,b){for(var c=0;c<b.length;c++)if(b[c].name==a)return b[c]},parseDataItems:function(a,b,c,d,e){for(var f=0;f<a.length;f++){if("string"==typeof a[f]){var g=this.getAggregate(a[f],b),h=this.getGroup(a[f],c);g&&e.push(g),h&&d.push(h)}"object"==typeof a[f]&&this.parseDataItems(a[f],b,c,d,e)}},prepareData:function(a,b,c,d,e){var f=ReportData.chartAxisX,g=ReportData.chartAxisY,h=ReportData.chartAxisY2,i=(ReportData.chartYAxisType,ReportData.chartYAxis2Type,ReportData.chartLegend),j=[],k=[],l=[];if(l.push(f),l.push(g),l.push(h),l.push(i),this.parseDataItems(l,d,e,k,j),ReportData.options.isCombined){var m=a.get("combinedSelectedFields.fields");for(moduleId in m)for(var n=m[moduleId],o=0;o<ReportData.availableFields.length;o++)for(var p=0;p<ReportData.availableFields[o].fields.length;p++)if(n==ReportData.availableFields[o].fields[p].name){var q=jQuery.extend(!0,{},ReportData.availableFields[o].fields[p]);q={name:n},q.sortAction="date_field"==ReportData.chartAxisX?"nogroup"!==ReportData.combinedSelectedFields.sortAction?ReportData.combinedSelectedFields.sortAction:"group":"nogroup",q.dateGrouping=ReportData.combinedSelectedFields.dateGrouping,q.sortDirection=ReportData.combinedSelectedFields.sortDirection,q.position=ReportData.combinedSelectedFields.position,k.unshift(q)}}for(var r=[],o=0;o<j.length;o++)r.indexOf(j[o].selectedField)>-1?(j.splice(o,1),o--):r.push(j[o].selectedField);var s={filters:JSON.stringify(b),columns:JSON.stringify(c),options:JSON.stringify(ReportData.chartOptions),labels:JSON.stringify(ReportData.labels),aggregates:JSON.stringify(j),grouping:JSON.stringify(k),calcFields:JSON.stringify(ReportData.calcFields)};return s},init:function(a,b,c,d,e){var f=this.prepareData(a,b,c,d,e);loadChart("combined",f,d,e)}},CombinedChartLegendManager=Ractive.extend({template:App._template("combinedChartLegendTemplate"),init:function(){var a=this;this.get("yAxis")instanceof String&&this.set("yAxis",[this.get("yAxis")]),this.get("yAxis2")instanceof String&&this.set("yAxis2",[this.get("yAxis2")]),this.get("legend")instanceof String&&this.set("legend",[this.get("legend")]);var b=function(){for(var b=[],c=[],d=[],e=[],f=[],g=a.get("groups"),h=a.get("aggregates"),i=a.get("legend"),j=a.get("fieldsByName"),k=0;k<i.length;k++)for(var l=0;l<g.length;l++)g[l].name==i[k]&&i.splice(k,1);for(var m=a.get("yAxis"),n=a.get("yAxis2"),o=m.length-1,p=n.length-1,k=0;k<h.length;k++){var q,r=j[h[k].selectedField].title,s=h[k].selectedField;if(h[k].value.sum){c.push({name:s+"_sum",title:r+" "+translated_labels.label_sum}),q=!0;for(var t=o;t>=0;t--)m[t]==s+"_sum"&&(q=!1);q&&e.push({name:s+"_sum",title:r+" "+translated_labels.label_sum}),q=!0;for(var t=p;t>=0;t--)n[t]==s+"_sum"&&(q=!1);q&&d.push({name:s+"_sum",title:r+" "+translated_labels.label_sum}),f.push({name:s+"_sum",title:r+" "+translated_labels.label_sum})}if(h[k].value.count){c.push({name:s+"_cnt",title:r+" "+translated_labels.label_count}),q=!0;for(var t=o;t>=0;t--)m[t]==s+"_cnt"&&(q=!1);q&&e.push({name:s+"_cnt",title:r+" "+translated_labels.label_count}),q=!0;for(var t=p;t>=0;t--)n[t]==s+"_cnt"&&(q=!1);q&&d.push({name:s+"_cnt",title:r+" "+translated_labels.label_count}),f.push({name:s+"_cnt",title:r+" "+translated_labels.label_count})}if(h[k].value.avg){c.push({name:s+"_avg",title:r+" "+translated_labels.label_average}),q=!0;for(var t=o;t>=0;t--)m[t]==s+"_avg"&&(q=!1);q&&e.push({name:s+"_avg",title:r+" "+translated_labels.label_average}),q=!0;for(var t=p;t>=0;t--)n[t]==s+"_avg"&&(q=!1);q&&d.push({name:s+"_avg",title:r+" "+translated_labels.label_average}),f.push({name:s+"_avg",title:r+" "+translated_labels.label_average})}}for(var k=0;k<g.length;k++)"group"!=g[k].sortAction&&"groupsort"!=g[k].sortAction&&"nogroup"!=g[k].sortAction||(g[k].title=j[g[k].name].title,b.push(g[k]));c=_.uniq(c,function(a){return a.name}),d=_.uniq(d,function(a){return a.name}),e=_.uniq(e,function(a){return a.name}),b=_.uniq(b,function(a){return a.name}),u=f.length>0?f:c;var u=[{key:translated_labels.label_aggregates,values:u}],c=[{key:translated_labels.label_aggregates,values:c}],d=[{key:translated_labels.label_aggregates,values:d}],e=[{key:translated_labels.label_aggregates,values:e}],v=[{name:"line",title:translated_labels.label_line},{name:"bar",title:translated_labels.label_column}];a.set("availableAxis",c),a.set("availableAxis1",c),a.set("availableAxis2",c),ReportData.options.isCombined&&b.unshift({name:"date_field",title:translated_labels.label_date,showAggregates:{},sortAction:"group",sortDirection:"DESC",aggregate:"",position:"",dateGrouping:""}),a.set("availableGroups",b),a.set("availableLegends",u),a.set("availableTypes",v)};this.observe("groups",b,{init:!1}),this.observe("aggregates",b,{init:!1}),b(),this.observe("xAxis",validateXAxis),this.observe("yAxis",function(b){for(var c=a.get("yAxis2"),d=[],e=c.length-1,f=e;f>=0;f--)jQuery.inArray(c[f],b)==-1&&d.push(c[f]);a.set("legend",a.get("yAxis").concat(a.get("yAxis2"))),ReportData.chartAxisY=b},{init:!1}),this.observe("yAxis2",function(b){for(var c=a.get("yAxis"),d=[],e=c.length-1,f=e;f>=0;f--)jQuery.inArray(c[f],b)==-1&&d.push(c[f]);a.set("legend",a.get("yAxis").concat(a.get("yAxis2"))),ReportData.chartAxisY2=b},{init:!1}),this.observe("bars1Stacked",function(a){ReportData.chartBars1Stacked=a},{init:!1}),this.observe("bars2Stacked",function(a){ReportData.chartBars2Stacked=a},{init:!1}),this.observe("yAxisType",function(b){ReportData.chartYAxisType=b,"bar"!==b&&a.set("bars1Stacked",!1)},{init:!1}),this.observe("yAxis2Type",function(b){ReportData.chartYAxis2Type=b,"bar"!==b&&a.set("bars2Stacked",!1)},{init:!1}),this.observe("legend",function(a){ReportData.chartLegend=a},{init:!1}),this.observe("chartSize",function(a){ReportData.chartSize=a})},data:{xAxis:ReportData.chartAxisX,yAxis:ReportData.chartAxisY,yAxis2:ReportData.chartAxisY2,chartTitle:ReportData.chartTitle,yAxisType:ReportData.chartYAxisType,yAxis2Type:ReportData.chartYAxis2Type,bars1Stacked:ReportData.chartBars1Stacked,bars2Stacked:ReportData.chartBars2Stacked,legend:ReportData.chartLegend,availableLegends:[],availableTypes:[],labelName:ReportData.chartLabels,groups:[],aggregates:[],availableAxis:[],availableGroups:[],chartSizes:ReportData.chartSizes,chartSize:ReportData.chartSize,availableAxis1:[],availableAxis2:[]},components:{chartButtons:chartButtons,selectBox:selectBox,multiSelectBox:multiSelectBox}}),FunnelChartComponent=BaseChartComponent.extend({template:App._template("chartViewTemplate"),init:function(){function a(){jQuery(e).empty();var g=new D3Funnel(e);return g.update=function(){a()},g.draw(b.normalise(c),h),f||d3.select(e).append("text").attr("x",100).attr("y",10).style({"text-anchor":"left","font-weight":"bold"}).text(d),b.chart=g,g}this.parentInit();var b=this,c=b.get("data"),d=b.get("title"),e=b.get("svg"),f=b.get("isWidget"),g=(b.get("showPercents"),{top:10,right:10,bottom:10,left:10});ReportData.chartMargin&&(g=ReportData.chartMargin);var h={hoverEffects:!0,fillType:"gradient",dynamicArea:!0};f||(h.margin={left:100,right:0,top:30,bottom:0}),a()},getTotal:function(a,b){for(var c=0,d=0;d<a.length;d++)a[d][b]&&(c+=parseFloat(a[d][b]));return c},getPercents:function(a,b){var c=0;return a>0&&b>0&&(c=b/a*100),c},normalise:function(a){for(var b=this.get("xAxis"),c=this.get("yAxis"),d=this.get("cumulated"),e=this.get("groups"),f=(this.get("showPercents"),0);f<e.length;f++)e[f].name==b&&e[f].dateGrouping&&(b=b+"_"+e[f].dateGrouping);return d?this.normaliseCumulated(a,b,c):this.normaliseNonCumulated(a,b,c)},normaliseCumulated:function(a,b,c,d){var e=this,f=this.get("sortableValues"),g=[],h=[],i=e.getTotal(a.data,c),j=e.get("showPercents");if(_.each(a.data,function(a){var d={key:a[b],val:parseFloat(a[c])};g.push(d)}),0==f.length&&(g=g.sort(function(a,b){return a.val-b.val}),g=this.cumulateValues(g),g=g.sort(function(a,b){return b.val-a.val})),f.length>0){for(var k=[],l=0;l<f.length;l++)for(var m=f[l].value,n=0;n<g.length;n++)m==g[n].key&&k.push(g[n]);g=this.cumulateValues(k)}for(var l=0;l<g.length;l++){var o=g[l].key,p=g[l].val;j&&(o+=" ("+e.getPercents(i,p).toFixed(2)+"%)");var q=[o,p.toFixed(2)];h.push(q)}return h},cumulateValues:function(a){for(var b=0,c=!1,a=a.reverse(),d=0;d<a.length;d++){if(a[d].val>0)c=!0;else if(!c){a.splice(d,1);continue}c&&(a[d].val=a[d].val+b,b=a[d].val)}var e=a.reverse();return e},normaliseNonCumulated:function(a,b,c){var d=this,e=[],f=[],g=d.getTotal(a.data,c),h=d.get("showPercents");_.each(a.data,function(a){var f=a[b],i=parseFloat(a[c]);h&&(f+=" ("+d.getPercents(g,i).toFixed(2)+"%)");var j={key:f,val:i};e.push(j)}),e=e.sort(function(a,b){return b.val-a.val});for(var e=e.reverse(),i=!1,j=0;j<e.length;j++){if(e[j].val>0)i=!0;else if(!i){e.splice(j,1);continue}var k=[e[j].key,e[j].val.toFixed(2)];f.push(k)}return f.reverse()},data:{cumulated:!0,sortableValues:[],data:[],title:"",xAxis:"",yAxis:"",showPercents:!1}}),ReportFunnelChart={prepareData:function(a,b,c,d,e){var f=ReportData.chartAxisX,g=ReportData.chartAxisY,h=[];_.each(d,function(a){a.selectedField+"_sum"!=g&&a.selectedField+"_avg"!=g&&a.selectedField+"_cnt"!=g&&a.selectedField!=g||h.push(a)});var i=[];if(_.each(e,function(a){a.name==f&&i.push(a)}),ReportData.options.isCombined){var j=a.get("combinedSelectedFields.fields");for(moduleId in j)for(var k=j[moduleId],l=0;l<ReportData.availableFields.length;l++)for(var m=0;m<ReportData.availableFields[l].fields.length;m++)if(k==ReportData.availableFields[l].fields[m].name){var n=jQuery.extend(!0,{},ReportData.availableFields[l].fields[m]);n={name:k},n.sortAction="date_field"==ReportData.chartAxisX?"nogroup"!==ReportData.combinedSelectedFields.sortAction?ReportData.combinedSelectedFields.sortAction:"group":"nogroup",n.dateGrouping=ReportData.combinedSelectedFields.dateGrouping,n.sortDirection=ReportData.combinedSelectedFields.sortDirection,n.position=ReportData.combinedSelectedFields.position,i.unshift(n)}}var o={filters:JSON.stringify(b),columns:JSON.stringify(c),options:JSON.stringify(ReportData.chartOptions),labels:JSON.stringify(ReportData.labels),aggregates:JSON.stringify(h),grouping:JSON.stringify(i),calcFields:JSON.stringify(ReportData.calcFields)};return o},init:function(a,b,c,d,e){var f=this.prepareData(a,b,c,d,e);loadChart("funnel",f,d,e)}},FunnelChartLegendManager=Ractive.extend({template:App._template("funnelChartLegendTemplate"),init:function(){var a=this,b=function(){for(var b=[],c=[],d=a.get("groups"),e=a.get("aggregates"),f=a.get("fieldsByName"),g=0;g<e.length;g++){var h=f[e[g].selectedField].title,i=e[g].selectedField;e[g].value.sum&&c.push({name:i+"_sum",title:h+" "+translated_labels.label_sum}),e[g].value.count&&c.push({name:i+"_cnt",title:h+" "+translated_labels.label_count}),e[g].value.avg&&c.push({name:i+"_avg",title:h+" "+translated_labels.label_average})}for(var g=0;g<d.length;g++)"group"!=d[g].sortAction&&"groupsort"!=d[g].sortAction&&"nogroup"!=d[g].sortAction||(d[g].title=f[d[g].name].title,b.push(d[g]));ReportData.options.isCombined&&b.unshift({name:"date_field",title:translated_labels.label_date,showAggregates:{},sortAction:"group",sortDirection:"DESC",aggregate:"",position:"",dateGrouping:""}),c=_.uniq(c,function(a){return a.name}),b=_.uniq(b,function(a){return a.name}),a.set("availableAxis",c),a.set("availableGroups",b),a.set("availableLegends",b)};this.observe("groups",b),this.observe("aggregates",b),this.observe("xAxis",validateXAxis),this.observe("xAxis",function(){a.loadSortingValues(ReportData.chartAxisX)}),this.observe("yAxis",function(a){ReportData.chartAxisY=a}),this.observe("y2Axis",function(a){ReportData.chartAxisY2=a}),this.observe("chartSize",function(a){ReportData.chartSize=a}),this.observe("showPercents",function(a){ReportData.chartShowPercents=a}),this.observe("sortableValues",function(a){ReportData.chartSortableValues=a}),this.observe("cumulated",function(a){ReportData.chartCumulated=a})},loadSortingValues:function(a){var b=this,c={fieldName:a};jQuery.post(ReportData.urlLoadPicklists,c,function(a){var c;try{c=JSON.parse(a)}catch(a){console.log("Error loading sorting values: "+a)}var d=[];c.length>0&&(d=b.mergeSortingValues(c)),b.set("sortableValues",d)})},mergeSortingValues:function(a){var b=this,c=[],d=b.get("sortableValues");d||(d=[]);for(var e=0;e<d.length;e++){for(var f=!1,g=0;g<a.length;g++)if(d[e].key==a[g].key){f=!0;break}f&&c.push(d[e])}for(var e=0;e<a.length;e++){for(var f=!1,g=0;g<c.length;g++)if(a[e].key==c[g].key){f=!0;break}f||c.push(a[e])}return c},data:{xAxis:ReportData.chartAxisX,yAxis:ReportData.chartAxisY,y2Axis:ReportData.chartAxisY2,chartTitle:ReportData.chartTitle,cumulated:ReportData.chartCumulated,sortableValues:ReportData.chartSortableValues,showPercents:ReportData.chartShowPercents,labelName:ReportData.chartLabels,groups:[],aggregates:[],chartSizes:ReportData.chartSizes,chartSize:ReportData.chartSize,availableAxis:[],availableGroups:[],availableLegends:[]},components:{chartButtons:chartButtons,selectBox:selectBox}}),GaugeChartComponent=BaseChartComponent.extend({template:App._template("chartViewTemplate"),init:function(){function a(){var g=jQuery(b.get("svg")).height();i.margin&&(g=g-i.margin.top-i.margin.bottom),i.size=g,jQuery(e).empty();var h=new D3Gauge(e,i);return h.update=function(){a()},h.write(b.normalise(c)),f||d3.select(e).append("text").attr("x",100).attr("y",10).style({"text-anchor":"left","font-weight":"bold"}).text(d),b.chart=h,h}this.parentInit();var b=this,c=b.get("data"),d=b.get("title"),e=b.get("svg"),f=b.get("isWidget"),g=b.get("valueZones"),h=(b.get("showLabels"),b.get("showZoneLabels"),{top:10,right:10,bottom:10,left:10});ReportData.chartMargin&&(h=ReportData.chartMargin);var i={min:b.getValueZonesMin(),max:b.getValueZonesMax(),transitionDuration:900,label:"",minorTicks:5,majorTicks:10,needleWidthRatio:.6,needleContainerRadiusRatio:.7,clazz:"small",zones:g,showLabels:ReportData.chartShowLabels,showZoneLabels:ReportData.chartShowZoneLabels};f||(i.margin={left:100,right:0,top:30,bottom:0}),a()},getValueZonesMin:function(){for(var a=this.get("valueZones"),b=0,c=0;c<a.length;c++)a[c].from<b&&(b=parseFloat(a[c].from));return b},getValueZonesMax:function(){for(var a=this.get("data"),b=this.get("valueZones"),c=0,d=0;d<b.length;d++)b[d].to>c&&(c=parseFloat(b[d].to));var e=this.normalise(a);return e>c?e:c},normalise:function(a){var b=this.get("xAxis"),c=this.get("xAxisSegment"),d=this.get("yAxis");b=reportUtils.appendDateGrouping(a,b);var e=0;return _.each(a.data,function(a){if(c){if(a[b]&&a[b]==c){var f=parseFloat(a[d]);f&&(e+=f)}}else{var f=parseFloat(a[d]);f&&(e+=f)}}),e||(e=0),e},data:{data:[],title:"",xAxis:"",yAxis:"",showPercents:!1,valueZones:[],xAxisSegment:!1,showLabels:ReportData.chartShowLabels,showZoneLabels:ReportData.chartShowZoneLabels}}),ReportGaugeChart={prepareData:function(a,b,c,d,e){
var f=ReportData.chartAxisX,g=ReportData.chartAxisY,h=[];_.each(d,function(a){a.selectedField+"_sum"!=g&&a.selectedField+"_avg"!=g&&a.selectedField+"_cnt"!=g&&a.selectedField!=g||h.push(a)});var i=[];if(_.each(e,function(a){a.name==f&&i.push(a)}),ReportData.options.isCombined){var j=a.get("combinedSelectedFields.fields");for(moduleId in j)for(var k=j[moduleId],l=0;l<ReportData.availableFields.length;l++)for(var m=0;m<ReportData.availableFields[l].fields.length;m++)if(k==ReportData.availableFields[l].fields[m].name){var n=jQuery.extend(!0,{},ReportData.availableFields[l].fields[m]);n={name:k},n.sortAction="date_field"==ReportData.chartAxisX?"nogroup"!==ReportData.combinedSelectedFields.sortAction?ReportData.combinedSelectedFields.sortAction:"group":"nogroup",n.dateGrouping=ReportData.combinedSelectedFields.dateGrouping,n.sortDirection=ReportData.combinedSelectedFields.sortDirection,n.position=ReportData.combinedSelectedFields.position,i.unshift(n)}}var o={filters:b,columns:c,options:ReportData.chartOptions,labels:ReportData.labels,aggregates:d,grouping:i,calcFields:ReportData.calcFields};return ReportData.options.isCombined&&(o.combinedSelectedFields=a.get("combinedSelectedFields.fields")),o=reportUtils.convertToJSONPost(o)},init:function(a,b,c,d,e){var f=this.prepareData(a,b,c,d,e);loadChart("gauge",f,d,e)}},GaugeChartLegendManager=Ractive.extend({template:App._template("gaugeChartLegendTemplate"),init:function(){var a=this,b=a.get("valueZones");b&&0!=b.length||a.addValueZone();var c=function(){for(var b=[],c=[],d=a.get("groups"),e=a.get("aggregates"),f=a.get("fieldsByName"),g=0;g<e.length;g++){var h=f[e[g].selectedField].title,i=e[g].selectedField;e[g].value.sum&&c.push({name:i+"_sum",title:h+" "+translated_labels.label_sum}),e[g].value.count&&c.push({name:i+"_cnt",title:h+" "+translated_labels.label_count}),e[g].value.avg&&c.push({name:i+"_avg",title:h+" "+translated_labels.label_average})}for(var g=0;g<d.length;g++)"group"!=d[g].sortAction&&"groupsort"!=d[g].sortAction&&"nogroup"!=d[g].sortAction||(d[g].title=f[d[g].name].title,b.push(d[g]));ReportData.options.isCombined&&b.unshift({name:"date_field",title:translated_labels.label_date,showAggregates:{},sortAction:"group",sortDirection:"DESC",aggregate:"",position:"",dateGrouping:""}),c=_.uniq(c,function(a){return a.name}),b=_.uniq(b,function(a){return a.name}),a.set("availableAxis",c),a.set("availableGroups",b),a.set("availableLegends",b)};this.on("addValueZone",function(b){b.original.preventDefault(),a.addValueZone()}),this.on("removeValueZone",function(b,c){b.original.preventDefault(),a.removeValueZone(c)}),this.observe("groups",c),this.observe("aggregates",c),this.observe("yAxis",function(a){ReportData.chartAxisY=a}),this.observe("xAxis",function(b){ReportData.chartAxisX=b,a.loadGroupingSegments(ReportData.chartAxisX)}),this.observe("xAxisSegment",function(a){ReportData.chartAxisXSegment=a}),this.observe("valueZones",function(a){ReportData.chartValueZones=a}),this.observe("showLabels",function(a){ReportData.chartShowLabels=a}),this.observe("showZoneLabels",function(a){ReportData.chartShowZoneLabels=a})},loadGroupingSegments:function(a){"date"==a&&(a="date_field");var b=this,c=ReportData.url+ReportData.id+"&distinct="+a,d=b.getReportMainDataPreview();d=reportUtils.convertToJSONPost(d),jQuery.post(c,d,function(a){var c;try{c=JSON.parse(a)}catch(a){console.log("Error loading grouping segments: "+a)}var d=[];d.push({name:"",title:translated_labels.label_all}),c.length>0&&(d=jQuery.merge(d,c)),b.set("availableGroupSegments",d)})},addValueZone:function(){var a=this.get("valueZones");a||(a=[]);var b={clazz:"green-zone",from:0,to:100};a.push(b),this.set("valueZones",a)},removeValueZone:function(a){var b=this.get("valueZones");b.splice(a,1),this.set("valueZones",b)},data:{xAxis:!1,yAxis:!1,y2Axis:!1,chartTitle:"",showPercents:!1,showLabels:ReportData.chartShowLabels,showZoneLabels:ReportData.chartShowZoneLabels,labelName:"",groups:[],aggregates:[],chartSizes:[],chartSize:!1,availableAxis:[],availableGroups:[],availableLegends:[],valueZones:[],availableValueZones:[{title:translated_labels.label_color_light_blue,name:"light-blue-zone"},{title:translated_labels.label_color_blue,name:"blue-zone"},{title:translated_labels.label_color_light_green,name:"light-green-zone"},{title:translated_labels.label_color_green,name:"green-zone"},{title:translated_labels.label_color_yellow,name:"yellow-zone"},{title:translated_labels.label_color_orange,name:"orange-zone"},{title:translated_labels.label_color_brown,name:"brown-zone"},{title:translated_labels.label_color_gray,name:"gray-zone"},{title:translated_labels.label_color_red,name:"red-zone"},{title:translated_labels.label_color_pink,name:"pink-zone"},{title:translated_labels.label_color_violet,name:"violet-zone"}],xAxisSegment:!1},components:{chartButtons:chartButtons,selectBox:selectBox}});